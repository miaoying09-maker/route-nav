<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å•ç‚¹å¯¼èˆªï¼ˆå‡çº§ç‰ˆï¼‰</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;margin:0;padding:12px;background:#f5f5f5}
  h3{margin:6px 0 10px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  textarea{width:100%;height:170px;border-radius:10px;border:1px solid #ddd;padding:10px;font-size:14px;box-sizing:border-box}
  input{width:100%;border-radius:10px;border:1px solid #ddd;padding:10px;font-size:14px;box-sizing:border-box}
  button{border:0;border-radius:10px;padding:10px 14px;font-size:16px}
  .primary{background:#1a73e8;color:#fff}
  .ghost{background:#fff;border:1px solid #ddd}
  .small{font-size:12px;color:#666;margin:8px 0}
  .stats{display:flex;gap:12px;flex-wrap:wrap}
  .pill{background:#fff;border:1px solid #e5e5e5;border-radius:999px;padding:6px 10px;font-size:13px}
  .card{
    background:#fff;border-radius:12px;padding:12px;margin-top:10px;
    display:flex;justify-content:space-between;align-items:center;gap:10px
  }
  .left{flex:1;min-width:0}
  .addr{font-size:14px;color:#333;word-break:break-word}
  .route{font-weight:800;color:#d60000;margin-right:6px}
  .actions{display:flex;gap:8px;align-items:center}
  .delivered{opacity:.45}
  .check{transform:scale(1.2)}
</style>
</head>
<body>

<h3>å•ç‚¹å¯¼èˆªï¼ˆå‡çº§ç‰ˆï¼‰</h3>
<div class="small">
  âœ… è‡ªåŠ¨ä¿å­˜ï¼ˆåˆ·æ–°ä¸ä¸¢ï¼‰ï½œâœ… å·²é€æ‰“å‹¾ï½œğŸ” æœç´¢å¿«é€Ÿæ‰¾å•ï½œâœ… è‡ªåŠ¨æ‹†â€œè·¯çº¿å·+åœ°å€â€ï¼ˆä¿®å¤é€—å·é—®é¢˜ï¼‰
</div>

<textarea id="input" placeholder="æ¯è¡Œä¸€å•ï¼ˆç›´æ¥ç²˜è´´å³å¯ï¼‰
ç¤ºä¾‹ï¼š
566, 583 Gardenia Dr, Monessen, PA
676 1128 Chestnut Ridge Dr, Pittsburgh, PA
676 1128 Chestnut Ridge Dr, Pittsburgh, PA 15205
677-1228 Chestnut Ridge Dr, Pittsburgh, PA"></textarea>

<div class="row" style="margin-top:10px">
  <button class="primary" onclick="build()">ç”Ÿæˆåˆ—è¡¨</button>
  <button class="ghost" onclick="clearAll()">æ¸…ç©ºä»Šå¤©å†…å®¹</button>
</div>

<div style="margin-top:10px">
  <input id="q" placeholder="æœç´¢ï¼šè¾“å…¥è·¯çº¿å· / è¡—é“ / åŸå¸‚ï¼ˆä¾‹å¦‚ 566 æˆ– Tunnelï¼‰" oninput="render()">
</div>

<div class="small stats" style="margin-top:10px">
  <span class="pill">æ€»æ•°ï¼š<b id="t">0</b></span>
  <span class="pill">å·²é€ï¼š<b id="d">0</b></span>
  <span class="pill">å‰©ä½™ï¼š<b id="r">0</b></span>
</div>

<div id="list"></div>

<script>
const LS_TEXT = "routeNav_text_v3";
const LS_DONE = "routeNav_done_v3";

let items = [];
let doneSet = new Set();

function makeId(raw){ return raw; }

// è§„åˆ™ï¼šè¡Œé¦– 2-4 ä½æ•°å­—å½“â€œè·¯çº¿å·â€ï¼Œéšå 3-6 ä½æ•°å­—å½“â€œé—¨ç‰Œå·â€
function splitRouteAndStreet(raw){
  // e.g. "676 1128 Chestnut Ridge Dr"
  const m = raw.match(/^(\d{2,4})\s+(\d{3,6}\b.*)$/);
  if(m) return {route:m[1].trim(), rest:m[2].trim()};
  // e.g. "676-1128 Chestnut Ridge Dr" / "676: 1128 ..."
  const m2 = raw.match(/^(\d{2,4})\s*[-:#]\s*(\d{3,6}\b.*)$/);
  if(m2) return {route:m2[1].trim(), rest:m2[2].trim()};
  return null;
}

/**
 * âœ… ä¿®å¤ç‰ˆ normalizeLineï¼š
 * - å¦‚æœæœ‰é€—å·ï¼Œå…ˆæ‹†æˆ left/right
 * - ä½†å¦‚æœ left çœ‹èµ·æ¥æ˜¯â€œè·¯çº¿å· + é—¨ç‰Œ + è¡—é“â€ï¼Œå°±æŠŠ left å†æ‹†ä¸€æ¬¡
 *   ç„¶åæŠŠ right æ‹¼å›å®Œæ•´åœ°å€ï¼ˆé¿å…åªå‰© Pittsburgh, PAï¼‰
 */
function normalizeLine(line){
  let raw = (line || "").trim().replace(/\s+/g," ");
  let route = "";
  let addr = raw;

  if(raw.includes(",")){
    const i = raw.indexOf(",");
    const left = raw.slice(0,i).trim();     // é€—å·å·¦è¾¹
    const right = raw.slice(i+1).trim();    // é€—å·å³è¾¹ï¼ˆåŸå¸‚å·é‚®ç¼–ç­‰ï¼‰

    // å…³é”®ä¿®å¤ï¼šå·¦è¾¹å¦‚æœæ˜¯ â€œ676 1128 Chestnut Ridge Drâ€
    const s = splitRouteAndStreet(left);
    if(s){
      route = s.route;
      addr = (s.rest + ", " + right).trim();
      return {route, addr};
    }

    // å¦åˆ™ä¿ç•™æ—§é€»è¾‘ï¼šæŠŠé€—å·å·¦è¾¹å½“è·¯çº¿å·ï¼Œå³è¾¹å½“åœ°å€
    route = left;
    addr = right;
    return {route, addr};
  }

  // æ— é€—å·ï¼šå°è¯•æ‹†â€œè·¯çº¿å·+é—¨ç‰Œ+è¡—é“â€
  const s2 = splitRouteAndStreet(raw);
  if(s2){
    route = s2.route;
    addr = s2.rest;
    return {route, addr};
  }

  // åªæœ‰åœ°å€
  return {route, addr};
}

function saveText(){ localStorage.setItem(LS_TEXT, document.getElementById("input").value || ""); }
function saveDone(){ localStorage.setItem(LS_DONE, JSON.stringify(Array.from(doneSet))); }

function loadState(){
  const t = localStorage.getItem(LS_TEXT);
  if(t !== null) document.getElementById("input").value = t;
  try{
    const arr = JSON.parse(localStorage.getItem(LS_DONE) || "[]");
    doneSet = new Set(arr);
  }catch(e){ doneSet = new Set(); }
}

function build(){
  const lines = (document.getElementById("input").value || "")
    .split(/\n+/).map(x=>x.trim()).filter(Boolean);

  const counter = new Map();
  items = lines.map(raw=>{
    const {route, addr} = normalizeLine(raw);
    const base = makeId(raw);
    const n = (counter.get(base) || 0) + 1;
    counter.set(base, n);
    const id = n === 1 ? base : (base + " #" + n);
    return {id, route, addr, raw};
  });

  const valid = new Set(items.map(x=>x.id));
  doneSet = new Set(Array.from(doneSet).filter(id=>valid.has(id)));
  saveDone();

  render();
}

function render(){
  const list = document.getElementById("list");
  list.innerHTML = "";

  const q = (document.getElementById("q").value || "").trim().toLowerCase();
  const filtered = items.filter(it=>{
    if(!q) return true;
    const hay = (it.route + " " + it.addr).toLowerCase();
    return hay.includes(q);
  });

  const total = items.length;
  const delivered = Array.from(doneSet).length;
  document.getElementById("t").textContent = total;
  document.getElementById("d").textContent = delivered;
  document.getElementById("r").textContent = Math.max(0, total - delivered);

  for(const it of filtered){
    const isDone = doneSet.has(it.id);

    // âœ… åªæŠŠâ€œå®Œæ•´åœ°å€â€é€å» Google Maps
    const url = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(it.addr);

    const card = document.createElement("div");
    card.className = "card" + (isDone ? " delivered" : "");
    card.innerHTML = `
      <div class="left">
        <div class="addr">
          ${it.route ? `<span class="route">#${escapeHtml(it.route)}</span>` : ""}
          ${escapeHtml(it.addr)}
        </div>
      </div>
      <div class="actions">
        <label title="å·²é€" style="display:flex;align-items:center;gap:6px;font-size:13px;color:#444">
          <input class="check" type="checkbox" ${isDone ? "checked" : ""} onchange="toggleDone('${escapeAttr(it.id)}', this.checked)">
          å·²é€
        </label>
        <button class="primary" onclick="location.href='${url}'">â–¶ å¯¼èˆª</button>
      </div>
    `;
    list.appendChild(card);
  }
}

function toggleDone(id, checked){
  if(checked) doneSet.add(id);
  else doneSet.delete(id);
  saveDone();
  render();
}

function clearAll(){
  if(!confirm("ç¡®å®šæ¸…ç©ºï¼Ÿè¿™ä¼šæ¸…æ‰è¾“å…¥å†…å®¹å’Œå·²é€æ ‡è®°ã€‚")) return;
  document.getElementById("input").value = "";
  document.getElementById("q").value = "";
  items = [];
  doneSet = new Set();
  localStorage.removeItem(LS_TEXT);
  localStorage.removeItem(LS_DONE);
  render();
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function escapeAttr(s){
  return (s||"").replace(/\\/g,"\\\\").replace(/'/g,"\\'");
}

document.getElementById("input").addEventListener("input", saveText);

loadState();
if((document.getElementById("input").value || "").trim()){
  build();
}else{
  render();
}
</script>

</body>
</html>
