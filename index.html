<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>å•ç‚¹å¯¼èˆªï¼ˆçº¯åˆ—è¡¨æœ€ç»ˆç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --line:#e8e8ee;
      --blue:#1a73e8; --dark:#111; --muted:#666;
      --green:#1bbf5c;
    }
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial}
    .wrap{max-width:820px;margin:0 auto;padding:12px}
    h2{margin:8px 0 10px;font-size:26px}
    textarea{
      width:100%;height:170px;box-sizing:border-box;border-radius:14px;border:1px solid var(--line);
      padding:12px;font-size:14px;line-height:1.35;background:#fff
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;align-items:center}
    button{border:0;border-radius:14px;padding:12px 16px;font-size:16px;font-weight:900}
    .primary{background:var(--blue);color:#fff}
    .ghost{background:#fff;border:1px solid var(--line);color:#111}
    .stat{
      background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px;
      font-size:16px;font-weight:1000;display:flex;gap:12px;flex-wrap:wrap;align-items:center
    }
    .sortbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .sortbtn{background:#fff;border:1px solid var(--line);color:#111}
    .sortbtn.on{background:var(--blue);border-color:var(--blue);color:#fff}

    .search{
      width:100%;box-sizing:border-box;margin-top:10px;
      border:1px solid var(--line);border-radius:14px;padding:10px 12px;font-size:14px;background:#fff
    }
    .list{margin-top:10px}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:18px;
      padding:14px;display:flex;justify-content:space-between;align-items:center;gap:12px;
      margin-top:10px;
    }
    .left{min-width:0;display:flex;gap:12px;align-items:flex-start}
    /* çº¿è·¯å·æ›´æ˜æ˜¾ï¼šå¤§å·è“åº•ç™½å­— */
    .no{
      background:var(--blue);color:#fff;border-radius:16px;padding:12px 14px;
      font-weight:1000;font-size:18px;line-height:1;box-shadow:0 10px 22px rgba(26,115,232,.22);
      flex:0 0 auto; letter-spacing:0.3px
    }
    .addr{font-size:15px;font-weight:1000;line-height:1.25;word-break:break-word}
    .sub{font-size:12px;color:var(--muted);margin-top:4px;font-weight:700}
    .actions{display:flex;gap:10px;align-items:center;flex:0 0 auto}
    .chk{width:22px;height:22px;transform:scale(1.15)}
    /* å¯¼èˆªæŒ‰é’®ä¸è´´è¾¹ï¼šæ›´å®½ä¸€äº› */
    .navbtn{background:var(--blue);color:#fff;border-radius:14px;padding:12px 16px;font-weight:1000}
    .delivered{opacity:.45}
    .small{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35}
  </style>
</head>

<body>
  <div class="wrap">
    <h2>å•ç‚¹å¯¼èˆªï¼ˆçº¯åˆ—è¡¨æœ€ç»ˆç‰ˆï¼‰</h2>

    <textarea id="input" placeholder="æ¯è¡Œä¸€å•ï¼ˆè·¯çº¿å· ç©ºæ ¼ åœ°å€ï¼‰
ä¾‹ï¼š
676 1128 Chestnut Ridge Dr, Pittsburgh, PA
677 1228 Chestnut Ridge Dr, Pittsburgh, PA"></textarea>

    <div class="row">
      <button class="primary" id="btnBuild">ç”Ÿæˆåˆ—è¡¨</button>
      <button class="ghost" id="btnClear">æ¸…ç©ºä»Šå¤©</button>
      <button class="ghost" id="btnCopyAll">å¤åˆ¶ï¼ˆå¸¦çº¿è·¯å·ï¼‰</button>
      <button class="ghost" id="btnCopyAddr">åªå¤åˆ¶åœ°å€</button>
    </div>

    <div class="stat" id="stat">ğŸ“¦ ä»Šæ—¥å…± 0 å• ï½œ âœ… å·²é€ 0 ï½œ ğŸ•’ å‰©ä½™ 0</div>

    <div class="sortbar">
      <button class="sortbtn on" id="sortAsc">ğŸ”¼ çº¿è·¯å·å‡åº</button>
      <button class="sortbtn" id="sortDesc">ğŸ”½ çº¿è·¯å·é™åº</button>
    </div>

    <input class="search" id="search" placeholder="æœç´¢ï¼šè¾“å…¥çº¿è·¯å· / è¡—é“ / åŸå¸‚ï¼ˆä¾‹å¦‚ 676 æˆ– Chestnutï¼‰" />

    <div class="list" id="list"></div>

    <div class="small">
      ä½¿ç”¨è¯´æ˜ï¼š<br>
      1ï¼‰ç²˜è´´å½“å¤©æ‰€æœ‰å• â†’ ç‚¹ã€Œç”Ÿæˆåˆ—è¡¨ã€ã€‚<br>
      2ï¼‰ç‚¹ã€Œâ–¶ å¯¼èˆªã€ä¼šè‡ªåŠ¨âœ…ï¼ˆå·²é€ï¼‰ã€‚<br>
      3ï¼‰å‡åº/é™åºéšæ—¶åˆ‡æ¢ï¼›å¤åˆ¶ä¹Ÿä¼šæŒ‰å½“å‰æ’åºè¾“å‡ºã€‚<br>
      4ï¼‰æ¯å¤©çº¿è·¯å·ä¸åŒæ²¡å…³ç³»ï¼šç³»ç»ŸæŒ‰â€œæ—¥æœŸâ€åˆ†å¼€ä¿å­˜ï¼Œåˆ·æ–°ä¸ä¸¢ã€‚<br>
    </div>
  </div>

<script>
/* ========= æ¯å¤©ç‹¬ç«‹å­˜å‚¨ ========= */
function todayKey(){
  const d=new Date();
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
const K_INPUT = "rn:input:"+todayKey();
const K_DONE  = "rn:done:"+todayKey();
const K_SORT  = "rn:sort"; // è®°ä½ä½ å–œæ¬¢å‡/é™

let doneSet = new Set(JSON.parse(localStorage.getItem(K_DONE) || "[]"));
let sortMode = localStorage.getItem(K_SORT) || "asc"; // asc / desc

/* ========= æ•°æ® ========= */
let orders = []; // {id,noStr,noNum,addr,done}

/* ========= DOM ========= */
const elInput = document.getElementById('input');
const elList  = document.getElementById('list');
const elStat  = document.getElementById('stat');
const elSearch= document.getElementById('search');

document.getElementById('btnBuild').addEventListener('click', buildList);
document.getElementById('btnClear').addEventListener('click', clearToday);
document.getElementById('btnCopyAll').addEventListener('click', ()=>copyText(makeCopyText(true)));
document.getElementById('btnCopyAddr').addEventListener('click', ()=>copyText(makeCopyText(false)));

document.getElementById('sortAsc').addEventListener('click', ()=>setSort("asc"));
document.getElementById('sortDesc').addEventListener('click', ()=>setSort("desc"));
elSearch.addEventListener('input', renderList);

/* ========= æ¢å¤è¾“å…¥ ========= */
elInput.value = localStorage.getItem(K_INPUT) || "";
elInput.addEventListener('input', ()=> localStorage.setItem(K_INPUT, elInput.value));

/* ========= è§£æï¼ˆå…¼å®¹ NO.676 / 676, / 676 ç©ºæ ¼ï¼‰ ========= */
function parseLines(text){
  const lines = text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const out = [];
  let auto = 1;
  for(const line of lines){
    const m = line.match(/^(?:NO\.?\s*)?(\d{1,6})[,\sï¼Œ]+(.+)$/i);
    if(m){
      out.push({noStr: m[1], noNum: parseInt(m[1],10), addr: m[2].trim()});
    }else{
      // æ²¡æœ‰å·ï¼šç»™ A001ï¼ˆæ’æœ€åï¼‰
      const noStr = "A"+String(auto++).padStart(3,'0');
      out.push({noStr, noNum: Number.MAX_SAFE_INTEGER - 10000 + auto, addr: line});
    }
  }
  return out;
}

/* ========= æ’åº ========= */
function setSort(mode){
  sortMode = mode;
  localStorage.setItem(K_SORT, sortMode);
  document.getElementById('sortAsc').classList.toggle('on', sortMode==="asc");
  document.getElementById('sortDesc').classList.toggle('on', sortMode==="desc");
  renderAll();
}
function sortOrders(arr){
  const a = arr.slice();
  a.sort((x,y)=> sortMode==="asc" ? (x.noNum - y.noNum) : (y.noNum - x.noNum));
  return a;
}

/* ========= æ„å»ºåˆ—è¡¨ ========= */
function buildList(){
  const parsed = parseLines(elInput.value || "");
  const old = new Map(orders.map(o=>[o.id,o]));

  orders = parsed.map(p=>{
    const id = p.noStr + "||" + p.addr;   // å”¯ä¸€é”®ï¼ˆå·+åœ°å€ï¼‰
    const was = old.get(id);
    return {
      id,
      noStr: p.noStr,
      noNum: p.noNum,
      addr: p.addr,
      done: was ? was.done : doneSet.has(id),
    };
  });

  // æ¸…ç† doneSetï¼šé¿å…å½“å¤©æ¢äº†å†…å®¹è¿˜æ®‹ç•™æ—§çš„
  const idSet = new Set(orders.map(o=>o.id));
  doneSet = new Set([...doneSet].filter(id=>idSet.has(id)));
  saveDone();

  renderAll();
}

/* ========= ç»Ÿè®¡ ========= */
function renderStat(){
  const total = orders.length;
  const sent = orders.filter(o=>o.done).length;
  elStat.textContent = `ğŸ“¦ ä»Šæ—¥å…± ${total} å• ï½œ âœ… å·²é€ ${sent} ï½œ ğŸ•’ å‰©ä½™ ${total - sent}`;
}

/* ========= åˆ—è¡¨æ¸²æŸ“ ========= */
function renderList(){
  elList.innerHTML = "";
  const q = (elSearch.value || "").trim().toLowerCase();

  let view = sortOrders(orders);
  if(q){
    view = view.filter(o => (o.noStr+" "+o.addr).toLowerCase().includes(q));
  }

  view.forEach(o=>{
    const card = document.createElement('div');
    card.className = "card" + (o.done ? " delivered" : "");
    card.innerHTML = `
      <div class="left">
        <div class="no">NO.${escapeHtml(o.noStr)}</div>
        <div style="min-width:0">
          <div class="addr">${escapeHtml(o.addr)}</div>
          <div class="sub">ç‚¹å¯¼èˆªè‡ªåŠ¨âœ…ï½œå¯å‡åº/é™åº</div>
        </div>
      </div>
      <div class="actions">
        <input class="chk" type="checkbox" ${o.done?"checked":""} aria-label="å·²é€" />
        <button class="navbtn" type="button">â–¶ å¯¼èˆª</button>
      </div>
    `;

    // å‹¾é€‰
    card.querySelector('input').addEventListener('change', (e)=>{
      o.done = e.target.checked;
      if(o.done) doneSet.add(o.id);
      else doneSet.delete(o.id);
      saveDone();
      renderStat();
      card.classList.toggle('delivered', o.done);
    });

    // å¯¼èˆªï¼ˆè‡ªåŠ¨âœ…ï¼‰
    card.querySelector('.navbtn').addEventListener('click', ()=>{
      startNav(o);
    });

    elList.appendChild(card);
  });

  renderStat();
}

function renderAll(){
  renderStat();
  renderList();
}

/* ========= å·²é€å­˜å‚¨ ========= */
function saveDone(){
  localStorage.setItem(K_DONE, JSON.stringify([...doneSet]));
}

/* ========= å¯¼èˆªï¼šGoogle Maps ========= */
function startNav(o){
  // è‡ªåŠ¨âœ…
  if(!o.done){
    o.done = true;
    doneSet.add(o.id);
    saveDone();
  }
  renderAll();

  const url = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(o.addr) + "&travelmode=driving";
  // iOS Safari æ›´ç¨³ï¼šç›´æ¥è·³è½¬
  window.location.href = url;
}

/* ========= å¤åˆ¶ï¼ˆå¸¦å·/ä¸å¸¦å·ï¼‰ ========= */
function makeCopyText(withNo){
  const view = sortOrders(orders); // å¤åˆ¶è·Ÿæ’åºä¸€è‡´
  return withNo
    ? view.map(o=>`${o.noStr} ${o.addr}`).join("\n")
    : view.map(o=>o.addr).join("\n");
}

async function copyText(txt){
  try{
    await navigator.clipboard.writeText(txt);
    alert("å·²å¤åˆ¶ âœ…");
  }catch(e){
    // å…¼å®¹æ—§æµè§ˆå™¨
    const ta = document.createElement('textarea');
    ta.value = txt;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    alert("å·²å¤åˆ¶ âœ…");
  }
}

/* ========= æ¸…ç©ºä»Šå¤© ========= */
function clearToday(){
  if(!confirm("ç¡®å®šæ¸…ç©ºä»Šå¤©çš„è¾“å…¥å’Œå·²é€è®°å½•å—ï¼Ÿ")) return;
  localStorage.removeItem(K_INPUT);
  localStorage.removeItem(K_DONE);
  doneSet = new Set();
  orders = [];
  elInput.value = "";
  elSearch.value = "";
  renderAll();
}

/* ========= å®‰å…¨è¾“å‡º ========= */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

/* ========= åˆå§‹åŒ– ========= */
(function init(){
  document.getElementById('sortAsc').classList.toggle('on', sortMode==="asc");
  document.getElementById('sortDesc').classList.toggle('on', sortMode==="desc");
  buildList(); // è‡ªåŠ¨æŠŠä»Šå¤©è¾“å…¥ç”Ÿæˆåˆ—è¡¨
})();
</script>
</body>
</html>
