<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å•ç‚¹å¯¼èˆªï¼ˆç»ˆæç‰ˆï¼‰</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;margin:0;padding:12px;background:#f5f5f5}
  h3{margin:6px 0 10px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  textarea{width:100%;height:170px;border-radius:10px;border:1px solid #ddd;padding:10px;font-size:14px;box-sizing:border-box}
  input{width:100%;border-radius:10px;border:1px solid #ddd;padding:10px;font-size:14px;box-sizing:border-box}
  button{border:0;border-radius:10px;padding:10px 14px;font-size:16px}
  .primary{background:#1a73e8;color:#fff}
  .ghost{background:#fff;border:1px solid #ddd}
  .small{font-size:12px;color:#666;margin:8px 0}
  .stats{display:flex;gap:12px;flex-wrap:wrap}
  .pill{background:#fff;border:1px solid #e5e5e5;border-radius:999px;padding:6px 10px;font-size:13px}
  .card{
    background:#fff;border-radius:12px;padding:12px;margin-top:10px;
    display:flex;justify-content:space-between;align-items:center;gap:10px
  }
  .left{flex:1;min-width:0}
  .addr{font-size:14px;color:#333;word-break:break-word;line-height:1.25}
  .badge{
    display:inline-flex;align-items:center;gap:6px;
    background:#f2f2f2;border:1px solid #e6e6e6;color:#333;
    border-radius:999px;padding:3px 8px;font-size:12px;font-weight:700;
    margin-right:8px;white-space:nowrap
  }
  .badge .hash{color:#d60000}
  .actions{display:flex;gap:10px;align-items:center}
  .delivered{opacity:.45}
  .check{transform:scale(1.2)}
</style>
</head>
<body>

<h3>å•ç‚¹å¯¼èˆªï¼ˆç»ˆæç‰ˆï¼‰</h3>
<div class="small">
  âœ… è‡ªåŠ¨ä¿å­˜ï¼ˆåˆ·æ–°ä¸ä¸¢ï¼‰ï½œâœ… å·²é€æ‰“å‹¾ï½œğŸ” æœç´¢å¿«é€Ÿæ‰¾å•ï½œ
  âœ… è·¯çº¿å·=åºåˆ—å·å•ç‹¬æ˜¾ç¤ºï¼ˆä¸è¿›å¯¼èˆªï¼Œæ°¸è¿œä¸å½±å“ Google Mapsï¼‰
</div>

<textarea id="input" placeholder="æ¯è¡Œä¸€å•ï¼ˆéšä¾¿ç²˜è´´ï¼‰
æ”¯æŒï¼š
727 62 Taylor St, Pittsburgh, PA 15205
676 1128 Chestnut Ridge Dr, Pittsburgh, PA
566, 583 Gardenia Dr, Monessen, PA
ï¼ˆå¦‚æœæ²¡æœ‰è·¯çº¿å·ä¹Ÿå¯ä»¥ï¼š1128 Chestnut Ridge Dr, Pittsburgh, PAï¼‰"></textarea>

<div class="row" style="margin-top:10px">
  <button class="primary" onclick="build()">ç”Ÿæˆåˆ—è¡¨</button>
  <button class="ghost" onclick="clearAll()">æ¸…ç©ºä»Šå¤©å†…å®¹</button>
</div>

<div style="margin-top:10px">
  <input id="q" placeholder="æœç´¢ï¼šè¾“å…¥è·¯çº¿å· / è¡—é“ / åŸå¸‚ï¼ˆä¾‹å¦‚ 676 æˆ– Chestnutï¼‰" oninput="render()">
</div>

<div class="small stats" style="margin-top:10px">
  <span class="pill">æ€»æ•°ï¼š<b id="t">0</b></span>
  <span class="pill">å·²é€ï¼š<b id="d">0</b></span>
  <span class="pill">å‰©ä½™ï¼š<b id="r">0</b></span>
</div>

<div id="list"></div>

<script>
const LS_TEXT = "routeNav_text_v4";
const LS_DONE = "routeNav_done_v4";

let items = [];
let doneSet = new Set();

/**
 * âœ… ç»ˆæç¨³å®šè§£æè§„åˆ™ï¼š
 * - å¦‚æœè¡Œé¦–æ˜¯ 2-4 ä½æ•°å­— => å½“ä½œâ€œè·¯çº¿å·/åºåˆ—å·â€
 * - ç„¶åæŠŠåé¢å‰©ä½™éƒ¨åˆ†å½“ä½œâ€œåœ°å€â€
 * - ä¸ç®¡ä¸­é—´æ˜¯ç©ºæ ¼/é€—å·/å†’å·/è¿å­—ç¬¦ï¼Œéƒ½èƒ½æ‹†å¼€
 * - å¯¼èˆªæ°¸è¿œåªç”¨ addrï¼ˆå®Œå…¨ä¸å¸¦ routeï¼‰
 */
function normalizeLine(line){
  let raw = (line || "").trim().replace(/\s+/g," ");
  if(!raw) return {route:"", addr:""};

  // æ•è·è¡Œé¦– 2-4 ä½æ•°å­—ä½œä¸ºè·¯çº¿å·
  const m = raw.match(/^(\d{2,4})(.*)$/);
  if(m){
    const route = m[1].trim();
    let rest = (m[2] || "").trim();

    // å»æ‰å¸¸è§åˆ†éš”ç¬¦ï¼šé€—å·/å†’å·/è¿å­—ç¬¦/äº•å·ç­‰
    rest = rest.replace(/^[,\-:#\s]+/,"").trim();

    // å¦‚æœ rest ä¸ºç©ºï¼Œå°±é€€åŒ–ä¸ºåŸå§‹è¡Œï¼ˆé¿å…ç©ºå¯¼èˆªï¼‰
    const addr = rest || raw;
    return {route, addr};
  }

  // æ²¡æœ‰è·¯çº¿å·ï¼šæ•´è¡Œå½“åœ°å€
  return {route:"", addr:raw};
}

function saveText(){ localStorage.setItem(LS_TEXT, document.getElementById("input").value || ""); }
function saveDone(){ localStorage.setItem(LS_DONE, JSON.stringify(Array.from(doneSet))); }

function loadState(){
  const t = localStorage.getItem(LS_TEXT);
  if(t !== null) document.getElementById("input").value = t;
  try{
    const arr = JSON.parse(localStorage.getItem(LS_DONE) || "[]");
    doneSet = new Set(arr);
  }catch(e){ doneSet = new Set(); }
}

function build(){
  const lines = (document.getElementById("input").value || "")
    .split(/\n+/).map(x=>x.trim()).filter(Boolean);

  // å…è®¸é‡å¤è¡Œç‹¬ç«‹å‹¾é€‰
  const counter = new Map();
  items = lines.map(raw=>{
    const {route, addr} = normalizeLine(raw);
    const base = raw;
    const n = (counter.get(base) || 0) + 1;
    counter.set(base, n);
    const id = n === 1 ? base : (base + " #" + n);
    return {id, route, addr, raw};
  });

  const valid = new Set(items.map(x=>x.id));
  doneSet = new Set(Array.from(doneSet).filter(id=>valid.has(id)));
  saveDone();
  render();
}

function render(){
  const list = document.getElementById("list");
  list.innerHTML = "";

  const q = (document.getElementById("q").value || "").trim().toLowerCase();
  const filtered = items.filter(it=>{
    if(!q) return true;
    const hay = (it.route + " " + it.addr).toLowerCase();
    return hay.includes(q);
  });

  const total = items.length;
  const delivered = Array.from(doneSet).length;
  document.getElementById("t").textContent = total;
  document.getElementById("d").textContent = delivered;
  document.getElementById("r").textContent = Math.max(0, total - delivered);

  for(const it of filtered){
    const isDone = doneSet.has(it.id);

    // âœ… å¯¼èˆªåªç”¨åœ°å€ï¼ˆroute å®Œå…¨ä¸å‚ä¸ï¼‰
    const url = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(it.addr);

    const card = document.createElement("div");
    card.className = "card" + (isDone ? " delivered" : "");
    card.innerHTML = `
      <div class="left">
        <div class="addr">
          ${it.route ? `<span class="badge"><span class="hash">NO.</span>${escapeHtml(it.route)}</span>` : ""}
          ${escapeHtml(it.addr)}
        </div>
      </div>
      <div class="actions">
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;color:#444">
          <input class="check" type="checkbox" ${isDone ? "checked" : ""} onchange="toggleDone('${escapeAttr(it.id)}', this.checked)">
          å·²é€
        </label>
        <button class="primary" onclick="location.href='${url}'">â–¶ å¯¼èˆª</button>
      </div>
    `;
    list.appendChild(card);
  }
}

function toggleDone(id, checked){
  if(checked) doneSet.add(id);
  else doneSet.delete(id);
  saveDone();
  render();
}

function clearAll(){
  if(!confirm("ç¡®å®šæ¸…ç©ºï¼Ÿè¿™ä¼šæ¸…æ‰è¾“å…¥å†…å®¹å’Œå·²é€æ ‡è®°ã€‚")) return;
  document.getElementById("input").value = "";
  document.getElementById("q").value = "";
  items = [];
  doneSet = new Set();
  localStorage.removeItem(LS_TEXT);
  localStorage.removeItem(LS_DONE);
  render();
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function escapeAttr(s){
  return (s||"").replace(/\\/g,"\\\\").replace(/'/g,"\\'");
}

document.getElementById("input").addEventListener("input", saveText);

loadState();
if((document.getElementById("input").value || "").trim()){
  build();
}else{
  render();
}
</script>

</body>
</html>
