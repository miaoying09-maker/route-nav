<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>å•ç‚¹å¯¼èˆªï¼ˆæœ€ç»ˆç‰ˆï¼‰</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --line:#e8e8ee;
    --blue:#1a73e8; --dark:#111; --muted:#666;
    --green:#1bbf5c;
  }
  body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial}
  .wrap{max-width:820px;margin:0 auto;padding:12px}
  h2{margin:8px 0 6px;font-size:26px}
  .banner{font-size:12px;color:var(--muted);margin:0 0 10px}

  textarea{
    width:100%;height:160px;box-sizing:border-box;border-radius:14px;border:1px solid var(--line);
    padding:12px;font-size:14px;line-height:1.35;background:#fff
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;align-items:center}
  button{border:0;border-radius:14px;padding:12px 16px;font-size:16px;font-weight:900}
  .primary{background:var(--blue);color:#fff}
  .ghost{background:#fff;border:1px solid var(--line);color:#111}
  .tabs{display:flex;gap:10px;margin:6px 0 10px}
  .tab{background:#fff;border:1px solid var(--line);color:#111}
  .tab.on{background:var(--dark);color:#fff;border-color:var(--dark)}
  .stat{
    background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px;
    font-size:16px;font-weight:900;display:flex;gap:12px;flex-wrap:wrap;align-items:center
  }
  .small{font-size:12px;color:var(--muted);margin-top:8px}

  .sortbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .sortbtn{background:#fff;border:1px solid var(--line);color:#111}
  .sortbtn.on{background:var(--blue);border-color:var(--blue);color:#fff}

  .search{
    width:100%;box-sizing:border-box;margin-top:10px;
    border:1px solid var(--line);border-radius:14px;padding:10px 12px;font-size:14px;background:#fff
  }
  .list{margin-top:10px}
  .card{
    background:var(--card);border:1px solid var(--line);border-radius:18px;
    padding:14px;display:flex;justify-content:space-between;align-items:center;gap:12px;
    margin-top:10px;
  }
  .left{min-width:0;display:flex;gap:12px;align-items:flex-start}
  .no{
    background:var(--blue);color:#fff;border-radius:16px;padding:12px 14px;
    font-weight:1000;font-size:18px;line-height:1;
    box-shadow:0 10px 22px rgba(26,115,232,.28);
    letter-spacing:.5px;
    flex:0 0 auto
  }
  .addr{font-size:15px;font-weight:900;line-height:1.25;word-break:break-word}
  .sub{font-size:12px;color:var(--muted);margin-top:4px;font-weight:700}
  .actions{display:flex;gap:10px;align-items:center;flex:0 0 auto}
  .chk{width:22px;height:22px;transform:scale(1.15)}
  .navbtn{background:var(--blue);color:#fff;border-radius:14px;padding:12px 14px;font-weight:1000}
  .delivered{opacity:.45}

  .hidden{display:none !important;}

  /* åœ°å›¾ */
  #mapHost{margin-top:10px;background:#fff;border:1px solid var(--line);border-radius:18px;overflow:hidden;position:relative}
  #map{height:72vh;width:100%}

  /* æµ®åŠ¨å…¨å±æŒ‰é’®ï¼ˆé¿å…è¢«åœ°å›¾å±‚æŒ¡ä½ï¼ŒiPhoneæœ€ç¨³ï¼‰ */
  #btnFullFloat{
    position:absolute; right:12px; top:12px; z-index:9999;
    background:#111;color:#fff;border:0;border-radius:14px;padding:10px 12px;font-weight:1000
  }

  .pin{
    width:46px;height:46px;border-radius:999px;background:var(--dark);color:#fff;
    display:flex;align-items:center;justify-content:center;font-weight:1000;font-size:16px;
    border:3px solid #fff;box-shadow:0 10px 20px rgba(0,0,0,.22);
  }
  .pin.done{background:var(--green)}
  .popbtn{
    width:100%;border:0;border-radius:14px;padding:12px 14px;font-weight:1000;
    background:var(--blue);color:#fff;margin-top:10px
  }

  /* çœŸå…¨å±ï¼ˆå¼¹å±‚ï¼‰ */
  .fsMask{position:fixed;inset:0;background:#00000066;display:none;z-index:999999}
  .fsMask.show{display:block}
  .fsPanel{
    position:fixed;inset:0;background:#fff;display:none;flex-direction:column;z-index:1000000;
    padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);
  }
  .fsPanel.show{display:flex}
  .fsBar{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eee}
  .fsTitle{font-weight:1000}
  .fsBtn{background:#111;color:#fff;border-radius:14px;padding:10px 12px;font-weight:1000}
  #mapFSWrap{flex:1;min-height:0}
  #mapFS{height:100%;width:100%}
</style>
</head>

<body>
<div class="wrap">
  <h2>å•ç‚¹å¯¼èˆªï¼ˆæœ€ç»ˆç‰ˆï¼‰</h2>
  <div class="banner" id="banner">åŠ è½½ä¸­â€¦</div>

  <textarea id="input" placeholder="æ¯è¡Œä¸€å•ï¼ˆè·¯çº¿å· ç©ºæ ¼ åœ°å€ï¼‰
ä¾‹ï¼š
676 1128 Chestnut Ridge Dr, Pittsburgh, PA
677 1228 Chestnut Ridge Dr, Pittsburgh, PA"></textarea>

  <div class="row">
    <button class="primary" id="btnBuild">ç”Ÿæˆåˆ—è¡¨</button>
    <button class="ghost" id="btnClear">æ¸…ç©º</button>
    <button class="ghost" id="btnCopyAll">å¤åˆ¶ï¼ˆå¸¦çº¿è·¯å·ï¼‰</button>
    <button class="ghost" id="btnCopyAddr">åªå¤åˆ¶åœ°å€</button>
  </div>

  <div class="tabs">
    <button class="tab on" id="tabList">åˆ—è¡¨æ¨¡å¼</button>
    <button class="tab" id="tabMap">åœ°å›¾æ¨¡å¼</button>
  </div>

  <div class="stat" id="stat">ğŸ“¦ ä»Šæ—¥å…± 0 å• ï½œ âœ… å·²é€ 0 ï½œ ğŸ•’ å‰©ä½™ 0</div>

  <div class="sortbar" id="sortbar">
    <button class="sortbtn on" id="sortAsc">ğŸ”¼ çº¿è·¯å·å‡åº</button>
    <button class="sortbtn" id="sortDesc">ğŸ”½ çº¿è·¯å·é™åº</button>
  </div>

  <!-- åˆ—è¡¨è§†å›¾ -->
  <div id="viewList">
    <input class="search" id="search" placeholder="æœç´¢ï¼šè¾“å…¥çº¿è·¯å· / è¡—é“ / åŸå¸‚ï¼ˆä¾‹å¦‚ 676 æˆ– Chestnutï¼‰" />
    <div class="list" id="list"></div>
    <div class="small">æç¤ºï¼šç‚¹â€œå¯¼èˆªâ€ä¼šè‡ªåŠ¨âœ…ã€‚ç¬¬äºŒå¤©çº¿è·¯å·å˜äº†ä¹Ÿæ²¡å…³ç³»ï¼Œç²˜è´´å½“å¤©çš„å°±è¡Œã€‚</div>
  </div>

  <!-- åœ°å›¾è§†å›¾ -->
  <div id="viewMap" class="hidden">
    <div class="row" style="margin-top:10px">
      <button class="primary" id="btnMapPins">ç”Ÿæˆåœ°å›¾ç‚¹</button>
      <div class="small" id="geoInfo">æœªå¼€å§‹å®šä½</div>
    </div>
    <div id="mapHost">
      <button id="btnFullFloat">å…¨å±</button>
      <div id="map"></div>
    </div>
    <div class="small">ç‚¹å›¾é’‰ â†’ å¡ç‰‡ â†’ å¯¼èˆªï¼ˆè‡ªåŠ¨âœ…ï¼‰ã€‚</div>
  </div>
</div>

<!-- å…¨å±å¼¹å±‚ -->
<div id="fsMask" class="fsMask"></div>
<div id="fsPanel" class="fsPanel">
  <div class="fsBar">
    <div class="fsTitle">åœ°å›¾å…¨å±</div>
    <button class="fsBtn" id="btnExit">é€€å‡º âœ•</button>
  </div>
  <div id="mapFSWrap"><div id="mapFS"></div></div>
</div>

<script>
(function(){
  const banner = document.getElementById('banner');

  // è¶…ç¨³ç»‘å®šï¼šå°±ç®—æŸä¸ªIDä¸å­˜åœ¨ä¹Ÿä¸ä¼šæ•´é¡µå´©
  function $(id){ return document.getElementById(id); }
  function on(id, evt, fn){
    const el = $(id);
    if(!el) return;
    el.addEventListener(evt, fn, {passive:false});
  }

  function todayKey(){
    const d=new Date();
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  const K_INPUT = "rn:input:"+todayKey();
  const K_DONE  = "rn:done:"+todayKey();
  const K_SORT  = "rn:sort";
  const K_GEO   = "rn:geo";

  let doneSet = new Set(JSON.parse(localStorage.getItem(K_DONE) || "[]"));
  let geoCache = JSON.parse(localStorage.getItem(K_GEO) || "{}");
  let sortMode = localStorage.getItem(K_SORT) || "asc";

  let orders = []; // {id,noStr,noNum,addr,done,lat,lng}

  const elInput = $('input');
  const elList  = $('list');
  const elStat  = $('stat');
  const elSearch= $('search');
  const elGeoInfo=$('geoInfo');

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }
  function escapeJs(s){
    return String(s).replace(/\\/g,"\\\\").replace(/'/g,"\\'");
  }

  function saveDone(){ localStorage.setItem(K_DONE, JSON.stringify([...doneSet])); }

  function parseLines(text){
    const lines = (text||"").split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const out = [];
    let auto = 1;
    for(const line of lines){
      const m = line.match(/^(?:NO\.?\s*)?(\d{1,6})[,\sï¼Œ]+(.+)$/i);
      if(m){
        out.push({noStr: m[1], noNum: parseInt(m[1],10), addr: m[2].trim()});
      }else{
        const noStr = "A"+String(auto++).padStart(3,'0');
        out.push({noStr, noNum: Number.MAX_SAFE_INTEGER - 10000 + auto, addr: line});
      }
    }
    return out;
  }

  function setSort(mode){
    sortMode = mode;
    localStorage.setItem(K_SORT, sortMode);
    $('sortAsc')?.classList.toggle('on', sortMode==="asc");
    $('sortDesc')?.classList.toggle('on', sortMode==="desc");
    renderAll();
  }
  function sortOrders(arr){
    const a = arr.slice();
    a.sort((x,y)=> sortMode==="asc" ? (x.noNum - y.noNum) : (y.noNum - x.noNum));
    return a;
  }

  function buildList(){
    const parsed = parseLines(elInput?.value || "");
    const old = new Map(orders.map(o=>[o.id,o]));

    orders = parsed.map(p=>{
      const id = p.noStr + "||" + p.addr;
      const was = old.get(id);
      return {
        id, noStr:p.noStr, noNum:p.noNum, addr:p.addr,
        done: doneSet.has(id),
        lat: was ? was.lat : null,
        lng: was ? was.lng : null,
      };
    });

    renderAll();
    saveDone();
  }

  function renderStat(){
    const total = orders.length;
    const sent = orders.filter(o=>o.done).length;
    if(elStat) elStat.textContent = `ğŸ“¦ ä»Šæ—¥å…± ${total} å• ï½œ âœ… å·²é€ ${sent} ï½œ ğŸ•’ å‰©ä½™ ${total - sent}`;
  }

  function startNav(o){
    if(!o.done){
      o.done = true;
      doneSet.add(o.id);
      saveDone();
      renderAll();
      recolorPins();
    }
    const url = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(o.addr) + "&travelmode=driving";
    window.location.href = url;
  }

  function renderList(){
    if(!elList) return;
    elList.innerHTML = "";
    const q = (elSearch?.value || "").trim().toLowerCase();

    let view = sortOrders(orders);
    if(q){
      view = view.filter(o => (o.noStr+" "+o.addr).toLowerCase().includes(q));
    }

    view.forEach(o=>{
      const card = document.createElement('div');
      card.className = "card" + (o.done ? " delivered" : "");
      card.innerHTML = `
        <div class="left">
          <div class="no">NO.${escapeHtml(o.noStr)}</div>
          <div style="min-width:0">
            <div class="addr">${escapeHtml(o.addr)}</div>
            <div class="sub">ç‚¹å¯¼èˆªè‡ªåŠ¨âœ…ï¼ˆå‡åº/é™åºå¯åˆ‡æ¢ï¼‰</div>
          </div>
        </div>
        <div class="actions">
          <input class="chk" type="checkbox" ${o.done?"checked":""} />
          <button class="navbtn">â–¶ å¯¼èˆª</button>
        </div>
      `;

      card.querySelector('input').addEventListener('change', (e)=>{
        o.done = e.target.checked;
        if(o.done) doneSet.add(o.id);
        else doneSet.delete(o.id);
        saveDone();
        renderAll();
        recolorPins();
      });

      card.querySelector('.navbtn').addEventListener('click', ()=> startNav(o));

      elList.appendChild(card);
    });

    renderStat();
  }

  function renderAll(){
    renderStat();
    renderList();
  }

  function makeCopyText(withNo){
    const view = sortOrders(orders);
    return withNo
      ? view.map(o=>`${o.noStr} ${o.addr}`).join("\n")
      : view.map(o=>o.addr).join("\n");
  }

  async function copyText(txt){
    try{
      await navigator.clipboard.writeText(txt);
      alert("å·²å¤åˆ¶ âœ…");
    }catch(e){
      const ta = document.createElement('textarea');
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      alert("å·²å¤åˆ¶ âœ…");
    }
  }

  function showView(which){
    const onList = (which==="list");
    $('tabList')?.classList.toggle('on', onList);
    $('tabMap')?.classList.toggle('on', !onList);
    $('viewList')?.classList.toggle('hidden', !onList);
    $('viewMap')?.classList.toggle('hidden', onList);

    if(!onList){
      ensureMapSmall();
      setTimeout(()=>mapSmall?.invalidateSize(), 200);
    }
  }

  // ===== åœ°å›¾ =====
  let mapSmall=null, mapFull=null;
  let mkSmall=[], mkFull=[];

  function ensureMapSmall(){
    if(mapSmall) return;
    mapSmall = L.map('map', {zoomControl:true}).setView([40.4406,-79.9959], 10);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {maxZoom:19}).addTo(mapSmall);
  }
  function ensureMapFull(){
    if(mapFull) return;
    mapFull = L.map('mapFS', {zoomControl:true}).setView([40.4406,-79.9959], 10);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {maxZoom:19}).addTo(mapFull);
  }

  function pinIcon(text, done){
    const cls = "pin" + (done ? " done" : "");
    return L.divIcon({
      className:"",
      html:`<div class="${cls}">${escapeHtml(text)}</div>`,
      iconSize:[46,46], iconAnchor:[23,23]
    });
  }

  function clearPins(){
    mkSmall.forEach(m=>m.remove()); mkSmall=[];
    mkFull.forEach(m=>m.remove()); mkFull=[];
  }

  function cacheGeoSave(){ localStorage.setItem(K_GEO, JSON.stringify(geoCache)); }
  const sleep = ms => new Promise(r=>setTimeout(r,ms));

  async function geocode(addr){
    if(geoCache[addr]?.lat && geoCache[addr]?.lng) return geoCache[addr];
    if(geoCache[addr]?.fail) return null;

    const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=us&q=" + encodeURIComponent(addr);
    const r = await fetch(url, {headers:{'Accept':'application/json'}});
    const j = await r.json();
    if(j && j[0]){
      const g = {lat: parseFloat(j[0].lat), lng: parseFloat(j[0].lon), ts: Date.now()};
      geoCache[addr]=g; cacheGeoSave(); return g;
    }else{
      geoCache[addr]={fail:true, ts: Date.now()}; cacheGeoSave(); return null;
    }
  }

  function openPopupFor(o, m, mk){
    const html = `
      <div style="min-width:240px">
        <div style="font-weight:1000;font-size:16px;margin-bottom:6px">NO.${escapeHtml(o.noStr)}</div>
        <div style="color:#333;line-height:1.25">${escapeHtml(o.addr)}</div>
        <button class="popbtn" onclick="window.__NAV('${escapeJs(o.id)}')">â–¶ å¯¼èˆªï¼ˆè‡ªåŠ¨âœ…ï¼‰</button>
      </div>
    `;
    mk.bindPopup(html).openPopup();
  }
  window.__NAV = function(id){
    const o = orders.find(x=>x.id===id);
    if(o) startNav(o);
  }

  function drawOne(o){
    if(o.lat==null || o.lng==null) return;
    const icon = pinIcon(o.noStr, o.done);

    const mk1 = L.marker([o.lat,o.lng], {icon}).addTo(mapSmall);
    mk1.on('click', ()=>openPopupFor(o, mapSmall, mk1));
    mkSmall.push(mk1);

    if(mapFull){
      const mk2 = L.marker([o.lat,o.lng], {icon: pinIcon(o.noStr, o.done)}).addTo(mapFull);
      mk2.on('click', ()=>openPopupFor(o, mapFull, mk2));
      mkFull.push(mk2);
    }
  }

  function fitBounds(){
    const pts = orders.filter(o=>o.lat!=null && o.lng!=null).map(o=>[o.lat,o.lng]);
    if(!pts.length) return;
    const b = L.latLngBounds(pts);
    mapSmall.fitBounds(b.pad(0.2));
    if(mapFull) mapFull.fitBounds(b.pad(0.2));
  }

  async function genPins(onlyRecolor){
    ensureMapSmall();
    clearPins();

    const view = sortOrders(orders);
    let ok=0, total=view.length;
    if(elGeoInfo) elGeoInfo.textContent = onlyRecolor ? `åˆ·æ–°å›¾é’‰â€¦` : `å®šä½ä¸­ 0/${total}`;

    for(const o of view){
      if(o.lat!=null && o.lng!=null){
        drawOne(o); ok++;
      }
    }

    if(!onlyRecolor){
      let idx=0;
      for(const o of view){
        idx++;
        if(o.lat!=null && o.lng!=null) continue;
        const g = await geocode(o.addr);
        if(g){
          o.lat=g.lat; o.lng=g.lng;
          drawOne(o);
          ok++;
        }
        if(elGeoInfo) elGeoInfo.textContent = `å®šä½ä¸­ ${idx}/${total}ï¼ˆæˆåŠŸ ${ok}ï¼‰`;
        await sleep(600);
      }
    }

    fitBounds();
    if(elGeoInfo) elGeoInfo.textContent = `å®Œæˆï¼šæˆåŠŸå®šä½ ${ok}/${total}ï¼ˆæ²¡æ˜¾ç¤ºé€šå¸¸æ˜¯å®šä½å¤±è´¥ï¼‰`;
  }

  function recolorPins(){
    if(mkSmall.length || mkFull.length) genPins(true);
  }

  function openFull(){
    ensureMapFull();
    $('fsMask')?.classList.add('show');
    $('fsPanel')?.classList.add('show');
    setTimeout(()=>{
      mapFull.invalidateSize();
      genPins(true);
      fitBounds();
    }, 200);
  }
  function closeFull(){
    $('fsMask')?.classList.remove('show');
    $('fsPanel')?.classList.remove('show');
  }

  // ===== ç»‘å®šäº‹ä»¶ï¼ˆä¸å´©ï¼‰=====
  on('btnBuild','click', buildList);
  on('btnClear','click', ()=>{
    localStorage.removeItem(K_INPUT);
    localStorage.removeItem(K_DONE);
    doneSet = new Set();
    if(elInput) elInput.value = "";
    orders = [];
    renderAll();
    clearPins();
    if(elGeoInfo) elGeoInfo.textContent = "å·²æ¸…ç©º";
  });
  on('btnCopyAll','click', ()=>copyText(makeCopyText(true)));
  on('btnCopyAddr','click', ()=>copyText(makeCopyText(false)));

  on('tabList','click', ()=>showView("list"));
  on('tabMap','click', ()=>showView("map"));

  on('sortAsc','click', ()=>setSort("asc"));
  on('sortDesc','click', ()=>setSort("desc"));

  on('search','input', renderList);

  on('btnMapPins','click', ()=>genPins(false));
  on('btnFullFloat','click', openFull);
  on('btnExit','click', closeFull);
  on('fsMask','click', closeFull);

  // æ¢å¤è¾“å…¥
  if(elInput){
    elInput.value = localStorage.getItem(K_INPUT) || "";
    elInput.addEventListener('input', ()=> localStorage.setItem(K_INPUT, elInput.value));
  }

  // åˆå§‹åŒ–
  try{
    banner.textContent = "JSå·²åŠ è½½ âœ…ï¼ˆå¦‚æœæŒ‰é’®èƒ½ç‚¹ï¼Œè¯´æ˜è„šæœ¬æ­£å¸¸è¿è¡Œï¼‰";
    $('sortAsc')?.classList.toggle('on', sortMode==="asc");
    $('sortDesc')?.classList.toggle('on', sortMode==="desc");
    buildList();
    showView("list");
  }catch(err){
    banner.textContent = "JSå‡ºé”™ âŒï¼š" + (err?.message || err);
    alert("é¡µé¢è„šæœ¬å‡ºé”™ï¼š" + (err?.message || err));
  }
})();
</script>
</body>
</html>
