<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å•ç‚¹å¯¼èˆªï¼ˆç»ˆæç‰ˆï¼‰</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;margin:0;padding:12px;background:#f5f5f5}
h3{margin:6px 0 10px}
textarea,input{width:100%;border-radius:10px;border:1px solid #ddd;padding:10px;font-size:14px;box-sizing:border-box}
textarea{height:150px}
button{border:0;border-radius:10px;padding:10px 14px;font-size:15px}
.primary{background:#1a73e8;color:#fff}
.ghost{background:#fff;border:1px solid #ddd}
.card{background:#fff;border-radius:12px;padding:12px;margin-top:10px;display:flex;justify-content:space-between;gap:10px}
.badge{background:#eee;border-radius:999px;padding:4px 8px;font-size:12px;font-weight:700;margin-right:6px}
.addr{font-size:14px;line-height:1.3}
.actions{display:flex;gap:8px;align-items:center}
.delivered{opacity:.45}
.tabs{display:flex;gap:10px;margin-top:10px}
#map{height:60vh;border-radius:12px;margin-top:10px}
.small{font-size:12px;color:#666;margin:6px 0}
</style>
</head>

<body>

<h3>å•ç‚¹å¯¼èˆªï¼ˆç»ˆæç‰ˆï¼‰</h3>
<div class="small">
âœ… åˆ—è¡¨ / åœ°å›¾æ¨¡å¼ ï½œ â–¶ï¸ å¯¼èˆªè‡ªåŠ¨å‹¾é€‰ ï½œ ğŸ“ ç‚¹åœ°å›¾ç›´æ¥å¯¼èˆª
</div>

<textarea id="input" placeholder="æ¯è¡Œä¸€å•ï¼š
727 62 Taylor St, Pittsburgh, PA
676 1128 Chestnut Ridge Dr, Pittsburgh, PA"></textarea>

<div class="tabs">
  <button class="primary" onclick="build()">ç”Ÿæˆåˆ—è¡¨</button>
  <button class="ghost" onclick="clearAll()">æ¸…ç©º</button>
</div>

<div class="tabs">
  <button id="btnList" class="primary" onclick="setMode('list')">åˆ—è¡¨æ¨¡å¼</button>
  <button id="btnMap" class="ghost" onclick="setMode('map')">åœ°å›¾æ¨¡å¼</button>
</div>

<div id="list"></div>
<div id="mapWrap" style="display:none">
  <button class="primary" onclick="geocodeAll()">ç”Ÿæˆåœ°å›¾ç‚¹</button>
  <div id="map"></div>
</div>

<script>
const LS_DONE="done_auto_v1",LS_TEXT="text_auto_v1",LS_GEO="geo_auto_v1";
let items=[],doneSet=new Set(),geoCache={};
let map,layer;

function normalizeLine(l){
 l=l.trim().replace(/\s+/g," ");
 let m=l.match(/^(\d{2,4})(.*)$/);
 if(m){
  let rest=m[2].replace(/^[,\-:#\s]+/,"");
  return {id:l,route:m[1],addr:rest||l};
 }
 return {id:l,route:"",addr:l};
}

function build(){
 const lines=document.getElementById("input").value.split(/\n+/).filter(Boolean);
 items=lines.map(normalizeLine);
 save();
 render();
}

function render(){
 const list=document.getElementById("list"); list.innerHTML="";
 items.forEach(it=>{
  const div=document.createElement("div");
  div.className="card"+(doneSet.has(it.id)?" delivered":"");
  div.innerHTML=`
   <div class="addr">
    ${it.route?`<span class="badge">NO.${it.route}</span>`:""}
    ${it.addr}
   </div>
   <div class="actions">
    <input type="checkbox" ${doneSet.has(it.id)?"checked":""}
     onchange="toggle('${it.id}')">
    <button class="primary"
     onclick="goNav('${it.id}','${it.addr.replace(/'/g,"\\'")}')">â–¶ å¯¼èˆª</button>
   </div>`;
  list.appendChild(div);
 });
}

function toggle(id){doneSet.has(id)?doneSet.delete(id):doneSet.add(id);save();render();}
function goNav(id,addr){
 doneSet.add(id); save(); render();
 location.href="https://www.google.com/maps/dir/?api=1&destination="+encodeURIComponent(addr);
}

function setMode(m){
 document.getElementById("list").style.display=m==="list"?"block":"none";
 document.getElementById("mapWrap").style.display=m==="map"?"block":"none";
 document.getElementById("btnList").className=m==="list"?"primary":"ghost";
 document.getElementById("btnMap").className=m==="map"?"primary":"ghost";
 if(m==="map"&&!map) initMap();
}

function initMap(){
 map=L.map("map").setView([40.44,-79.99],11);
 L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
 layer=L.layerGroup().addTo(map);
}

async function geocodeAll(){
 for(const it of items){
  if(geoCache[it.addr]) continue;
  const r=await fetch("https://nominatim.openstreetmap.org/search?format=json&q="+encodeURIComponent(it.addr));
  const j=await r.json();
  if(j[0]) geoCache[it.addr]={lat:j[0].lat,lon:j[0].lon};
  await new Promise(r=>setTimeout(r,1000));
 }
 drawMap(); save();
}

function drawMap(){
 layer.clearLayers();
 items.forEach(it=>{
  const g=geoCache[it.addr];
  if(!g) return;
  const m=L.marker([g.lat,g.lon]).addTo(layer);
  m.bindPopup(`
   <b>NO.${it.route||""}</b><br>${it.addr}<br>
   <button onclick="goNav('${it.id}','${it.addr.replace(/'/g,"\\'")}')"
   style="margin-top:6px;background:#1a73e8;color:#fff;border:0;padding:6px 10px;border-radius:8px">
   â–¶ å¯¼èˆª</button>`);
 });
}

function clearAll(){
 if(!confirm("æ¸…ç©ºï¼Ÿ"))return;
 items=[];doneSet.clear();geoCache={};
 localStorage.clear();
 render(); if(layer)layer.clearLayers();
}

function save(){
 localStorage.setItem(LS_TEXT,document.getElementById("input").value);
 localStorage.setItem(LS_DONE,JSON.stringify([...doneSet]));
 localStorage.setItem(LS_GEO,JSON.stringify(geoCache));
}

(function init(){
 document.getElementById("input").value=localStorage.getItem(LS_TEXT)||"";
 doneSet=new Set(JSON.parse(localStorage.getItem(LS_DONE)||"[]"));
 geoCache=JSON.parse(localStorage.getItem(LS_GEO)||"{}");
 if(document.getElementById("input").value.trim()) build();
})();
</script>
</body>
</html>
