<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>å•ç‚¹å¯¼èˆªï¼ˆçº¯åˆ—è¡¨æœ€ç»ˆç‰ˆ + OCRï¼‰</title>

<!-- OCRï¼šæµè§ˆå™¨æœ¬åœ°è¯†åˆ«ï¼ˆç¬¬ä¸€æ¬¡åŠ è½½ä¼šæ…¢ä¸€ç‚¹ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --line:#e8e8ee;
    --blue:#1a73e8; --dark:#111; --muted:#666;
    --red:#c62828;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:var(--bg);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial;
    color:#111;
  }
  .wrap{max-width:820px;margin:0 auto;padding:12px}
  h2{margin:10px 0 12px;font-size:26px}

  textarea{
    width:100%;height:165px;border-radius:14px;border:1px solid var(--line);
    padding:12px;font-size:14px;line-height:1.35;background:#fff;
  }

  .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;align-items:center}
  button{
    border:0;border-radius:14px;padding:12px 16px;font-size:16px;font-weight:900;
    cursor:pointer;-webkit-tap-highlight-color:transparent;
  }
  button:active{transform:scale(.99)}
  .primary{background:var(--blue);color:#fff}
  .ghost{background:#fff;border:1px solid var(--line);color:#111}
  .danger{background:#fff;border:1px solid #ffd1d1;color:var(--red)}

  .stat{
    background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px;
    font-size:16px;font-weight:1000;display:flex;gap:12px;flex-wrap:wrap;align-items:center
  }

  .sortbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .sortbtn{background:#fff;border:1px solid var(--line);color:#111}
  .sortbtn.on{background:var(--blue);border-color:var(--blue);color:#fff}

  .search{
    width:100%;margin-top:10px;border:1px solid var(--line);border-radius:14px;
    padding:10px 12px;font-size:14px;background:#fff;
  }

  .list{margin-top:10px}
  .card{
    background:var(--card);border:1px solid var(--line);border-radius:18px;
    padding:14px;display:flex;justify-content:space-between;align-items:center;gap:12px;
    margin-top:10px;
  }
  .left{min-width:0;display:flex;gap:12px;align-items:flex-start}
  .no{
    background:var(--dark);color:#fff;border-radius:14px;padding:10px 12px;
    font-weight:1000;font-size:16px;line-height:1;
    box-shadow:0 8px 18px rgba(0,0,0,.18);
    flex:0 0 auto;
  }
  .addr{font-size:15px;font-weight:1000;line-height:1.25;word-break:break-word}
  .sub{font-size:12px;color:var(--muted);margin-top:4px;font-weight:700}
  .actions{display:flex;gap:10px;align-items:center;flex:0 0 auto}
  .chk{width:22px;height:22px;transform:scale(1.15)}
  .navbtn{background:var(--blue);color:#fff;border-radius:14px;padding:12px 14px;font-weight:1000}
  .delivered{opacity:.45}

  .hint{
    margin-top:10px;padding:10px 12px;background:#fff;border:1px dashed var(--line);
    border-radius:14px;font-size:12px;color:#444;line-height:1.45
  }

  .progress{
    margin-top:10px;
    background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px;
    font-size:13px;color:#333;display:none;
  }
  .progress.show{display:block}
  .bar{margin-top:8px;height:10px;border-radius:999px;background:#eee;overflow:hidden}
  .bar > div{
    height:100%;width:0%;background:var(--blue);border-radius:999px;
    transition:width .2s;
  }

  .small{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.4}
</style>
</head>

<body>
<div class="wrap">
  <h2>å•ç‚¹å¯¼èˆªï¼ˆçº¯åˆ—è¡¨æœ€ç»ˆç‰ˆ + OCRï¼‰</h2>

  <textarea id="input" placeholder="æ¯è¡Œä¸€å•ï¼ˆè·¯çº¿å· ç©ºæ ¼ åœ°å€ï¼‰
ä¾‹å¦‚ï¼š
676 1128 Chestnut Ridge Dr, Pittsburgh, PA
677 1228 Chestnut Ridge Dr, Pittsburgh, PA"></textarea>

  <div class="row">
    <button class="primary" id="btnBuild">ç”Ÿæˆåˆ—è¡¨</button>
    <button class="ghost" id="btnOCR">ğŸ“· è¯†åˆ«æˆªå›¾ï¼ˆæœ€å¤š9å¼ ï¼‰</button>
    <button class="ghost" id="btnPaste">ğŸ“‹ ä»å‰ªè´´æ¿ç²˜è´´</button>
    <button class="ghost" id="btnCopyAll">å¤åˆ¶ï¼ˆå¸¦çº¿è·¯å·ï¼‰</button>
    <button class="ghost" id="btnCopyAddr">åªå¤åˆ¶åœ°å€</button>
    <button class="danger" id="btnClear">æ¸…ç©ºä»Šå¤©</button>

    <!-- âœ… å¤šé€‰ + âœ… 9å¼ ä¸Šé™åœ¨JSé‡Œæ§åˆ¶ -->
    <input id="imgPick" type="file" accept="image/*" multiple style="display:none" />
  </div>

  <div class="stat" id="stat">ğŸ“¦ ä»Šæ—¥å…± 0 å• ï½œ âœ… å·²é€ 0 ï½œ ğŸ•’ å‰©ä½™ 0</div>

  <div class="sortbar">
    <button class="sortbtn on" id="sortAsc">ğŸ”¼ çº¿è·¯å·å‡åº</button>
    <button class="sortbtn" id="sortDesc">ğŸ”½ çº¿è·¯å·é™åº</button>
  </div>

  <input class="search" id="search" placeholder="æœç´¢ï¼šè¾“å…¥çº¿è·¯å· / è¡—é“ / åŸå¸‚ï¼ˆä¾‹å¦‚ 676 æˆ– Chestnutï¼‰" />

  <div id="ocrProgress" class="progress">
    <div id="ocrText">è¯†åˆ«ä¸­â€¦</div>
    <div class="bar"><div id="ocrBar"></div></div>
  </div>

  <div class="list" id="list"></div>

  <div class="hint">
    âœ… ç‚¹â€œå¯¼èˆªâ€ä¼šè‡ªåŠ¨å‹¾é€‰å·²é€ã€‚<br/>
    ğŸ” æ¯å¤©çº¿è·¯å·ä¸åŒæ²¡å…³ç³»ï¼šç³»ç»ŸæŒ‰â€œä»Šå¤©æ—¥æœŸâ€å•ç‹¬ä¿å­˜è¾“å…¥ä¸å·²é€è®°å½•ã€‚<br/>
    ğŸ“· OCR å»ºè®®ï¼šæˆªå›¾è¶Šæ¸…æ™°è¶Šå¥½ï¼›åœ°å€å°½é‡åŒ…å«åŸå¸‚/å·ï¼ˆPittsburgh, PAï¼‰ã€‚<br/>
    âš ï¸ é€‰æ‹©å›¾ç‰‡è¶…è¿‡ 9 å¼ ä¼šæç¤ºä½ åˆ†æ‰¹ã€‚
  </div>

  <div class="small">
    å¦‚æœæŒ‰é’®ç‚¹äº†æ²¡ååº”ï¼šè¯·ç¡®è®¤ä½ æ˜¯ç”¨ <b>https</b> æ‰“å¼€çš„ GitHub Pagesï¼ˆä¸æ˜¯ file:// æœ¬åœ°ï¼‰ï¼Œå¹¶ä¸”é¡µé¢ä¸æ˜¯ 404ã€‚
  </div>
</div>

<script>
/* ===================== å·¥å…· ===================== */
const sleep = ms => new Promise(r => setTimeout(r, ms));

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

/* ===================== ä»Šæ—¥å­˜å‚¨ï¼ˆæ¯å¤©ç‹¬ç«‹ï¼‰ ===================== */
function todayKey(){
  const d=new Date();
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
const K_INPUT = "rn_list_ocr:input:"+todayKey();
const K_DONE  = "rn_list_ocr:done:"+todayKey();
const K_SORT  = "rn_list_ocr:sort";

let doneSet = new Set(JSON.parse(localStorage.getItem(K_DONE) || "[]"));
let sortMode = localStorage.getItem(K_SORT) || "asc"; // asc / desc
let orders = []; // {id,noStr,noNum,addr,done}

/* ===================== DOM ===================== */
const elInput = document.getElementById('input');
const elList  = document.getElementById('list');
const elStat  = document.getElementById('stat');
const elSearch= document.getElementById('search');

const elOCRBox = document.getElementById('ocrProgress');
const elOCRText= document.getElementById('ocrText');
const elOCRBar = document.getElementById('ocrBar');

document.getElementById('btnBuild').addEventListener('click', buildList);
document.getElementById('btnClear').addEventListener('click', clearToday);
document.getElementById('btnCopyAll').addEventListener('click', ()=>copyText(makeCopyText(true)));
document.getElementById('btnCopyAddr').addEventListener('click', ()=>copyText(makeCopyText(false)));
document.getElementById('btnPaste').addEventListener('click', pasteFromClipboard);

document.getElementById('sortAsc').addEventListener('click', ()=>setSort("asc"));
document.getElementById('sortDesc').addEventListener('click', ()=>setSort("desc"));
elSearch.addEventListener('input', renderList);

/* OCR */
document.getElementById('btnOCR').addEventListener('click', ()=>{
  document.getElementById('imgPick').click();
});
document.getElementById('imgPick').addEventListener('change', onPickImage);

/* æ¢å¤è¾“å…¥ */
elInput.value = localStorage.getItem(K_INPUT) || "";
elInput.addEventListener('input', ()=> localStorage.setItem(K_INPUT, elInput.value));

/* ===================== è§£æ ===================== */
function parseLines(text){
  const lines = String(text||"").split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const out = [];
  let auto = 1;
  for(const line of lines){
    const m = line.match(/^(?:NO\.?\s*)?(\d{1,6})[,\sï¼Œ]+(.+)$/i);
    if(m){
      out.push({noStr: m[1], noNum: parseInt(m[1],10), addr: m[2].trim()});
    }else{
      const noStr = "A"+String(auto++).padStart(3,'0');
      out.push({noStr, noNum: Number.MAX_SAFE_INTEGER - 10000 + auto, addr: line});
    }
  }
  return out;
}

/* ===================== æ’åº ===================== */
function setSort(mode){
  sortMode = mode;
  localStorage.setItem(K_SORT, sortMode);
  document.getElementById('sortAsc').classList.toggle('on', sortMode==="asc");
  document.getElementById('sortDesc').classList.toggle('on', sortMode==="desc");
  renderAll();
}
function sortOrders(arr){
  const a = arr.slice();
  a.sort((x,y)=> sortMode==="asc" ? (x.noNum - y.noNum) : (y.noNum - x.noNum));
  return a;
}

/* ===================== æ„å»ºåˆ—è¡¨ ===================== */
function buildList(){
  const parsed = parseLines(elInput.value || "");
  orders = parsed.map(p=>{
    const id = p.noStr + "||" + p.addr;
    return { id, noStr:p.noStr, noNum:p.noNum, addr:p.addr, done: doneSet.has(id) };
  });

  // å»é‡ï¼ˆåŒå·åŒåœ°å€é‡å¤æ—¶åªä¿ç•™ä¸€æ¬¡ï¼‰
  const seen = new Set();
  orders = orders.filter(o=>{
    if(seen.has(o.id)) return false;
    seen.add(o.id);
    return true;
  });

  // æ¸…ç† doneSetï¼ˆé¿å…æ¢äº†è¾“å…¥è¿˜ä¿ç•™æ—§çš„ï¼‰
  const idSet = new Set(orders.map(o=>o.id));
  doneSet = new Set([...doneSet].filter(id=>idSet.has(id)));
  saveDone();

  renderAll();
}

/* ===================== ç»Ÿè®¡ ===================== */
function renderStat(){
  const total = orders.length;
  const sent = orders.filter(o=>o.done).length;
  elStat.textContent = `ğŸ“¦ ä»Šæ—¥å…± ${total} å• ï½œ âœ… å·²é€ ${sent} ï½œ ğŸ•’ å‰©ä½™ ${total - sent}`;
}

/* ===================== åˆ—è¡¨æ¸²æŸ“ ===================== */
function renderList(){
  elList.innerHTML = "";
  const q = (elSearch.value || "").trim().toLowerCase();

  let view = sortOrders(orders);
  if(q){
    view = view.filter(o => (o.noStr+" "+o.addr).toLowerCase().includes(q));
  }

  for(const o of view){
    const card = document.createElement('div');
    card.className = "card" + (o.done ? " delivered" : "");
    card.innerHTML = `
      <div class="left">
        <div class="no">NO.${escapeHtml(o.noStr)}</div>
        <div style="min-width:0">
          <div class="addr">${escapeHtml(o.addr)}</div>
          <div class="sub">ç‚¹å¯¼èˆªè‡ªåŠ¨âœ…ï½œå¯å‡åº/é™åº</div>
        </div>
      </div>
      <div class="actions">
        <input class="chk" type="checkbox" ${o.done?"checked":""} />
        <button class="navbtn">â–¶ å¯¼èˆª</button>
      </div>
    `;

    card.querySelector('input').addEventListener('change', (e)=>{
      o.done = e.target.checked;
      if(o.done) doneSet.add(o.id);
      else doneSet.delete(o.id);
      saveDone();
      renderAll();
    });

    card.querySelector('.navbtn').addEventListener('click', ()=>{
      startNav(o);
    });

    elList.appendChild(card);
  }

  renderStat();
}

function renderAll(){
  renderStat();
  renderList();
}

/* ===================== å·²é€å­˜å‚¨ ===================== */
function saveDone(){
  localStorage.setItem(K_DONE, JSON.stringify([...doneSet]));
}

/* ===================== å¯¼èˆªï¼šGoogle Maps ===================== */
function startNav(o){
  if(!o.done){
    o.done = true;
    doneSet.add(o.id);
    saveDone();
    renderAll();
  }
  const url = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(o.addr) + "&travelmode=driving";
  window.location.href = url;
}

/* ===================== å¤åˆ¶ ===================== */
function makeCopyText(withNo){
  const view = sortOrders(orders);
  return withNo
    ? view.map(o=>`${o.noStr} ${o.addr}`).join("\n")
    : view.map(o=>o.addr).join("\n");
}

async function copyText(txt){
  try{
    await navigator.clipboard.writeText(txt);
    alert("å·²å¤åˆ¶ âœ…");
  }catch(e){
    const ta = document.createElement('textarea');
    ta.value = txt;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    alert("å·²å¤åˆ¶ âœ…");
  }
}

/* ===================== æ¸…ç©ºä»Šå¤© ===================== */
function clearToday(){
  if(!confirm("ç¡®å®šæ¸…ç©ºã€ä»Šå¤©ã€‘çš„è¾“å…¥å’Œå·²é€è®°å½•å—ï¼Ÿ")) return;
  localStorage.removeItem(K_INPUT);
  localStorage.removeItem(K_DONE);
  doneSet = new Set();
  orders = [];
  elInput.value = "";
  elSearch.value = "";
  renderAll();
}

/* ===================== ä»å‰ªè´´æ¿ç²˜è´´ ===================== */
async function pasteFromClipboard(){
  try{
    const t = await navigator.clipboard.readText();
    if(!t || !t.trim()){
      alert("å‰ªè´´æ¿æ²¡æœ‰æ–‡å­—");
      return;
    }
    const prev = (elInput.value || "").trim();
    elInput.value = prev ? (prev + "\n" + t.trim()) : t.trim();
    elInput.dispatchEvent(new Event('input'));
    alert("å·²ç²˜è´´ âœ… ä½ å¯ä»¥ç‚¹ã€Œç”Ÿæˆåˆ—è¡¨ã€");
  }catch(e){
    alert("æ— æ³•è¯»å–å‰ªè´´æ¿ï¼šè¯·å…è®¸å‰ªè´´æ¿æƒé™ï¼Œæˆ–æ‰‹åŠ¨ç²˜è´´åˆ°è¾“å…¥æ¡†ã€‚");
  }
}

/* ===================== OCR ===================== */
function showOCRProgress(on, text, progress01){
  if(!on){
    elOCRBox.classList.remove('show');
    return;
  }
  elOCRBox.classList.add('show');
  elOCRText.textContent = text || "è¯†åˆ«ä¸­â€¦";
  const pct = typeof progress01==="number" ? Math.round(progress01*100) : 0;
  elOCRBar.style.width = pct + "%";
}

function normalizeOcrText(t){
  return String(t)
    .replace(/\r/g, "\n")
    .replace(/[ï¼Œ]/g, ",")
    .replace(/[â€œâ€]/g, '"')
    .replace(/[â€˜â€™]/g, "'")
    .replace(/[|]/g, " ")
    .replace(/\u00A0/g, " ")
    .replace(/[ ]{2,}/g, " ")
    .replace(/\n{3,}/g, "\n\n")
    .trim();
}

function extractRouteAddrLines(text){
  const out = [];
  const lines = text.split("\n").map(s=>s.trim()).filter(Boolean);

  const re = /^(?:NO\.?\s*)?(\d{2,6})\s+(.+?)$/i;

  for(const line of lines){
    if(line.length < 8) continue;

    const m = line.match(re);
    if(!m) continue;

    const no = m[1];
    let addr = m[2].trim();

    const looksLikeAddr =
      /\d/.test(addr) &&
      /(St|Street|Ave|Avenue|Rd|Road|Dr|Drive|Ln|Lane|Blvd|Pike|Ct|Cir|Way|Pl|Ter|Terrace|Ste|Apt|Unit|PA|Pittsburgh|Crafton|McKees|Rocks|Rosslyn|Bridgeville|Coraopolis)/i.test(addr);

    if(!looksLikeAddr) continue;

    addr = addr.replace(/\s*,\s*/g, ", ").replace(/[ ]{2,}/g, " ");
    out.push(`${no} ${addr}`);
  }

  return [...new Set(out)];
}

/* âœ… å¤šé€‰OCRï¼šæœ€å¤š9å¼  + é™é€Ÿç¨³ä½ */
async function onPickImage(e){
  const files = Array.from(e.target.files || []);
  if(!files.length) return;

  // ====== 9 å¼ ä¸Šé™ï¼ˆç¡¬é™åˆ¶ï¼‰======
  if(files.length > 9){
    alert(`ä½ é€‰æ‹©äº† ${files.length} å¼ å›¾ç‰‡ã€‚\nä¸ºä¿è¯ç¨³å®šæ€§ï¼Œæ¯æ¬¡æœ€å¤šè¯†åˆ« 9 å¼ ã€‚\nè¯·åˆ†ä¸¤æ¬¡é€‰æ‹©ã€‚`);
    e.target.value = "";
    return;
  }

  showOCRProgress(true, `å¼€å§‹è¯†åˆ« ${files.length} å¼ å›¾ç‰‡â€¦`, 0);

  let allLines = [];
  let idx = 0;

  try{
    for(const file of files){
      idx++;
      showOCRProgress(true, `è¯†åˆ«ç¬¬ ${idx}/${files.length} å¼ â€¦`, (idx-1)/files.length);

      const imgURL = URL.createObjectURL(file);

      const { data } = await Tesseract.recognize(imgURL, 'eng', {
        logger: m => {
          if(m && typeof m.progress === "number"){
            const base = (idx-1)/files.length;
            const pct = base + (m.progress / files.length);
            showOCRProgress(true, `è¯†åˆ«ç¬¬ ${idx}/${files.length} å¼ â€¦`, pct);
          }
        }
      });

      URL.revokeObjectURL(imgURL);

      const raw = data && data.text ? data.text : "";
      const cleaned = normalizeOcrText(raw);
      const lines = extractRouteAddrLines(cleaned);
      allLines.push(...lines);

      // å…³é”®ï¼šç»™æµè§ˆå™¨å–˜æ¯æ—¶é—´ï¼Œ9å¼ æ›´ç¨³
      await sleep(400);
    }

    // å»é‡ï¼ˆä¿æŒé¡ºåºï¼‰
    const uniq = [];
    const seen = new Set();
    for(const l of allLines){
      if(!seen.has(l)){
        seen.add(l);
        uniq.push(l);
      }
    }

    if(!uniq.length){
      showOCRProgress(false);
      alert("æ²¡æœ‰è¯†åˆ«å‡ºæœ‰æ•ˆçš„ã€çº¿è·¯å· + åœ°å€ã€ã€‚\nå»ºè®®æˆªå›¾æ›´æ¸…æ™°ã€å­—å·æ›´å¤§ã€‚");
      return;
    }

    // è¿½åŠ åˆ°è¾“å…¥æ¡†
    const prev = (elInput.value || "").trim();
    const next = uniq.join("\n");
    elInput.value = prev ? (prev + "\n" + next) : next;
    elInput.dispatchEvent(new Event('input'));

    showOCRProgress(false);
    alert(`è¯†åˆ«å®Œæˆ âœ…\nå…± ${files.length} å¼ å›¾ç‰‡\næå– ${uniq.length} æ¡åœ°å€\nç°åœ¨ç‚¹ã€Œç”Ÿæˆåˆ—è¡¨ã€å³å¯`);
  }catch(err){
    console.error(err);
    showOCRProgress(false);
    alert("OCR è¿‡ç¨‹ä¸­å‡ºé”™ï¼šå¯èƒ½ç½‘ç»œæ…¢æˆ–å›¾ç‰‡è¿‡å¤§ã€‚\nå»ºè®®åˆ†æ‰¹è¯†åˆ«ã€‚");
  }finally{
    e.target.value = "";
  }
}

/* ===================== åˆå§‹åŒ– ===================== */
(function init(){
  document.getElementById('sortAsc').classList.toggle('on', sortMode==="asc");
  document.getElementById('sortDesc').classList.toggle('on', sortMode==="desc");
  buildList();
})();
</script>
</body>
</html>
