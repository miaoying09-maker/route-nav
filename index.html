<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å•ç‚¹å¯¼èˆªï¼ˆåˆ—è¡¨+åœ°å›¾Â·æ€»æ•°ç‚¹ï¼‰</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --blue:#1a73e8;
      --bg:#f5f5f5;
      --card:#fff;
      --border:#ddd;
      --text:#111;
      --muted:#666;
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
      margin:0; padding:12px; background:var(--bg); color:var(--text);
    }
    h2{margin:6px 0 10px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    textarea{
      width:100%; height:150px; border-radius:12px; border:1px solid var(--border);
      padding:10px; font-size:14px; box-sizing:border-box; background:#fff;
    }
    input{
      width:100%; border-radius:12px; border:1px solid var(--border);
      padding:10px; font-size:14px; box-sizing:border-box; background:#fff;
    }
    button{
      border:0; border-radius:12px; padding:10px 14px; font-size:15px;
      cursor:pointer;
    }
    .primary{background:var(--blue); color:#fff}
    .ghost{background:#fff; border:1px solid var(--border); color:#111}
    .tabs{margin-top:10px}
    .tabBtn{background:#fff;border:1px solid var(--border)}
    .tabBtn.active{background:var(--blue); color:#fff; border-color:var(--blue)}
    .stats{
      margin-top:10px; font-size:16px; font-weight:700;
      background:#fff; border:1px solid var(--border); border-radius:12px;
      padding:10px 12px;
    }
    .hint{color:var(--muted); font-size:13px; margin-top:6px}

    /* list cards */
    #listWrap{margin-top:10px}
    .card{
      background:var(--card); border-radius:14px; padding:12px;
      margin-top:10px; border:1px solid #eee;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .left{
      flex:1; min-width:0;
    }
    .badge{
      display:inline-block; padding:4px 8px; border-radius:999px;
      background:#eef2ff; font-weight:800; font-size:12px; margin-right:8px;
      vertical-align:middle;
    }
    .addr{font-size:15px; line-height:1.25; word-break:break-word}
    .city{font-size:13px; color:var(--muted); margin-top:4px}
    .right{
      display:flex; align-items:center; gap:10px;
    }
    .check{
      width:26px; height:26px; border-radius:999px;
      border:2px solid #cfcfcf; display:flex; align-items:center; justify-content:center;
      flex:0 0 26px;
      background:#fff;
    }
    .check.done{
      background:#e7f2ff; border-color:#9bc2ff;
    }
    .check.done:after{
      content:"âœ“"; font-weight:900; font-size:16px; color:#2b6cff;
      transform: translateY(-1px);
    }
    .navBtn{
      background:#2b6cff; color:#fff; border-radius:14px;
      padding:12px 14px; font-weight:800;
      min-width:86px;
    }

    /* map */
    #mapWrap{margin-top:10px; display:none}
    #map{
      height:56vh;
      border-radius:14px;
      border:1px solid #e7e7e7;
      overflow:hidden;
      background:#fff;
    }
    .mapActions{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap}
    .small{font-size:12px;color:var(--muted);margin-top:8px}

    /* Leaflet label marker */
    .labelDot{
      background:#111; color:#fff; border-radius:999px;
      padding:6px 10px; font-weight:900; font-size:15px;
      border:2px solid rgba(255,255,255,.85);
      box-shadow:0 4px 14px rgba(0,0,0,.18);
      text-align:center;
      min-width:44px;
    }
    .labelDot.red{background:#d12a2a}
    .labelDot.total{background:#111}
    .popupBox{
      font-size:14px; line-height:1.3;
    }
    .popupBox b{font-size:16px}
    .popupBtn{
      display:inline-block; margin-top:8px; background:var(--blue); color:#fff;
      padding:10px 12px; border-radius:12px; text-decoration:none; font-weight:800;
    }
  </style>
</head>

<body>
  <h2>å•ç‚¹å¯¼èˆªï¼ˆåˆ—è¡¨+åœ°å›¾ï¼‰</h2>

  <textarea id="input" placeholder="æ¯è¡Œä¸€å•ï¼ˆæ”¯æŒï¼šè·¯çº¿å·+åœ°å€ æ··ä¸€èµ·ï¼‰
ä¾‹ï¼š
773  211 Beecham Dr #116, Crafton, PA
700  4450 Steubenville Pike, Pittsburgh, PA
ä¹Ÿæ”¯æŒï¼š
NO.773 211 Beecham Dr, Crafton, PA
"></textarea>

  <div class="row" style="margin-top:10px">
    <button class="primary" onclick="buildAll()">ç”Ÿæˆåˆ—è¡¨</button>
    <button class="ghost" onclick="clearToday()">æ¸…ç©ºä»Šå¤©å†…å®¹</button>
  </div>

  <div class="tabs row">
    <button id="btnList" class="tabBtn active" onclick="showTab('list')">åˆ—è¡¨æ¨¡å¼</button>
    <button id="btnMap" class="tabBtn" onclick="showTab('map')">åœ°å›¾æ¨¡å¼</button>
  </div>

  <div class="stats" id="stat">ğŸ“¦ ä»Šæ—¥å…± 0 å• ï½œ å·²é€ 0 ï½œ å‰©ä½™ 0</div>
  <div class="hint">âœ… ç‚¹å‡»â€œå¯¼èˆªâ€ä¼šè‡ªåŠ¨æ‰“å‹¾ï¼ˆä»åœ°å›¾ç‚¹æˆ–åˆ—è¡¨éƒ½ä¸€æ ·ï¼‰</div>

  <!-- Search -->
  <div style="margin-top:10px">
    <input id="search" placeholder="æœç´¢ï¼šè¾“å…¥è·¯çº¿å· / è¡—é“ / åŸå¸‚ï¼ˆä¾‹å¦‚ 773 æˆ– Pikeï¼‰" oninput="renderList()">
  </div>

  <!-- List -->
  <div id="listWrap"></div>

  <!-- Map -->
  <div id="mapWrap">
    <div class="mapActions">
      <button class="primary" onclick="buildMap()">ç”Ÿæˆåœ°å›¾ç‚¹</button>
      <button class="ghost" onclick="fitAll()">ç¼©æ”¾åˆ°å…¨éƒ¨ç‚¹</button>
    </div>
    <div class="small">åœ°å›¾ç‚¹=è·¯çº¿å·ï¼›ç‚¹ä¸€ä¸‹å¼¹å‡ºå¡ç‰‡â†’â€œå¯¼èˆªâ€å³å¯ï¼ˆè‡ªåŠ¨âœ…ï¼‰</div>
    <div id="map"></div>
  </div>

<script>
/** =========================
 *  æ•°æ®æ¨¡å‹
 *  ========================= */
const STORAGE_KEY = "route_nav_today_v3";
const STORAGE_DAY_KEY = "route_nav_day_v3";

let orders = []; // {id, route, addr, queryAddr, delivered, lat, lng}
let map, markersLayer, totalMarker;

/** =========================
 *  å·¥å…·å‡½æ•°
 *  ========================= */
function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({orders}));
  localStorage.setItem(STORAGE_DAY_KEY, todayKey());
}

function loadState(){
  const savedDay = localStorage.getItem(STORAGE_DAY_KEY);
  if(savedDay !== todayKey()) return false;

  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return false;
  try{
    const data = JSON.parse(raw);
    if(data && Array.isArray(data.orders)){
      orders = data.orders;
      return true;
    }
  }catch(e){}
  return false;
}

function clearToday(){
  if(!confirm("ç¡®å®šæ¸…ç©ºä»Šå¤©çš„è¾“å…¥å’Œæ‰“å‹¾è®°å½•å—ï¼Ÿ")) return;
  orders = [];
  document.getElementById("input").value = "";
  document.getElementById("search").value = "";
  saveState();
  renderAll();
  if(map) {
    markersLayer.clearLayers();
    if(totalMarker){ map.removeLayer(totalMarker); totalMarker=null; }
  }
}

/** =========================
 *  è§£æï¼šæŠŠâ€œè·¯çº¿å·â€å’Œâ€œåœ°å€â€åˆ†å¼€
 *  - æ”¯æŒï¼š773 211 xxx
 *  - æ”¯æŒï¼šNO.773 211 xxx
 *  - æ”¯æŒï¼š773, 211 xxx
 *  - æ”¯æŒï¼š773: 211 xxx
 *  - æ”¯æŒï¼š773- 211 xxx
 *  ========================= */
function parseLine(line){
  let s = line.trim();
  if(!s) return null;

  // å»æ‰å¤šä½™å‰ç¼€
  s = s.replace(/^\s*(no\.?|route|çº¿è·¯å·)\s*/i, "").trim();

  // ç»Ÿä¸€åˆ†éš”ç¬¦
  s = s.replace(/[ï¼Œã€]/g, ",").trim();

  // 1) ä¼˜å…ˆæŠ“å¼€å¤´çš„æ•°å­—å½“è·¯çº¿å·
  //    å…è®¸ "773" æˆ– "773," æˆ– "773:" æˆ– "773-" åé¢è·Ÿåœ°å€
  let m = s.match(/^(\d{2,6})\s*[,:\-]?\s+(.*)$/);
  if(m){
    const route = m[1].trim();
    const addr = m[2].trim();
    if(!addr) return null;
    return {route, addr};
  }

  // 2) å¦‚æœä¸æ˜¯ä»¥æ•°å­—å¼€å¤´ï¼Œå°±å°è¯•åœ¨å‰é¢æ‰¾ä¸€ä¸ªæ•°å­—å—
  //    ä¾‹ï¼š"è®¢å• 773 211 Beecham..."
  m = s.match(/(\d{2,6})\s+(.*)$/);
  if(m){
    const route = m[1].trim();
    const addr = m[2].trim();
    return {route, addr};
  }

  // 3) å®åœ¨æ²¡æœ‰è·¯çº¿å·ï¼šå½“æˆ addrï¼Œroute ç”¨åºå·
  return {route:"", addr:s};
}

function normalizeAddr(addr){
  // å»æ‰å¤šä½™ç©ºæ ¼
  return addr.replace(/\s+/g, " ").trim();
}

/** =========================
 *  æ„å»ºåˆ—è¡¨æ•°æ®
 *  ========================= */
function buildAll(){
  const text = document.getElementById("input").value || "";
  const lines = text.split(/\n+/).map(x=>x.trim()).filter(Boolean);

  const newOrders = [];
  let autoNo = 1;

  for(const line of lines){
    const p = parseLine(line);
    if(!p) continue;
    const addr = normalizeAddr(p.addr);

    let route = p.route;
    if(!route){
      // æ²¡å†™è·¯çº¿å·å°±è‡ªåŠ¨ NO.xxx
      route = String(autoNo++).padStart(3,'0');
    }

    // è®©å¯¼èˆªåªç”¨åœ°å€ï¼Œä¸å¸¦è·¯çº¿å·
    const queryAddr = addr;

    newOrders.push({
      id: cryptoRandomId(),
      route,
      addr,
      queryAddr,
      delivered: false,
      lat: null,
      lng: null,
    });
  }

  orders = newOrders;
  saveState();
  renderAll();
}

function cryptoRandomId(){
  // ç®€å•å¯ç”¨çš„ id
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

/** =========================
 *  æ˜¾ç¤ºï¼šç»Ÿè®¡
 *  ========================= */
function updateStats(){
  const total = orders.length;
  const sent = orders.filter(o=>o.delivered).length;
  const left = total - sent;
  document.getElementById("stat").innerHTML = `ğŸ“¦ <b>ä»Šæ—¥å…± ${total} å•</b> ï½œ å·²é€ ${sent} ï½œ å‰©ä½™ ${left}`;
}

/** =========================
 *  æ˜¾ç¤ºï¼šåˆ—è¡¨
 *  ========================= */
function renderList(){
  const wrap = document.getElementById("listWrap");
  wrap.innerHTML = "";

  const q = (document.getElementById("search").value || "").trim().toLowerCase();

  const filtered = orders.filter(o=>{
    if(!q) return true;
    return (o.route && o.route.toLowerCase().includes(q))
      || (o.addr && o.addr.toLowerCase().includes(q));
  });

  filtered.forEach((o, idx)=>{
    const card = document.createElement("div");
    card.className = "card" + (o.delivered ? " delivered" : "");

    const left = document.createElement("div");
    left.className = "left";

    const badge = document.createElement("span");
    badge.className = "badge";
    // æ˜¾ç¤ºæˆ NO.773 æ ·å¼ï¼ˆä½ æƒ³è¦â€œåƒåºåˆ—å·â€ï¼‰
    badge.textContent = `NO.${o.route}`;

    const addr = document.createElement("div");
    addr.className = "addr";
    addr.innerHTML = `${badge.outerHTML} ${escapeHtml(firstLineAddr(o.addr))}`;

    const city = document.createElement("div");
    city.className = "city";
    city.textContent = restAddr(o.addr);

    left.appendChild(addr);
    if(city.textContent) left.appendChild(city);

    const right = document.createElement("div");
    right.className = "right";

    const check = document.createElement("div");
    check.className = "check" + (o.delivered ? " done" : "");
    check.title = "ç‚¹è¿™é‡Œæ‰‹åŠ¨æ‰“å‹¾/å–æ¶ˆ";
    check.onclick = ()=>toggleDelivered(o.id);

    const nav = document.createElement("button");
    nav.className = "navBtn";
    nav.textContent = "å¯¼èˆª";
    nav.onclick = ()=>startNav(o.id);

    right.appendChild(check);
    right.appendChild(nav);

    card.appendChild(left);
    card.appendChild(right);

    wrap.appendChild(card);
  });

  updateStats();
}

function firstLineAddr(addr){
  // ä¸»è¡Œï¼šæŠŠé€—å·åçš„åŸå¸‚å·ç•™ç»™ä¸‹ä¸€è¡Œæ˜¾ç¤ºæ›´æ•´é½
  return addr;
}
function restAddr(addr){
  return "";
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

/** =========================
 *  æ‰“å‹¾/å¯¼èˆª
 *  ========================= */
function toggleDelivered(id){
  const o = orders.find(x=>x.id===id);
  if(!o) return;
  o.delivered = !o.delivered;
  saveState();
  renderAll();
  refreshMapStyles();
}

function startNav(id){
  const o = orders.find(x=>x.id===id);
  if(!o) return;

  // æ‰“å¼€ Google Mapsï¼šåªç”¨åœ°å€ï¼Œä¸å¸¦è·¯çº¿å·
  const url = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(o.queryAddr);
  window.open(url, "_blank");

  // è‡ªåŠ¨æ‰“å‹¾
  if(!o.delivered){
    o.delivered = true;
    saveState();
    renderAll();
    refreshMapStyles();
  }
}

/** =========================
 *  Tabs
 *  ========================= */
function showTab(which){
  const btnList = document.getElementById("btnList");
  const btnMap = document_toggle("btnMap");

  document.getElementById("listWrap").style.display = (which==="list") ? "block" : "none";
  document.getElementById("search").parentElement.style.display = (which==="list") ? "block" : "none";
  document.getElementById("mapWrap").style.display = (which==="map") ? "block" : "none";

  btnList.classList.toggle("active", which==="list");
  document.getElementById("btnMap").classList.toggle("active", which==="map");

  if(which==="map"){
    initMapIfNeeded();
    setTimeout(()=>map.invalidateSize(), 200);
  }
}
function document_toggle(id){ return document.getElementById(id); }

/** =========================
 *  Map
 *  ========================= */
function initMapIfNeeded(){
  if(map) return;

  map = L.map('map', {zoomControl:true}).setView([40.4406, -79.9959], 9); // Pittsburgh é»˜è®¤
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: ''
  }).addTo(map);

  markersLayer = L.layerGroup().addTo(map);
}

async function buildMap(){
  initMapIfNeeded();
  markersLayer.clearLayers();
  if(totalMarker){ map.removeLayer(totalMarker); totalMarker=null; }

  // 1) å…ˆç”»â€œæ€»æ•°åœ†ç‚¹â€ï¼ˆåœ°å›¾ä¸­å¿ƒæ˜¾ç¤ºä»Šæ—¥æ€»å•é‡ï¼Œä¸å¯ç‚¹å‡»ï¼‰
  const total = orders.length;
  totalMarker = makeLabelMarker(null, null, `${total}`, "total", true);
  // å…ˆæ”¾åœ¨ Pittsburgh é™„è¿‘ï¼Œåé¢ fitAll æ—¶ä¼šè‡ªåŠ¨ç§»åŠ¨åˆ°ä¸­å¿ƒ
  totalMarker.setLatLng([40.4406, -79.9959]).addTo(map);

  // 2) å†åœ°ç†ç¼–ç æ¯æ¡åœ°å€å¹¶æ‰“ç‚¹
  const pts = [];
  for(const o of orders){
    // å·²ç»æœ‰åæ ‡å°±ç›´æ¥ç”¨ï¼ˆé¿å…é‡å¤è¯·æ±‚ï¼‰
    if(o.lat && o.lng){
      pts.push([o.lat,o.lng]);
      addOrderMarker(o);
      continue;
    }

    const pos = await geocodeNominatim(o.queryAddr);
    if(pos){
      o.lat = pos.lat; o.lng = pos.lng;
      pts.push([o.lat,o.lng]);
      addOrderMarker(o);
      saveState();
    }
  }

  // 3) ç¼©æ”¾åˆ°æ‰€æœ‰ç‚¹
  fitAll();

  // 4) æŠŠæ€»æ•°ç‚¹ç§»åŠ¨åˆ°å½“å‰åœ°å›¾ä¸­å¿ƒ
  if(totalMarker){
    const c = map.getCenter();
    totalMarker.setLatLng(c);
  }

  refreshMapStyles();
}

function makeLabelMarker(lat, lng, text, type, nonClickable){
  const cls = (type==="red") ? "labelDot red" : (type==="total" ? "labelDot total" : "labelDot");
  const icon = L.divIcon({
    className: "",
    html: `<div class="${cls}">${text}</div>`,
    iconSize: [60, 30],
    iconAnchor: [30, 15]
  });

  const m = L.marker([lat||0, lng||0], {icon, interactive: !nonClickable});
  return m;
}

function addOrderMarker(o){
  const text = `${o.route}`;
  const m = makeLabelMarker(o.lat, o.lng, text, o.delivered ? "red" : "black", false);

  const html = `
    <div class="popupBox">
      <b>NO.${escapeHtml(o.route)}</b><br>
      ${escapeHtml(o.addr)}<br>
      <a class="popupBtn" href="javascript:void(0)" onclick="window.__startNavFromMap('${o.id}')">å¯¼èˆªï¼ˆè‡ªåŠ¨âœ…ï¼‰</a>
    </div>
  `;
  m.bindPopup(html);

  markersLayer.addLayer(m);
  o.__markerId = m._leaflet_id;
}

window.__startNavFromMap = function(id){
  startNav(id);

  // å…³é—­ popup
  if(map) map.closePopup();
};

function refreshMapStyles(){
  if(!map || !markersLayer) return;

  // é‡æ–°ç”Ÿæˆ marker é¢œè‰²ï¼ˆç®€å•ç²—æš´ä½†ç¨³å®šï¼‰
  const wasCenter = map.getCenter();
  const wasZoom = map.getZoom();

  // ä¿ç•™æ€»æ•°ç‚¹
  const cTotal = totalMarker ? totalMarker.getLatLng() : null;
  const totalText = orders.length;

  markersLayer.clearLayers();
  orders.forEach(o=>{
    if(o.lat && o.lng) addOrderMarker(o);
  });

  // é‡æ–°æ”¾å›æ€»æ•°ç‚¹åˆ°ä¸­å¿ƒ
  if(totalMarker){
    map.removeLayer(totalMarker);
    totalMarker = makeLabelMarker(cTotal?.lat||wasCenter.lat, cTotal?.lng||wasCenter.lng, `${totalText}`, "total", true);
    totalMarker.addTo(map);
  }

  map.setView(wasCenter, wasZoom, {animate:false});
}

function fitAll(){
  if(!map) return;
  const pts = orders.filter(o=>o.lat && o.lng).map(o=>[o.lat,o.lng]);
  if(pts.length===0) return;
  const bounds = L.latLngBounds(pts);
  map.fitBounds(bounds.pad(0.25));

  // æ€»æ•°ç‚¹å›ºå®šæ”¾åœ¨ä¸­å¿ƒï¼ˆä¸å¤æ‚ï¼‰
  if(totalMarker){
    const c = map.getCenter();
    totalMarker.setLatLng(c);
  }
}

/** =========================
 *  Geocodingï¼ˆå…è´¹ Nominatimï¼‰
 *  æ³¨æ„ï¼šå¤§é‡åœ°å€ï¼ˆ200+ï¼‰ä¼šæ…¢ï¼Œå»ºè®®ä½ åç»­ç”¨â€œåˆ†æ‰¹ç”Ÿæˆåœ°å›¾ç‚¹â€
 *  ========================= */
async function geocodeNominatim(addr){
  try{
    const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(addr);
    const res = await fetch(url, {headers: {"Accept":"application/json"}});
    const data = await res.json();
    if(data && data[0]){
      return {lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon)};
    }
  }catch(e){}
  return null;
}

/** =========================
 *  ç»Ÿä¸€æ¸²æŸ“
 *  ========================= */
function renderAll(){
  updateStats();
  renderList();
}

/** =========================
 *  åˆå§‹åŒ–ï¼šè‡ªåŠ¨æ¢å¤ä»Šå¤©å†…å®¹
 *  ========================= */
(function init(){
  const ok = loadState();
  if(ok){
    // æ¢å¤è¾“å…¥æ¡†ï¼ˆè®©ä½ èƒ½çœ‹åˆ°åŸå§‹æ–‡æœ¬ï¼‰
    const lines = orders.map(o=>`${o.route} ${o.addr}`);
    document.getElementById("input").value = lines.join("\n");
  }
  renderAll();
})();
</script>
</body>
</html>
