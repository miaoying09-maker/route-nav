<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>å•ç‚¹å¯¼èˆªï¼ˆçº¯åˆ—è¡¨æœ€ç»ˆç‰ˆ + OCRï¼‰</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --line:#e8e8ee;
    --blue:#1a73e8; --dark:#111; --muted:#666;
  }
  body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial}
  .wrap{max-width:820px;margin:0 auto;padding:12px}
  h2{margin:8px 0 10px;font-size:26px}
  textarea{
    width:100%;height:160px;box-sizing:border-box;border-radius:14px;border:1px solid var(--line);
    padding:12px;font-size:14px;line-height:1.35;background:#fff
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;align-items:center}
  button{border:0;border-radius:14px;padding:12px 16px;font-size:16px;font-weight:900}
  .primary{background:var(--blue);color:#fff}
  .ghost{background:#fff;border:1px solid var(--line);color:#111}
  .danger{background:#fff;border:1px solid #f3b3b3;color:#c62828}
  .stat{
    background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px;
    font-size:16px;font-weight:900;display:flex;gap:12px;flex-wrap:wrap;align-items:center
  }
  .small{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}

  .sortbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .sortbtn{background:#fff;border:1px solid var(--line);color:#111}
  .sortbtn.on{background:var(--blue);border-color:var(--blue);color:#fff}

  .search{
    width:100%;box-sizing:border-box;margin-top:10px;
    border:1px solid var(--line);border-radius:14px;padding:10px 12px;font-size:14px;background:#fff
  }
  .list{margin-top:10px}
  .card{
    background:var(--card);border:1px solid var(--line);border-radius:18px;
    padding:14px;display:flex;justify-content:space-between;align-items:center;gap:12px;
    margin-top:10px;
  }
  .left{min-width:0;display:flex;gap:12px;align-items:flex-start}
  .no{
    background:var(--dark);color:#fff;border-radius:16px;padding:10px 14px;
    font-weight:1000;font-size:16px;line-height:1;flex:0 0 auto;white-space:nowrap
  }
  .addr{font-size:15px;font-weight:900;line-height:1.25;word-break:break-word}
  .sub{font-size:12px;color:var(--muted);margin-top:4px;font-weight:700}
  .actions{display:flex;gap:10px;align-items:center;flex:0 0 auto}
  .chk{width:22px;height:22px;transform:scale(1.15)}
  .navbtn{background:var(--blue);color:#fff;border-radius:14px;padding:12px 14px;font-weight:1000}
  .delivered{opacity:.45}

  .progress{
    margin-top:10px;background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px;
    font-size:14px;font-weight:900;color:#111;display:none
  }
  .progress.show{display:block}
</style>
</head>

<body>
<div class="wrap">
  <h2>å•ç‚¹å¯¼èˆªï¼ˆçº¯åˆ—è¡¨æœ€ç»ˆç‰ˆ + OCRï¼‰</h2>

  <textarea id="input" placeholder="æ¯è¡Œä¸€å•ï¼ˆçº¿è·¯å· ç©ºæ ¼ åœ°å€ï¼‰
ä¾‹ï¼š
7 1128 Chestnut Ridge Dr, Pittsburgh, PA
676 1228 Chestnut Ridge Dr, Pittsburgh, PA
1023 614 Chestnut Ridge Dr, Pittsburgh, PA"></textarea>

  <div class="row">
    <button class="primary" id="btnBuild">ç”Ÿæˆåˆ—è¡¨</button>
    <button class="ghost" id="btnOCR">ğŸ“· è¯†åˆ«æˆªå›¾ï¼ˆæœ€å¤š9å¼ ï¼‰</button>
    <button class="ghost" id="btnPaste">ğŸ“‹ ä»å‰ªè´´æ¿ç²˜è´´</button>
    <button class="ghost" id="btnCopyAll">å¤åˆ¶ï¼ˆå¸¦çº¿è·¯å·ï¼‰</button>
    <button class="ghost" id="btnCopyAddr">åªå¤åˆ¶åœ°å€</button>
    <button class="danger" id="btnClear">æ¸…ç©ºä»Šå¤©</button>
  </div>

  <div class="stat" id="stat">ğŸ“¦ ä»Šæ—¥å…± 0 å• ï½œ âœ… å·²é€ 0 ï½œ ğŸ•’ å‰©ä½™ 0</div>

  <div class="sortbar">
    <button class="sortbtn on" id="sortAsc">ğŸ”¼ çº¿è·¯å·å‡åº</button>
    <button class="sortbtn" id="sortDesc">ğŸ”½ çº¿è·¯å·é™åº</button>
  </div>

  <input class="search" id="search" placeholder="æœç´¢ï¼šè¾“å…¥çº¿è·¯å· / è¡—é“ / åŸå¸‚ï¼ˆä¾‹å¦‚ 7 æˆ– Chestnutï¼‰" />

  <div class="progress" id="progress"></div>

  <div class="list" id="list"></div>

  <div class="small">
    âœ… ç‚¹â€œå¯¼èˆªâ€ä¼šè‡ªåŠ¨å‹¾é€‰ã€‚<br/>
    ğŸ“Œ æ”¯æŒ 1ï½4 ä½çº¿è·¯å·ï¼›OCR ä¼šè‡ªåŠ¨ä¿®å¤ â€œ76 4 3957â€¦â€ è¿™ç§æ‹†ä½æƒ…å†µï¼ˆæ‹¼æˆ 764ï¼‰ã€‚<br/>
    âš ï¸ OCR ä¸æ˜¯ 100%ï¼šå¦‚æœæŸä¸€è¡Œè¿˜æ˜¯ä¸å¯¹ï¼Œç›´æ¥åœ¨è¾“å…¥æ¡†æ”¹é‚£ä¸€è¡Œå†ç‚¹â€œç”Ÿæˆåˆ—è¡¨â€ã€‚
  </div>
</div>

<!-- é€‰æ‹©å›¾ç‰‡ï¼ˆæœ€å¤š9å¼ ï¼‰ -->
<input id="file" type="file" accept="image/*" multiple style="display:none" />

<script>
/* ======== æ¯å¤©ç‹¬ç«‹ä¿å­˜ ======== */
function todayKey(){
  const d=new Date();
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
const K_INPUT = "rn:input:"+todayKey();
const K_DONE  = "rn:done:"+todayKey();
const K_SORT  = "rn:sort";

let doneSet = new Set(JSON.parse(localStorage.getItem(K_DONE) || "[]"));
let sortMode = localStorage.getItem(K_SORT) || "asc"; // asc / desc

let orders = []; // {id,noStr,noNum,addr,done}

/* ======== DOM ======== */
const elInput = document.getElementById('input');
const elList  = document.getElementById('list');
const elStat  = document.getElementById('stat');
const elSearch= document.getElementById('search');
const elProg  = document.getElementById('progress');
const elFile  = document.getElementById('file');

document.getElementById('btnBuild').onclick = buildList;
document.getElementById('btnClear').onclick = clearToday;
document.getElementById('btnCopyAll').onclick = ()=>copyText(makeCopyText(true));
document.getElementById('btnCopyAddr').onclick = ()=>copyText(makeCopyText(false));
document.getElementById('btnPaste').onclick = pasteFromClipboard;

document.getElementById('sortAsc').onclick  = ()=>setSort("asc");
document.getElementById('sortDesc').onclick = ()=>setSort("desc");

document.getElementById('btnOCR').onclick = ()=>{
  elFile.value = "";
  elFile.click();
};
elFile.addEventListener('change', onPickImages);

elSearch.addEventListener('input', renderList);

/* ======== æ¢å¤è¾“å…¥ ======== */
elInput.value = localStorage.getItem(K_INPUT) || "";
elInput.addEventListener('input', ()=> localStorage.setItem(K_INPUT, elInput.value));

/* ======== å·¥å…·ï¼šå­—ç¬¦ä¸²æ¸…æ´— ======== */
function normLine(s){
  return String(s)
    .replace(/[ï¼Œ]/g, ",")
    .replace(/[â€œâ€]/g, '"')
    .replace(/[â€˜â€™]/g, "'")
    .replace(/\s+/g, " ")
    .trim();
}

/* ======== å…³é”®ï¼šè§£æä¸€è¡Œï¼ˆæ”¯æŒ 1~4 ä½çº¿è·¯å· + OCRæ‹†ä½ä¿®å¤ï¼‰ ======== */
function parseOneLine(raw){
  const line = normLine(raw);
  if(!line) return null;

  // 1) å…ˆå¤„ç†å¸¸è§å‰ç¼€ï¼šNO. / No / #
  const cleaned = line.replace(/^(?:NO\.?|No\.?|#)\s*/i, "");

  // 2) OCRæ‹†ä½ä¿®å¤ï¼šä¾‹å¦‚ "76 4 3957 Windgap Ave ..."
  // è§„åˆ™ï¼šA(1~3ä½) ç©ºæ ¼ B(1ä½) ç©ºæ ¼ é—¨ç‰Œå·(>=2ä½)
  // => çº¿è·¯å· = A+Bï¼Œåœ°å€ä»é—¨ç‰Œå·å¼€å§‹ï¼ˆè·³è¿‡Bï¼‰
  let m = cleaned.match(/^(\d{1,3})\s+(\d{1})\s+(\d{2,6})\s+(.+)$/);
  if(m){
    const noStr = String(m[1]) + String(m[2]); // æ‹¼èµ·æ¥
    const addr  = (m[3] + " " + m[4]).trim();
    return { noStr, noNum: parseInt(noStr,10), addr };
  }

  // 3) æ­£å¸¸ï¼šè¡Œé¦– 1~4 ä½æ•°å­— + åˆ†éš” + åé¢å†…å®¹
  m = cleaned.match(/^(\d{1,4})[,\s]+(.+)$/);
  if(m){
    const noStr = m[1];
    let rest = m[2].trim();

    // 4) å†åšä¸€æ¬¡â€œè·³è¿‡å™ªå£°æ•°å­—â€ï¼šå¦‚æœ rest å¼€å¤´æ˜¯ 1ä½/2ä½æ•°å­—(åƒ OCR å™ªå£°)ï¼Œä¸”åé¢è¿˜æœ‰ >=2ä½é—¨ç‰Œå·ï¼Œåˆ™è·³è¿‡è¿™ä¸ªå™ªå£°
    // ä¾‹ï¼š "4 3957 Windgap Ave" -> ä¸¢æ‰ 4ï¼Œä¿ç•™ 3957...
    // ä½†å¦‚æœæœ¬æ¥å°±æ˜¯ "10 Downing St" (é—¨ç‰Œå·=10) è¿™ç§ï¼Œä¸åº”è¯¥ä¸¢
    const mNoise = rest.match(/^(\d{1,2})\s+(\d{2,6}\s+.+)$/);
    if(mNoise){
      // åªæœ‰å½“ç¬¬ä¸€æ®µæ˜¯ 1ä½/2ä½ä¸”ç¬¬äºŒæ®µæ˜¯ >=2ä½é—¨ç‰Œå·ï¼Œæ‰ä¸¢ç¬¬ä¸€æ®µ
      rest = mNoise[2].trim();
    }

    return { noStr, noNum: parseInt(noStr,10), addr: rest };
  }

  // 5) æ²¡æœ‰çº¿è·¯å·ï¼šç»™è‡ªåŠ¨å·ï¼ˆæ’æœ€åï¼‰
  return { noStr: "A", noNum: Number.MAX_SAFE_INTEGER, addr: cleaned };
}

/* ======== è§£æå¤šè¡Œ ======== */
function parseLines(text){
  const lines = String(text||"").split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const out = [];
  let auto = 1;
  for(const raw of lines){
    const r = parseOneLine(raw);
    if(!r) continue;
    // ç»™æ²¡æœ‰å·çš„è¡¥ A001 / A002...
    if(r.noStr==="A"){
      r.noStr = "A" + String(auto++).padStart(3,"0");
      r.noNum = Number.MAX_SAFE_INTEGER - 10000 + auto;
    }
    out.push(r);
  }
  return out;
}

/* ======== æ’åº ======== */
function setSort(mode){
  sortMode = mode;
  localStorage.setItem(K_SORT, sortMode);
  document.getElementById('sortAsc').classList.toggle('on', sortMode==="asc");
  document.getElementById('sortDesc').classList.toggle('on', sortMode==="desc");
  renderAll();
}
function sortOrders(arr){
  const a = arr.slice();
  a.sort((x,y)=> sortMode==="asc" ? (x.noNum - y.noNum) : (y.noNum - x.noNum));
  return a;
}

/* ======== æ„å»ºåˆ—è¡¨ ======== */
function buildList(){
  const parsed = parseLines(elInput.value || "");
  const old = new Map(orders.map(o=>[o.id,o]));
  orders = parsed.map(p=>{
    const id = p.noStr + "||" + p.addr;
    const was = old.get(id);
    return { id, noStr:p.noStr, noNum:p.noNum, addr:p.addr, done: was ? was.done : doneSet.has(id) };
  });
  // æŠŠæ—§ doneSet é‡Œä¸å­˜åœ¨çš„æ¸…æ‰ï¼ˆé¿å…æ˜å¤©ç²˜è´´ä¸åŒå•å·å¯¼è‡´ç»Ÿè®¡é”™ï¼‰
  const nowIds = new Set(orders.map(o=>o.id));
  doneSet = new Set([...doneSet].filter(id=>nowIds.has(id)));
  saveDone();
  renderAll();
}

/* ======== ç»Ÿè®¡ ======== */
function renderStat(){
  const total = orders.length;
  const sent = orders.filter(o=>o.done).length;
  elStat.textContent = `ğŸ“¦ ä»Šæ—¥å…± ${total} å• ï½œ âœ… å·²é€ ${sent} ï½œ ğŸ•’ å‰©ä½™ ${total - sent}`;
}

/* ======== åˆ—è¡¨æ¸²æŸ“ ======== */
function renderList(){
  elList.innerHTML = "";
  const q = (elSearch.value || "").trim().toLowerCase();
  let view = sortOrders(orders);
  if(q) view = view.filter(o => (o.noStr+" "+o.addr).toLowerCase().includes(q));

  view.forEach(o=>{
    const card = document.createElement('div');
    card.className = "card" + (o.done ? " delivered" : "");
    card.innerHTML = `
      <div class="left">
        <div class="no">NO.${escapeHtml(o.noStr)}</div>
        <div style="min-width:0">
          <div class="addr">${escapeHtml(o.addr)}</div>
          <div class="sub">ç‚¹å¯¼èˆªè‡ªåŠ¨âœ… ï½œ å¯å‡åº/é™åº</div>
        </div>
      </div>
      <div class="actions">
        <input class="chk" type="checkbox" ${o.done?"checked":""} />
        <button class="navbtn">â–¶ å¯¼èˆª</button>
      </div>
    `;

    card.querySelector('input').addEventListener('change', (e)=>{
      o.done = e.target.checked;
      if(o.done) doneSet.add(o.id); else doneSet.delete(o.id);
      saveDone();
      renderAll();
    });

    card.querySelector('.navbtn').addEventListener('click', ()=> startNav(o));
    elList.appendChild(card);
  });

  renderStat();
}
function renderAll(){ renderStat(); renderList(); }

/* ======== å·²é€å­˜å‚¨ ======== */
function saveDone(){ localStorage.setItem(K_DONE, JSON.stringify([...doneSet])); }

/* ======== å¯¼èˆªï¼šGoogle Maps ======== */
function startNav(o){
  if(!o.done){
    o.done = true;
    doneSet.add(o.id);
    saveDone();
    renderAll();
  }
  const url = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(o.addr) + "&travelmode=driving";
  window.location.href = url;
}

/* ======== å¤åˆ¶ ======== */
function makeCopyText(withNo){
  const view = sortOrders(orders);
  return withNo ? view.map(o=>`${o.noStr} ${o.addr}`).join("\n")
                : view.map(o=>o.addr).join("\n");
}
async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); alert("å·²å¤åˆ¶ âœ…"); }
  catch(e){
    const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove(); alert("å·²å¤åˆ¶ âœ…");
  }
}

/* ======== å‰ªè´´æ¿ç²˜è´´ ======== */
async function pasteFromClipboard(){
  try{
    const t = await navigator.clipboard.readText();
    if(!t) return alert("å‰ªè´´æ¿ä¸ºç©º");
    elInput.value = (elInput.value ? (elInput.value.trim()+"\n") : "") + t.trim() + "\n";
    localStorage.setItem(K_INPUT, elInput.value);
    buildList();
  }catch(e){
    alert("æ— æ³•è¯»å–å‰ªè´´æ¿ï¼šè¯·åœ¨ Safari å…è®¸å‰ªè´´æ¿æƒé™ï¼Œæˆ–æ‰‹åŠ¨ç²˜è´´åˆ°è¾“å…¥æ¡†ã€‚");
  }
}

/* ======== æ¸…ç©ºä»Šå¤© ======== */
function clearToday(){
  if(!confirm("ç¡®å®šæ¸…ç©ºä»Šå¤©å†…å®¹å’Œå·²é€è®°å½•ï¼Ÿ")) return;
  elInput.value = "";
  orders = [];
  doneSet = new Set();
  localStorage.removeItem(K_INPUT);
  localStorage.removeItem(K_DONE);
  renderAll();
}

/* ======== OCRï¼šæœ€å¤š 9 å¼  ======== */
function showProg(msg){
  elProg.textContent = msg;
  elProg.classList.add('show');
}
function hideProg(){
  elProg.classList.remove('show');
}

async function onPickImages(e){
  const files = [...(e.target.files||[])];
  if(!files.length) return;
  if(files.length > 9){
    alert("æœ€å¤šé€‰ 9 å¼ å›¾ã€‚ä½ é€‰äº† "+files.length+" å¼ ï¼Œæˆ‘åªå¤„ç†å‰ 9 å¼ ã€‚");
  }
  const use = files.slice(0,9);

  let allLines = [];
  for(let i=0;i<use.length;i++){
    const f = use[i];
    showProg(`OCR è¯†åˆ«ä¸­ï¼šç¬¬ ${i+1}/${use.length} å¼ â€¦ï¼ˆç¬¬ä¸€æ¬¡å¯èƒ½æ…¢ï¼‰`);
    const text = await ocrOne(f);
    const lines = textToLines(text);
    allLines.push(...lines);
  }
  hideProg();

  // æŠŠOCRç»“æœè¿½åŠ åˆ°è¾“å…¥æ¡†
  const add = allLines.join("\n").trim();
  if(add){
    elInput.value = (elInput.value ? (elInput.value.trim()+"\n") : "") + add + "\n";
    localStorage.setItem(K_INPUT, elInput.value);
    buildList();
  }else{
    alert("æ²¡æœ‰è¯†åˆ«åˆ°å¯ç”¨æ–‡å­—ã€‚å»ºè®®æ¢æ›´æ¸…æ™°æˆªå›¾ï¼ˆæ”¾å¤§åæˆªï¼‰ã€‚");
  }
}

/* OCR å•å›¾ */
async function ocrOne(file){
  const imgUrl = await fileToDataURL(file);
  const { data:{ text } } = await Tesseract.recognize(imgUrl, "eng", {
    logger: m => {
      if(m.status === "recognizing text"){
        showProg(`OCR è¯†åˆ«ä¸­â€¦ ${Math.round(m.progress*100)}%`);
      }
    }
  });
  return text || "";
}
function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.onerror=rej;
    r.readAsDataURL(file);
  });
}

/* æŠŠ OCR æ–‡æœ¬å˜æˆâ€œæ¯è¡Œä¸€å•â€çš„å€™é€‰è¡Œ */
function textToLines(text){
  // å¸¸è§ä¿®æ­£ï¼šæŠŠå¥‡æ€ªåˆ†éš”å˜ç©ºæ ¼
  const t = String(text||"")
    .replace(/\r/g,"\n")
    .replace(/[|]/g," ")
    .replace(/[ï¼Œ]/g,",")
    .replace(/\s+/g," ")
    .replace(/\n\s*\n/g,"\n");

  // æŒ‰è¡Œåˆ‡ï¼›ä¿ç•™å¯èƒ½æœ‰ç”¨çš„è¡Œï¼ˆå«æ•°å­—ï¼‰
  const rawLines = t.split("\n").map(s=>s.trim()).filter(Boolean);

  const out = [];
  for(const s of rawLines){
    // å¿…é¡»å«æ•°å­—ï¼ˆçº¿è·¯å·/é—¨ç‰Œå·ï¼‰
    if(!/\d/.test(s)) continue;

    // æœ‰äº› OCR ä¼šæŠŠä¸€è¡Œæ‹†æˆä¸¤è¡Œï¼šçº¿è·¯å·è¡Œ + åœ°å€è¡Œ
    // è¿™é‡Œå…ˆåŸæ ·æ¨å…¥ï¼ŒparseOneLine ä¼šå°½é‡ä¿®å¤
    out.push(s);
  }
  return out;
}

/* ======== å®‰å…¨è¾“å‡º ======== */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

/* ======== åˆå§‹åŒ– ======== */
(function init(){
  document.getElementById('sortAsc').classList.toggle('on', sortMode==="asc");
  document.getElementById('sortDesc').classList.toggle('on', sortMode==="desc");
  buildList();
})();
</script>
</body>
</html>
