<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>å•ç‚¹å¯¼èˆªï¼ˆçº¯åˆ—è¡¨æœ€ç»ˆç‰ˆ + OCRï¼‰</title>

<!-- Tesseract.js (OCR) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --line:#e8e8ee;
    --blue:#1a73e8; --dark:#111; --muted:#666;
    --green:#1bbf5c;
  }
  body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial}
  .wrap{max-width:820px;margin:0 auto;padding:12px}
  h2{margin:8px 0 10px;font-size:26px}
  textarea{
    width:100%;height:150px;box-sizing:border-box;border-radius:14px;border:1px solid var(--line);
    padding:12px;font-size:14px;line-height:1.35;background:#fff
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;align-items:center}
  button{border:0;border-radius:14px;padding:12px 16px;font-size:16px;font-weight:900}
  .primary{background:var(--blue);color:#fff}
  .ghost{background:#fff;border:1px solid var(--line);color:#111}
  .danger{background:#fff;border:1px solid #ffb3b3;color:#b71c1c}
  .stat{
    background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px;
    font-size:16px;font-weight:900;display:flex;gap:12px;flex-wrap:wrap;align-items:center
  }
  .small{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
  .small strong{color:#111}

  /* æ’åº */
  .sortbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .sortbtn{background:#fff;border:1px solid var(--line);color:#111}
  .sortbtn.on{background:var(--blue);border-color:var(--blue);color:#fff}

  /* åˆ—è¡¨ */
  .search{
    width:100%;box-sizing:border-box;margin-top:10px;
    border:1px solid var(--line);border-radius:14px;padding:10px 12px;font-size:14px;background:#fff
  }
  .list{margin-top:10px}
  .card{
    background:var(--card);border:1px solid var(--line);border-radius:18px;
    padding:14px;display:flex;justify-content:space-between;align-items:center;gap:12px;
    margin-top:10px;
  }
  .left{min-width:0;display:flex;gap:12px;align-items:flex-start}
  .no{
    background:var(--dark);color:#fff;border-radius:14px;padding:10px 12px;
    font-weight:1000;font-size:16px;line-height:1;box-shadow:0 8px 18px rgba(0,0,0,.15);
    flex:0 0 auto
  }
  .addr{font-size:15px;font-weight:900;line-height:1.25;word-break:break-word}
  .sub{font-size:12px;color:var(--muted);margin-top:4px;font-weight:700}
  .actions{display:flex;gap:10px;align-items:center;flex:0 0 auto}
  .chk{width:22px;height:22px;transform:scale(1.15)}
  .navbtn{background:var(--blue);color:#fff;border-radius:14px;padding:12px 14px;font-weight:1000}
  .editbtn{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 12px;font-weight:900}
  .delivered{opacity:.45}

  .hintBox{
    background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px;margin-top:10px;
    font-size:13px;color:#333;line-height:1.35
  }

  /* OCR */
  .ocrRow{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;align-items:center}
  #file{display:none}
  .pill{
    background:#fff;border:1px solid var(--line);border-radius:999px;padding:8px 12px;font-weight:900
  }
  .progress{
    margin-top:8px;font-size:12px;color:#333;
    background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px 10px;
  }
</style>
</head>

<body>
<div class="wrap">
  <h2>å•ç‚¹å¯¼èˆªï¼ˆçº¯åˆ—è¡¨æœ€ç»ˆç‰ˆ + OCRï¼‰</h2>

  <textarea id="input" placeholder="æ–¹å¼1ï¼šæ‰‹åŠ¨ç²˜è´´ï¼ˆæ¯è¡Œä¸€å•ï¼šçº¿è·¯å· ç©ºæ ¼ åœ°å€ï¼‰
ä¾‹ï¼š
676 1128 Chestnut Ridge Dr, Pittsburgh, PA
677 1228 Chestnut Ridge Dr, Pittsburgh, PA

æ–¹å¼2ï¼šç‚¹â€œè¯†åˆ«æˆªå›¾ï¼ˆæœ€å¤š9å¼ ï¼‰â€è‡ªåŠ¨æå–"></textarea>

  <div class="row">
    <button class="primary" id="btnBuild">ç”Ÿæˆåˆ—è¡¨</button>

    <button class="ghost" id="btnOcrPick">ğŸ“· è¯†åˆ«æˆªå›¾ï¼ˆæœ€å¤š9å¼ ï¼‰</button>
    <input id="file" type="file" accept="image/*" multiple />

    <button class="ghost" id="btnPaste">ğŸ“‹ ä»å‰ªè´´æ¿ç²˜è´´</button>
    <button class="ghost" id="btnCopyAll">å¤åˆ¶ï¼ˆå¸¦çº¿è·¯å·ï¼‰</button>
    <button class="ghost" id="btnCopyAddr">åªå¤åˆ¶åœ°å€</button>
    <button class="danger" id="btnClear">æ¸…ç©ºä»Šå¤©</button>
  </div>

  <div class="stat" id="stat">ğŸ“¦ ä»Šæ—¥å…± 0 å• ï½œ âœ… å·²é€ 0 ï½œ ğŸ•’ å‰©ä½™ 0</div>

  <div class="sortbar">
    <button class="sortbtn on" id="sortAsc">ğŸ”¼ çº¿è·¯å·å‡åº</button>
    <button class="sortbtn" id="sortDesc">ğŸ”½ çº¿è·¯å·é™åº</button>
  </div>

  <input class="search" id="search" placeholder="æœç´¢ï¼šè¾“å…¥çº¿è·¯å· / è¡—é“ / åŸå¸‚ï¼ˆä¾‹å¦‚ 676 æˆ– Chestnutï¼‰" />
  <div class="progress" id="progress">æç¤ºï¼šOCR å»ºè®®æ¯å¼ æˆªå›¾ 6â€“10 å•æ›´å‡†ï¼›é•¿æˆªå›¾ä¹Ÿä¼šè‡ªåŠ¨åˆ‡ç‰‡å¤„ç†ã€‚</div>

  <div class="list" id="list"></div>

  <div class="hintBox">
    <div><strong>è¯´æ˜ï¼š</strong>ç‚¹â€œå¯¼èˆªâ€ä¼šè‡ªåŠ¨âœ…ï¼›ç¬¬äºŒå¤©çº¿è·¯å·å˜äº†æ²¡å…³ç³»ï¼Œç²˜è´´å½“å¤©/è¯†åˆ«å½“å¤©å³å¯ã€‚</div>
    <div>å¦‚æœæŸæ¡ OCR ä»ç„¶æœ‰è¯¯ï¼šç‚¹ <strong>âœï¸</strong> å¯ä»¥æ‰‹åŠ¨æ”¹çº¿è·¯å·/åœ°å€ã€‚</div>
  </div>
</div>

<script>
/* ========= æ¯å¤©ç‹¬ç«‹å­˜å‚¨ ========= */
function todayKey(){
  const d=new Date();
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
const K_INPUT = "rn:input:"+todayKey();
const K_DONE  = "rn:done:"+todayKey();
const K_SORT  = "rn:sort"; // è®°ä½å‡/é™

let doneSet = new Set(JSON.parse(localStorage.getItem(K_DONE) || "[]"));
let sortMode = localStorage.getItem(K_SORT) || "asc"; // asc / desc

/* ========= æ•°æ® ========= */
let orders = []; // {id,noStr,noNum,addr,done}

/* ========= DOM ========= */
const elInput = document.getElementById('input');
const elList  = document.getElementById('list');
const elStat  = document.getElementById('stat');
const elSearch= document.getElementById('search');
const elProgress = document.getElementById('progress');
const elFile = document.getElementById('file');

document.getElementById('btnBuild').onclick = buildList;
document.getElementById('btnClear').onclick = clearToday;
document.getElementById('btnCopyAll').onclick = ()=>copyText(makeCopyText(true));
document.getElementById('btnCopyAddr').onclick = ()=>copyText(makeCopyText(false));
document.getElementById('btnPaste').onclick = pasteFromClipboard;

document.getElementById('sortAsc').onclick  = ()=>setSort("asc");
document.getElementById('sortDesc').onclick = ()=>setSort("desc");

document.getElementById('btnOcrPick').onclick = ()=>{
  elFile.value = "";
  elFile.click();
};
elFile.addEventListener('change', async ()=>{
  const files = Array.from(elFile.files || []);
  if(!files.length) return;
  if(files.length > 9){
    alert("æœ€å¤šé€‰ 9 å¼ å›¾ã€‚è¯·åˆ†ä¸¤æ¬¡è¯†åˆ«ã€‚");
    return;
  }
  await ocrImages(files);
});

elSearch.addEventListener('input', renderList);

/* ========= æ¢å¤è¾“å…¥ ========= */
elInput.value = localStorage.getItem(K_INPUT) || "";
elInput.addEventListener('input', ()=> localStorage.setItem(K_INPUT, elInput.value));

/* ========= è§£ææ‰‹åŠ¨è¾“å…¥ï¼šæ”¯æŒ 1~4 ä½å· ========= */
function parseLines(text){
  const lines = text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const out = [];
  let auto = 1;
  for(const line of lines){
    // æ”¯æŒï¼šNO.676 / 676, / 676 ç©ºæ ¼
    const m = line.match(/^(?:NO\.?\s*)?(\d{1,4})[,\sï¼Œ]+(.+)$/i);
    if(m){
      out.push({noStr: m[1], noNum: parseInt(m[1],10), addr: cleanupAddr(m[2].trim())});
    }else{
      // æ²¡æœ‰æ•°å­—å·ï¼šç»™ä¸€ä¸ª A001ï¼ˆæ’åœ¨æœ€åï¼‰
      const noStr = "A"+String(auto++).padStart(3,'0');
      out.push({noStr, noNum: 999999 + auto, addr: cleanupAddr(line)});
    }
  }
  return out.filter(x=>x.addr);
}

/* ========= æ¸…ç†åœ°å€ï¼ˆå»æ‰å¥‡æ€ªç¬¦å·/å¤šä½™ç©ºæ ¼ï¼‰ ========= */
function cleanupAddr(s){
  let t = String(s||"");
  t = t.replace(/\s+/g," ").trim();
  t = t.replace(/\s*,\s*/g, ", ");
  t = t.replace(/,\s*(PA)\b/i, ", PA");
  t = t.replace(/\bPENN\b/i, "PA");
  return t;
}

/* ========= åœ°å€æœ‰æ•ˆæ€§ï¼ˆè¿‡æ»¤å™ªéŸ³ï¼‰ ========= */
function isLikelyUSAddress(s){
  const t = String(s||"");
  // å¿…é¡»æœ‰è·¯ååç¼€ + è‡³å°‘æœ‰ PA æˆ– Pittsburghï¼ˆä½ è¿™è¾¹åŸºæœ¬éƒ½æ˜¯ Pittsburgh, PAï¼‰
  const suffix = /\b(St|Street|Ave|Avenue|Rd|Road|Dr|Drive|Ln|Lane|Blvd|Boulevard|Ct|Court|Pl|Place|Way|Pkwy|Parkway|Ter|Terrace|Cir|Circle|Hwy|Highway)\b/i;
  const hasNum = /\b\d{1,6}\b/.test(t);
  const hasPAorCity = /\b(PA|Pittsburgh|McKees\s*Rocks|Crafton|Rosslyn)\b/i.test(t);
  return hasNum && suffix.test(t) && hasPAorCity;
}

/* ========= æ’åº ========= */
function setSort(mode){
  sortMode = mode;
  localStorage.setItem(K_SORT, sortMode);
  document.getElementById('sortAsc').classList.toggle('on', sortMode==="asc");
  document.getElementById('sortDesc').classList.toggle('on', sortMode==="desc");
  renderAll();
}
function sortOrders(arr){
  const a = arr.slice();
  a.sort((x,y)=>{
    // Axxx æ”¾æœ€å
    const ax = (x.noStr||"").startsWith("A");
    const ay = (y.noStr||"").startsWith("A");
    if(ax && !ay) return 1;
    if(!ax && ay) return -1;

    if(sortMode==="asc") return x.noNum - y.noNum;
    return y.noNum - x.noNum;
  });
  return a;
}

/* ========= æ„å»ºåˆ—è¡¨ ========= */
function buildList(){
  const parsed = parseLines(elInput.value || "");
  const old = new Map(orders.map(o=>[o.id,o]));

  orders = parsed.map(p=>{
    const id = p.noStr + "||" + p.addr;   // å”¯ä¸€é”®ï¼ˆå½“å¤©ï¼‰
    const was = old.get(id);
    return {
      id,
      noStr: p.noStr,
      noNum: p.noNum,
      addr: p.addr,
      done: was ? was.done : doneSet.has(id),
    };
  });

  // åŒæ­¥ doneSetï¼šåªä¿ç•™å½“å¤©ä»å­˜åœ¨çš„
  const validIds = new Set(orders.map(o=>o.id));
  doneSet = new Set([...doneSet].filter(id=>validIds.has(id)));
  saveDone();

  renderAll();
}

/* ========= ç»Ÿè®¡ ========= */
function renderStat(){
  const total = orders.length;
  const sent = orders.filter(o=>o.done).length;
  elStat.textContent = `ğŸ“¦ ä»Šæ—¥å…± ${total} å• ï½œ âœ… å·²é€ ${sent} ï½œ ğŸ•’ å‰©ä½™ ${total - sent}`;
}

/* ========= åˆ—è¡¨æ¸²æŸ“ ========= */
function renderList(){
  elList.innerHTML = "";
  const q = (elSearch.value || "").trim().toLowerCase();

  let view = sortOrders(orders);
  if(q){
    view = view.filter(o => (o.noStr+" "+o.addr).toLowerCase().includes(q));
  }

  view.forEach(o=>{
    const card = document.createElement('div');
    card.className = "card" + (o.done ? " delivered" : "");
    card.innerHTML = `
      <div class="left">
        <div class="no">NO.${escapeHtml(o.noStr)}</div>
        <div style="min-width:0">
          <div class="addr">${escapeHtml(o.addr)}</div>
          <div class="sub">ç‚¹å¯¼èˆªè‡ªåŠ¨âœ…ï½œå¯æ‰‹åŠ¨æ”¹ï½œå¯å‡åº/é™åº</div>
        </div>
      </div>
      <div class="actions">
        <button class="editbtn" title="ç¼–è¾‘">âœï¸</button>
        <input class="chk" type="checkbox" ${o.done?"checked":""} />
        <button class="navbtn">â–¶ å¯¼èˆª</button>
      </div>
    `;

    // ç¼–è¾‘
    card.querySelector('.editbtn').addEventListener('click', ()=>{
      const newNo = prompt("ä¿®æ”¹çº¿è·¯å·ï¼ˆ1~4ä½æ•°å­—ï¼‰", o.noStr);
      if(newNo === null) return;
      const nn = String(newNo).trim();
      if(!/^\d{1,4}$/.test(nn)){
        alert("çº¿è·¯å·å¿…é¡»æ˜¯ 1~4 ä½æ•°å­—ã€‚");
        return;
      }
      const newAddr = prompt("ä¿®æ”¹åœ°å€", o.addr);
      if(newAddr === null) return;
      const na = cleanupAddr(newAddr.trim());
      if(!na){
        alert("åœ°å€ä¸èƒ½ä¸ºç©ºã€‚");
        return;
      }
      // æ›´æ–°è¿™æ¡
      const oldId = o.id;
      o.noStr = nn;
      o.noNum = parseInt(nn,10);
      o.addr = na;
      o.id = o.noStr + "||" + o.addr;

      // doneSet è¿ç§»
      const wasDone = doneSet.has(oldId) || o.done;
      doneSet.delete(oldId);
      if(wasDone){
        doneSet.add(o.id);
        o.done = true;
      }

      saveDone();
      // åŒæ­¥è¾“å…¥æ¡†
      elInput.value = sortOrders(orders).map(x=>`${x.noStr} ${x.addr}`).join("\n");
      localStorage.setItem(K_INPUT, elInput.value);
      renderAll();
    });

    // å‹¾é€‰
    card.querySelector('input').addEventListener('change', (e)=>{
      o.done = e.target.checked;
      if(o.done) doneSet.add(o.id);
      else doneSet.delete(o.id);
      saveDone();
      renderAll();
    });

    // å¯¼èˆª
    card.querySelector('.navbtn').addEventListener('click', ()=>{
      startNav(o);
    });

    elList.appendChild(card);
  });

  renderStat();
}

function renderAll(){
  renderStat();
  renderList();
}

/* ========= å·²é€å­˜å‚¨ ========= */
function saveDone(){
  localStorage.setItem(K_DONE, JSON.stringify([...doneSet]));
}

/* ========= å¯¼èˆªï¼šGoogle Maps ========= */
function startNav(o){
  // è‡ªåŠ¨âœ…
  if(!o.done){
    o.done = true;
    doneSet.add(o.id);
    saveDone();
    renderAll();
  }
  const url = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(o.addr) + "&travelmode=driving";
  window.location.href = url;
}

/* ========= å¤åˆ¶ï¼ˆå¸¦å·/ä¸å¸¦å·ï¼‰ ========= */
function makeCopyText(withNo){
  const view = sortOrders(orders);
  if(withNo){
    return view.map(o=>`${o.noStr} ${o.addr}`).join("\n");
  }
  return view.map(o=>o.addr).join("\n");
}

async function copyText(txt){
  try{
    await navigator.clipboard.writeText(txt);
    alert("å·²å¤åˆ¶ âœ…");
  }catch(e){
    const ta = document.createElement('textarea');
    ta.value = txt;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    alert("å·²å¤åˆ¶ âœ…");
  }
}

/* ========= å‰ªè´´æ¿ç²˜è´´ï¼ˆiOS Safari å¯èƒ½å¼¹æƒé™ï¼‰ ========= */
async function pasteFromClipboard(){
  try{
    const t = await navigator.clipboard.readText();
    if(!t){ alert("å‰ªè´´æ¿æ²¡æœ‰å†…å®¹"); return; }
    elInput.value = (elInput.value ? (elInput.value.trim()+"\n") : "") + t.trim() + "\n";
    localStorage.setItem(K_INPUT, elInput.value);
    buildList();
  }catch(e){
    alert("æ— æ³•è¯»å–å‰ªè´´æ¿ï¼ˆiPhone æœ‰æ—¶éœ€è¦åœ¨è¾“å…¥æ¡†é‡Œé•¿æŒ‰ç²˜è´´ï¼‰");
  }
}

/* ========= æ¸…ç©ºä»Šå¤© ========= */
function clearToday(){
  if(!confirm("ç¡®å®šæ¸…ç©ºä»Šå¤©çš„æ•°æ®å—ï¼Ÿ")) return;
  elInput.value = "";
  localStorage.removeItem(K_INPUT);
  localStorage.removeItem(K_DONE);
  doneSet = new Set();
  orders = [];
  elSearch.value = "";
  elProgress.textContent = "å·²æ¸…ç©ºä»Šå¤© âœ…";
  renderAll();
}

/* =========================
   OCRï¼šé•¿å›¾åˆ‡ç‰‡ + å—è§£æ
   ========================= */

async function ocrImages(files){
  elProgress.textContent = "OCR å‡†å¤‡ä¸­â€¦ï¼ˆç¬¬ä¸€æ¬¡ä¼šæ…¢ï¼‰";
  try{
    const allPairs = [];

    for(let i=0;i<files.length;i++){
      elProgress.textContent = `OCR ç¬¬ ${i+1}/${files.length} å¼ ï¼šé¢„å¤„ç†â€¦`;

      const baseCanvas = await preprocessImageToCanvas(files[i]);
      const slices = sliceCanvas(baseCanvas, 1400, 220); // æ¯ç‰‡ 1400pxï¼Œé«˜åº¦é‡å  220px

      let mergedText = "";
      for(let s=0;s<slices.length;s++){
        elProgress.textContent = `OCR ç¬¬ ${i+1}/${files.length} å¼ ï¼šåˆ‡ç‰‡ ${s+1}/${slices.length}â€¦`;
        const { data } = await Tesseract.recognize(
          slices[s],
          "eng",
          {
            logger: m=>{
              if(m.status==="recognizing text"){
                const pct=Math.round((m.progress||0)*100);
                elProgress.textContent = `OCR ç¬¬ ${i+1}/${files.length} å¼ ï¼šåˆ‡ç‰‡ ${s+1}/${slices.length}ï¼ˆ${pct}%ï¼‰`;
              }
            },
            // é€‚åˆâ€œå¡ç‰‡åˆ—è¡¨â€çš„æ’ç‰ˆ
            tessedit_pageseg_mode: Tesseract.PSM.SPARSE_TEXT,
            preserve_interword_spaces: "1"
          }
        );
        mergedText += "\n" + ((data && data.text) ? data.text : "");
      }

      const pairs = extractByBlocks(mergedText);
      allPairs.push(...pairs);
    }

    // å»é‡
    const seen = new Set();
    const uniq = [];
    for(const p of allPairs){
      const k = p.noStr + "||" + p.addr.toLowerCase();
      if(seen.has(k)) continue;
      seen.add(k);
      uniq.push(p);
    }

    if(!uniq.length){
      elProgress.textContent = "OCR å®Œæˆï¼Œä½†æ²¡æå–åˆ°æœ‰æ•ˆåœ°å€ï¼ˆå»ºè®®æˆªå›¾æ›´æ¸…æ™°/æ¯å¼ å°‘ä¸€ç‚¹æ¡ç›®ï¼‰";
      alert("æ²¡æå–åˆ°æœ‰æ•ˆâ€œçº¿è·¯å· + åœ°å€â€ã€‚å»ºè®®æ¯å¼ æˆªå›¾ 6â€“10 å•æ›´å‡†ã€‚");
      return;
    }

    elInput.value = uniq.map(x=>`${x.noStr} ${x.addr}`).join("\n");
    localStorage.setItem(K_INPUT, elInput.value);

    elProgress.textContent = `OCR å®Œæˆ âœ… æå–åˆ° ${uniq.length} æ¡ï¼ˆå·²è¿‡æ»¤å™ªéŸ³ï¼‰`;
    buildList();
  }catch(e){
    console.error(e);
    elProgress.textContent = "OCR å‡ºé”™äº†ï¼ˆå¯èƒ½å›¾ç‰‡å¤ªå¤§/ç½‘ç»œ/CDNï¼‰";
    alert("OCR å‡ºé”™ï¼šè¯·åˆ†ä¸¤æ¬¡è¯†åˆ«ï¼ˆæ¯æ¬¡ 4~6 å¼ ï¼‰æˆ–æ¢æ›´å°æˆªå›¾ã€‚");
  }
}

function sliceCanvas(canvas, sliceH=1400, overlap=200){
  const w = canvas.width, h = canvas.height;
  const out = [];
  let y = 0;
  while(y < h){
    const top = Math.max(0, y - (y===0?0:overlap));
    const bottom = Math.min(h, y + sliceH);
    const sh = bottom - top;

    const c = document.createElement("canvas");
    c.width = w; c.height = sh;
    const ctx = c.getContext("2d");
    ctx.drawImage(canvas, 0, top, w, sh, 0, 0, w, sh);
    out.push(c);

    if(bottom >= h) break;
    y += sliceH;
  }
  return out;
}

/* é¢„å¤„ç†ï¼šæ”¾å¤§ + ç°åº¦ + æé«˜å¯¹æ¯”ï¼ˆå‡å°‘ä¹±ç ï¼‰ */
function preprocessImageToCanvas(file){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    img.onload = ()=>{
      // æ”¾å¤§ 1.6 å€ï¼ˆé•¿æˆªå›¾å¤ªç»†æ—¶å¾ˆæœ‰ç”¨ï¼‰
      const scale = 1.6;
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);

      const canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);

      // ç®€å•ç°åº¦+å¯¹æ¯”
      const im = ctx.getImageData(0,0,w,h);
      const d = im.data;
      for(let i=0;i<d.length;i+=4){
        const r=d[i], g=d[i+1], b=d[i+2];
        let y = (0.299*r + 0.587*g + 0.114*b);

        // å¯¹æ¯”åº¦å¢å¼º
        y = (y-128)*1.25 + 128;

        // è½»å¾®é˜ˆå€¼ï¼ˆä¸è¦å¤ªç¡¬ï¼‰
        const v = y > 170 ? 255 : (y < 80 ? 0 : y);

        d[i]=d[i+1]=d[i+2]=v;
      }
      ctx.putImageData(im,0,0);

      resolve(canvas);
    };
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}

/*
  å—è§£æï¼ˆå…³é”®ï¼‰ï¼š
  - åœ¨ OCR æ–‡æœ¬é‡Œæ‰¾â€œåƒè·¯çº¿å·çš„è¡Œâ€ï¼šNO.805 / 805 / 80 5 / 8 0 5
  - åœ¨å®ƒåé¢çš„å‡ è¡Œé‡ŒæŒ‘æœ€åƒç¾å›½åœ°å€çš„ä¸€è¡Œï¼ˆå« St/Ave/Rd... + PA/Pittsburghï¼‰
*/
function extractByBlocks(raw){
  const lines = String(raw||"")
    .replace(/\u00A0/g," ")
    .split(/\n+/)
    .map(x=>x.trim())
    .filter(Boolean);

  const out = [];

  function normalizeRouteNo(s){
    let t = s.toUpperCase().replace(/^NO\.?\s*/,"").trim();
    // å¦‚æœè¿™ä¸€è¡Œæœ‰å¾ˆå¤šå­—ç¬¦ï¼Œåªå–æœ€å‰é¢çš„ 8 ä¸ªå­—ç¬¦åšåˆ¤æ–­ï¼ˆé¿å…æŠŠâ€œ4.0è‹±é‡Œâ€ä¹‹ç±»å¸¦è¿›å»ï¼‰
    t = t.slice(0, 12);

    // æŠŠä¸­é—´ç©ºæ ¼çš„æ•°å­—è¿èµ·æ¥ï¼ˆæœ€å¤š4ä½ï¼‰
    const nums = t.match(/\d/g);
    if(nums && nums.length>=1 && nums.length<=4){
      const joined = nums.join("");
      if(/^\d{1,4}$/.test(joined)) return joined.replace(/^0+/,"") || "0";
    }
    // ç›´æ¥å–å¼€å¤´ 1~4 ä½
    const m = t.match(/^(\d{1,4})$/);
    return m ? m[1] : null;
  }

  function pickAddress(blockLines){
    // åœ¨ä¸€ä¸ªå—é‡ŒæŒ‘æœ€åƒåœ°å€çš„ä¸€è¡Œ
    const suffix = /\b(St|Street|Ave|Avenue|Rd|Road|Dr|Drive|Ln|Lane|Blvd|Boulevard|Ct|Court|Pl|Place|Way|Pkwy|Parkway|Ter|Terrace|Cir|Circle|Hwy|Highway)\b/i;
    const hasPA = /\b(PA|PENN|PENNSYLVANIA)\b/i;
    const hasCity = /\bPittsburgh\b/i;

    // ä¼˜å…ˆï¼šPittsburgh + PA + è·¯ååç¼€
    for(const s of blockLines){
      if(hasCity.test(s) && hasPA.test(s) && suffix.test(s) && /\b\d{1,6}\b/.test(s)){
        const a = cleanupAddr(s);
        return isLikelyUSAddress(a) ? a : null;
      }
    }
    // æ¬¡ä¼˜ï¼šPA + è·¯ååç¼€
    for(const s of blockLines){
      if(hasPA.test(s) && suffix.test(s) && /\b\d{1,6}\b/.test(s)){
        const a = cleanupAddr(s);
        return isLikelyUSAddress(a) ? a : null;
      }
    }
    // æœ€åï¼šåªè¦åƒåœ°å€ï¼ˆä¾‹å¦‚æŸäº›è¡Œæ²¡è¯†åˆ«åˆ° PAï¼‰
    for(const s of blockLines){
      const a = cleanupAddr(s);
      if(isLikelyUSAddress(a)) return a;
    }
    return null;
  }

  let i = 0;
  while(i < lines.length){
    const no = normalizeRouteNo(lines[i]);
    if(no){
      // å–åé¢æœ€å¤š 7 è¡Œå½“ä½œè¿™ä¸ªè·¯çº¿å·çš„â€œå—â€
      const block = [];
      for(let k=1;k<=7 && i+k<lines.length;k++){
        const nextNo = normalizeRouteNo(lines[i+k]);
        if(nextNo) break;
        block.push(lines[i+k]);
      }
      const addr = pickAddress(block);
      if(addr){
        out.push({noStr:no, noNum:parseInt(no,10), addr});
      }
    }
    i++;
  }

  // å»é‡
  const seen = new Set();
  return out.filter(x=>{
    const k = x.noStr+"||"+x.addr.toLowerCase();
    if(seen.has(k)) return false;
    seen.add(k); return true;
  });
}

/* ========= å®‰å…¨è¾“å‡º ========= */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

/* ========= åˆå§‹åŒ– ========= */
(function init(){
  document.getElementById('sortAsc').classList.toggle('on', sortMode==="asc");
  document.getElementById('sortDesc').classList.toggle('on', sortMode==="desc");

  buildList();
})();
</script>
</body>
</html>
