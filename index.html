<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å•ç‚¹å¯¼èˆªï¼ˆåˆ—è¡¨+åœ°å›¾ï¼‰</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --text:#111;
      --muted:#666;
      --line:#e8e8ee;
      --blue:#1a73e8;
      --blue2:#0b5bd3;
      --ok:#18a957;
      --pin:#111; /* é»‘è‰²å›¾é’‰ */
    }
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",Arial,sans-serif;color:var(--text)}
    .wrap{max-width:820px;margin:0 auto;padding:12px}
    h2{margin:6px 0 10px;font-size:22px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    textarea{
      width:100%;height:160px;box-sizing:border-box;
      border:1px solid var(--line);border-radius:12px;padding:10px;
      font-size:14px;line-height:1.35;background:#fff;
    }
    .btn{
      border:0;border-radius:12px;padding:10px 14px;font-size:15px;
      background:var(--blue);color:#fff;font-weight:700
    }
    .btn:active{background:var(--blue2)}
    .btn2{
      border:1px solid var(--line);border-radius:12px;padding:10px 14px;font-size:15px;
      background:#fff;color:#222;font-weight:700
    }
    .tabs{margin-top:10px}
    .tab{border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 12px;font-weight:800}
    .tab.on{background:#111;color:#fff;border-color:#111}
    .stat{
      margin-top:10px;background:#fff;border:1px solid var(--line);
      border-radius:12px;padding:10px 12px;font-size:16px;font-weight:800
    }
    .hint{margin:6px 0 0;color:var(--muted);font-size:12px}
    .search{
      width:100%;margin-top:10px;box-sizing:border-box;
      border:1px solid var(--line);border-radius:12px;padding:10px;font-size:14px;
    }
    .list{margin-top:10px}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:16px;
      padding:12px;display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin-top:10px;
    }
    .left{display:flex;gap:10px;align-items:flex-start;min-width:0}
    .badge{
      background:#eee;border-radius:999px;padding:5px 10px;font-size:13px;font-weight:900;white-space:nowrap
    }
    .addr{font-size:16px;font-weight:900;line-height:1.25}
    .sub{font-size:13px;color:var(--muted);margin-top:2px}
    .actions{display:flex;align-items:center;gap:10px;flex-shrink:0}
    .check{
      width:26px;height:26px;border-radius:8px;border:2px solid #c9c9d4;display:flex;align-items:center;justify-content:center;
      font-weight:900;color:#fff;background:#fff
    }
    .check.on{background:rgba(26,115,232,.15);border-color:rgba(26,115,232,.15);color:var(--blue)}
    .navbtn{
      border:0;border-radius:14px;padding:10px 14px; /* ä¸è´´è¾¹ */
      background:rgba(26,115,232,.35);color:#fff;font-weight:900;
      display:flex;align-items:center;gap:6px;
    }
    .navbtn.primary{background:var(--blue)}
    .navbtn span{font-size:16px}
    .delivered{opacity:.45}
    .view{display:none}
    .view.on{display:block}

    /* Map */
    #map{
      height:520px;border-radius:16px;border:1px solid var(--line);overflow:hidden;
      background:#ddd;margin-top:10px;
    }
    .mapbar{
      margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap
    }
    .small{font-size:12px;color:var(--muted)}
    .progress{font-size:12px;color:var(--muted);font-weight:700}

    /* é»‘è‰²ç¼–å·å›¾é’‰ï¼ˆåƒä½ å›¾ä¸€/å›¾äºŒï¼‰ */
    .pin{
      width:40px;height:40px;
      background:var(--pin);
      border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:900;font-size:14px;
      box-shadow:0 6px 16px rgba(0,0,0,.25);
      border:2px solid #fff;
    }
    .pin.del{background:var(--ok)}
    /* èšåˆåœ†åœˆæ›´åƒç³»ç»Ÿ */
    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large{
      background:transparent;
    }
    .marker-cluster div{
      background:#111 !important;
      color:#fff !important;
      border:2px solid #fff;
      box-shadow:0 6px 16px rgba(0,0,0,.25);
      font-weight:900;
    }

    /* å¼¹çª—æŒ‰é’® */
    .pop{min-width:220px}
    .pop .t{font-weight:900;font-size:16px}
    .pop .a{margin-top:4px;color:#333}
    .pop .b{
      margin-top:10px;border:0;border-radius:12px;padding:10px 12px;
      background:var(--blue);color:#fff;font-weight:900;width:100%;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h2>å•ç‚¹å¯¼èˆªï¼ˆåˆ—è¡¨+åœ°å›¾ï¼‰</h2>

    <textarea id="input" placeholder="æ¯è¡Œä¸€å•ï¼ˆå»ºè®®ï¼šè·¯çº¿å· + ç©ºæ ¼ + åœ°å€ï¼‰
ä¾‹ï¼š
705 311 Blackheath Dr, Pittsburgh, PA
706 227 Foxburg Dr, Pittsburgh, PA
NO.707 4450 Steubenville Pike, Pittsburgh, PA
"></textarea>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="buildBtn">ç”Ÿæˆåˆ—è¡¨</button>
      <button class="btn2" id="clearBtn">æ¸…ç©ºä»Šå¤©å†…å®¹</button>
    </div>

    <div class="tabs row">
      <button class="tab on" id="tabList">åˆ—è¡¨æ¨¡å¼</button>
      <button class="tab" id="tabMap">åœ°å›¾æ¨¡å¼</button>
    </div>

    <div class="stat" id="stat">ğŸ“¦ ä»Šæ—¥å…± 0 å• ï½œ å·²é€ 0 ï½œ å‰©ä½™ 0</div>
    <div class="hint">åœ°å›¾æ¨¡å¼ï¼šå…ˆç‚¹ã€Œç”Ÿæˆåœ°å›¾ç‚¹ã€â†’ ä¼šè‡ªåŠ¨æŠŠåœ°å€å®šä½æˆåœ°å›¾å›¾é’‰ï¼ˆç¬¬ä¸€æ¬¡å¯èƒ½æ…¢ï¼Œå®šä½åä¼šç¼“å­˜ï¼‰ã€‚ç‚¹å›¾é’‰â†’å¯¼èˆªâ†’è‡ªåŠ¨âœ…ã€‚</div>

    <!-- LIST VIEW -->
    <div class="view on" id="viewList">
      <input class="search" id="search" placeholder="æœç´¢ï¼šè¾“å…¥è·¯çº¿å· / è¡—é“ / åŸå¸‚ï¼ˆä¾‹å¦‚ 705 æˆ– Blackheathï¼‰" />
      <div class="list" id="list"></div>
    </div>

    <!-- MAP VIEW -->
    <div class="view" id="viewMap">
      <div class="mapbar">
        <button class="btn" id="geoBtn">ç”Ÿæˆåœ°å›¾ç‚¹</button>
        <div class="progress" id="geoProg">æœªå¼€å§‹å®šä½</div>
      </div>
      <div id="map"></div>
      <div class="small">æç¤ºï¼šå¦‚æœä½ æ¯å¤©åœ°å€å¾ˆå¤šï¼Œç¬¬ä¸€æ¬¡å®šä½ä¼šæ…¢ä¸€ç‚¹ï¼›ä¹‹åä¼šç¼“å­˜ï¼Œç¬¬äºŒæ¬¡æ‰“å¼€å°±å¾ˆå¿«ã€‚</div>
    </div>
  </div>

<script>
/** ===== åŸºç¡€ï¼šæ—¥æœŸKeyï¼ˆæ¯å¤©ä¸€å¥—æ•°æ®ï¼‰ ===== */
function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
const KEY_TEXT = "routeNav:text:" + todayKey();
const KEY_DONE = "routeNav:done:" + todayKey();
const KEY_GEO  = "routeNav:geoCache"; // ç»çº¬åº¦ç¼“å­˜è·¨å¤©ä¹Ÿå¯ä»¥ç”¨

/** ===== çŠ¶æ€ ===== */
let orders = []; // {id, route, addr, done}
let doneSet = new Set(JSON.parse(localStorage.getItem(KEY_DONE) || "[]"));
let geoCache = JSON.parse(localStorage.getItem(KEY_GEO) || "{}"); // addr-> {lat,lng,ts}

/** ===== UIå…ƒç´  ===== */
const elInput = document.getElementById('input');
const elList  = document.getElementById('list');
const elStat  = document.getElementById('stat');
const elSearch= document.getElementById('search');

const tabList = document.getElementById('tabList');
const tabMap  = document.getElementById('tabMap');
const viewList= document.getElementById('viewList');
const viewMap = document.getElementById('viewMap');

const geoBtn  = document.getElementById('geoBtn');
const geoProg = document.getElementById('geoProg');

document.getElementById('buildBtn').onclick = buildAll;
document.getElementById('clearBtn').onclick = clearToday;

tabList.onclick = ()=>switchView('list');
tabMap.onclick  = ()=>switchView('map');

function switchView(v){
  if(v==='list'){
    tabList.classList.add('on'); tabMap.classList.remove('on');
    viewList.classList.add('on'); viewMap.classList.remove('on');
  }else{
    tabMap.classList.add('on'); tabList.classList.remove('on');
    viewMap.classList.add('on'); viewList.classList.remove('on');
    setTimeout(()=>{ if(map) map.invalidateSize(); }, 250);
  }
}

/** ===== è‡ªåŠ¨ä¿å­˜è¾“å…¥ ===== */
elInput.value = localStorage.getItem(KEY_TEXT) || "";
elInput.addEventListener('input', ()=>{
  localStorage.setItem(KEY_TEXT, elInput.value);
});

/** ===== è§£ææ¯è¡Œï¼šæå–è·¯çº¿å· + åœ°å€ =====
 æ”¯æŒï¼š
  705 311 Blackheath...
  705, 311 Blackheath...
  NO.705 311...
  #705 311...
*/
function parseLine(line){
  let s = line.trim();
  if(!s) return null;

  // æŠŠä¸€äº›å‰ç¼€ç»Ÿä¸€æ‰
  s = s.replace(/^NO\.?\s*/i,'').replace(/^#\s*/,'').trim();

  // å…ˆæ‹¿å¼€å¤´çš„æ•°å­—ä½œä¸ºè·¯çº¿å·
  const m = s.match(/^(\d{1,6})[,\s]+(.+)$/);
  if(m){
    return { route: m[1], addr: m[2].trim() };
  }

  // å¦‚æœæ²¡æœ‰è·¯çº¿å·ï¼Œå°±ç»™ä¸€ä¸ªåºå·å ä½ï¼ˆä½†ä½ é€šå¸¸éƒ½æœ‰è·¯çº¿å·ï¼‰
  return { route: 'â€”', addr: s };
}

function parseAll(){
  const lines = elInput.value.split(/\n+/).map(x=>x.trim()).filter(Boolean);
  const out = [];
  for(let i=0;i<lines.length;i++){
    const p = parseLine(lines[i]);
    if(!p) continue;
    const id = `${p.route}__${p.addr}`; // å”¯ä¸€é”®
    out.push({ id, route: p.route, addr: p.addr, done: doneSet.has(id) });
  }
  return out;
}

/** ===== ç»Ÿè®¡ ===== */
function renderStat(){
  const total = orders.length;
  const sent = orders.filter(o=>o.done).length;
  elStat.innerHTML = `ğŸ“¦ <b>ä»Šæ—¥å…± ${total} å•</b> ï½œ å·²é€ ${sent} ï½œ å‰©ä½™ ${total - sent}`;
}

/** ===== åˆ—è¡¨æ¸²æŸ“ ===== */
function buildAll(){
  orders = parseAll();
  renderStat();
  renderList();
}

function renderList(){
  const q = (elSearch.value || "").trim().toLowerCase();
  elList.innerHTML = "";
  const show = q ? orders.filter(o => (o.route+' '+o.addr).toLowerCase().includes(q)) : orders;

  for(const o of show){
    const card = document.createElement('div');
    card.className = 'card' + (o.done ? ' delivered' : '');

    const left = document.createElement('div');
    left.className = 'left';

    const badge = document.createElement('div');
    badge.className = 'badge';
    badge.textContent = (o.route==='â€”') ? 'NO.?' : `NO.${o.route}`;

    const mid = document.createElement('div');
    mid.style.minWidth = '0';

    const addr = document.createElement('div');
    addr.className = 'addr';
    addr.textContent = o.addr;

    const sub = document.createElement('div');
    sub.className = 'sub';
    sub.textContent = 'ç‚¹å‡»å¯¼èˆªä¼šè‡ªåŠ¨å‹¾é€‰âœ…';

    mid.appendChild(addr); mid.appendChild(sub);

    left.appendChild(badge);
    left.appendChild(mid);

    const actions = document.createElement('div');
    actions.className = 'actions';

    const check = document.createElement('div');
    check.className = 'check' + (o.done ? ' on' : '');
    check.innerHTML = o.done ? 'âœ“' : '';
    check.onclick = ()=>{
      toggleDone(o.id);
      o.done = doneSet.has(o.id);
      buildAll(); // é‡æ–°æ¸²æŸ“
      if(markersById[o.id]) updateMarkerStyle(o.id);
    };

    const nav = document.createElement('button');
    nav.className = 'navbtn ' + (o.done ? '' : 'primary');
    nav.innerHTML = '<span>â–¶</span> å¯¼èˆª';
    nav.onclick = ()=>{
      openGoogleNav(o);
      markDone(o.id);
      o.done = true;
      buildAll();
      if(markersById[o.id]) updateMarkerStyle(o.id);
    };

    actions.appendChild(check);
    actions.appendChild(nav);

    card.appendChild(left);
    card.appendChild(actions);

    elList.appendChild(card);
  }
}

elSearch.addEventListener('input', renderList);

/** ===== å‹¾é€‰å­˜å‚¨ ===== */
function saveDone(){
  localStorage.setItem(KEY_DONE, JSON.stringify([...doneSet]));
  renderStat();
}
function markDone(id){
  doneSet.add(id);
  saveDone();
}
function toggleDone(id){
  if(doneSet.has(id)) doneSet.delete(id);
  else doneSet.add(id);
  saveDone();
}

/** ===== æ¸…ç©ºä»Šå¤© ===== */
function clearToday(){
  if(!confirm("ç¡®å®šæ¸…ç©ºä»Šå¤©è¾“å…¥å’Œå·²é€è®°å½•å—ï¼Ÿ")) return;
  localStorage.removeItem(KEY_TEXT);
  localStorage.removeItem(KEY_DONE);
  doneSet = new Set();
  elInput.value = "";
  buildAll();
  if(clusterLayer){
    clusterLayer.clearLayers();
  }
  geoProg.textContent = "æœªå¼€å§‹å®šä½";
}

/** ===== æ‰“å¼€ Google Maps å¯¼èˆª ===== */
function googleUrlFor(addr){
  return "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(addr) + "&travelmode=driving";
}
function openGoogleNav(order){
  const url = googleUrlFor(order.addr);
  window.location.href = url;
}

/** ===== åœ°å›¾ï¼šåˆå§‹åŒ– ===== */
let map = null;
let clusterLayer = null;
let markersById = {}; // id -> marker

function initMapIfNeeded(){
  if(map) return;

  map = L.map('map', { zoomControl:true });
  // æ›´å¹²å‡€çš„åº•å›¾ï¼ˆæ¯” OSM é»˜è®¤æ›´ç®€æ´ï¼‰
  L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
    { maxZoom: 19, attribution: "" }
  ).addTo(map);

  clusterLayer = L.markerClusterGroup({
    // clusteræ›´åƒå›¾ä¸€/å›¾äºŒï¼šé»‘åº•ç™½å­—
    iconCreateFunction: function(cluster){
      const count = cluster.getChildCount();
      return L.divIcon({
        html: `<div style="width:42px;height:42px;border-radius:999px;display:flex;align-items:center;justify-content:center;">${count}</div>`,
        className: 'marker-cluster',
        iconSize: [42,42]
      });
    }
  });
  map.addLayer(clusterLayer);

  // é»˜è®¤è§†è§’å…ˆåˆ°Pittsburgh
  map.setView([40.4406, -79.9959], 10);
}

/** ===== å›¾é’‰Icon ===== */
function pinIcon(route, done){
  const cls = "pin" + (done ? " del" : "");
  const text = (route==='â€”') ? '?' : route;
  return L.divIcon({
    html: `<div class="${cls}">${text}</div>`,
    className: "", // ä¸è¦é»˜è®¤æ ·å¼
    iconSize: [40,40],
    iconAnchor: [20,20]
  });
}

/** ===== æ›´æ–° marker æ ·å¼ï¼ˆå·²é€å˜ç»¿ï¼‰ ===== */
function updateMarkerStyle(id){
  const m = markersById[id];
  if(!m) return;
  const o = orders.find(x=>x.id===id);
  if(!o) return;
  m.setIcon(pinIcon(o.route, doneSet.has(id)));
}

/** ===== å…è´¹åœ°ç†ç¼–ç ï¼ˆNominatimï¼‰+ ç¼“å­˜ + é™é€Ÿ ===== */
function cacheGeoSave(){
  localStorage.setItem(KEY_GEO, JSON.stringify(geoCache));
}

async function geocode(addr){
  // ç¼“å­˜å‘½ä¸­ï¼ˆä¸è¿‡æœŸä¹Ÿè¡Œï¼›è¿™é‡Œä¿ç•™ï¼‰
  if(geoCache[addr] && geoCache[addr].lat && geoCache[addr].lng){
    return geoCache[addr];
  }

  // Nominatimï¼šåŠ  countrycodes=us æ›´å‡†
  const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=us&q=" + encodeURIComponent(addr);
  const r = await fetch(url, { headers: { "Accept": "application/json" } });
  const j = await r.json();
  if(j && j.length){
    const g = { lat: parseFloat(j[0].lat), lng: parseFloat(j[0].lon), ts: Date.now() };
    geoCache[addr] = g;
    cacheGeoSave();
    return g;
  }else{
    // è®°å½•å¤±è´¥ï¼Œé¿å…åå¤æ‰“
    geoCache[addr] = { fail:true, ts: Date.now() };
    cacheGeoSave();
    return null;
  }
}

// é™é€Ÿï¼šæ¯æ¬¡è¯·æ±‚é—´éš” ~1100msï¼ˆé¿å…è¢«é™åˆ¶ï¼‰
function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }

/** ===== ç”Ÿæˆåœ°å›¾ç‚¹ ===== */
geoBtn.onclick = async ()=>{
  buildAll();
  initMapIfNeeded();
  clusterLayer.clearLayers();
  markersById = {};

  // å…ˆç­›æ‰ç©º
  const list = orders.slice();
  if(!list.length){
    geoProg.textContent = "è¯·å…ˆè¾“å…¥åœ°å€å¹¶ç‚¹ã€Œç”Ÿæˆåˆ—è¡¨ã€";
    return;
  }

  geoProg.textContent = `å¼€å§‹å®šä½ 0/${list.length}ï¼ˆç¬¬ä¸€æ¬¡å¯èƒ½æ…¢ï¼Œå®šä½åä¼šç¼“å­˜ï¼‰`;

  let ok = 0;
  let firstLatLng = null;

  for(let i=0;i<list.length;i++){
    const o = list[i];

    // å¦‚æœåœ°å€å¤ªçŸ­ä¸é è°±ï¼Œè·³è¿‡
    if(!o.addr || o.addr.length < 6){
      geoProg.textContent = `å®šä½ä¸­ ${i+1}/${list.length}ï¼ˆè·³è¿‡æ— æ•ˆåœ°å€ï¼‰`;
      continue;
    }

    // å¦‚æœç¼“å­˜é‡Œå·²ç»failï¼Œå…ˆè·³è¿‡ï¼ˆé¿å…æµªè´¹ï¼‰
    if(geoCache[o.addr] && geoCache[o.addr].fail){
      geoProg.textContent = `å®šä½ä¸­ ${i+1}/${list.length}ï¼ˆæœ‰äº›åœ°å€ä¹‹å‰å®šä½å¤±è´¥ï¼‰`;
      continue;
    }

    const g = await geocode(o.addr);
    geoProg.textContent = `å®šä½ä¸­ ${i+1}/${list.length}ï¼ˆæˆåŠŸ ${ok}ï¼‰`;

    if(g && g.lat && g.lng){
      ok++;
      if(!firstLatLng) firstLatLng = [g.lat, g.lng];

      const marker = L.marker([g.lat, g.lng], { icon: pinIcon(o.route, doneSet.has(o.id)) });

      const popHtml = `
        <div class="pop">
          <div class="t">NO.${o.route}</div>
          <div class="a">${o.addr}</div>
          <button class="b" onclick="window.__NAV('${encodeURIComponent(o.id)}')">â–¶ å¯¼èˆªï¼ˆè‡ªåŠ¨âœ…ï¼‰</button>
        </div>
      `;
      marker.bindPopup(popHtml);

      markersById[o.id] = marker;
      clusterLayer.addLayer(marker);
    }

    // é™é€Ÿï¼ˆç¼“å­˜å‘½ä¸­ä¼šå¾ˆå¿«ï¼Œä½†ä¹Ÿç¨å¾®å–˜å£æ°”ï¼‰
    await sleep(1100);
  }

  // è§†è§’ï¼šå¦‚æœæœ‰ç‚¹å°±èšåˆåˆ°ç‚¹èŒƒå›´ï¼›æ²¡æœ‰å°±ä¿æŒé»˜è®¤
  const layers = Object.values(markersById);
  if(layers.length){
    const group = L.featureGroup(layers);
    map.fitBounds(group.getBounds().pad(0.25));
  }else{
    if(firstLatLng) map.setView(firstLatLng, 13);
  }

  geoProg.textContent = `å®Œæˆï¼šæˆåŠŸå®šä½ ${ok}/${list.length}ï¼ˆæ²¡æ˜¾ç¤ºçš„é€šå¸¸æ˜¯åœ°å€å®šä½å¤±è´¥ï¼‰`;
};

/** ===== ç»™ popup å†…æŒ‰é’®è°ƒç”¨ï¼šå¯¼èˆª + è‡ªåŠ¨å‹¾é€‰ ===== */
window.__NAV = function(encodedId){
  const id = decodeURIComponent(encodedId);
  const o = orders.find(x=>x.id===id);
  if(!o) return;

  openGoogleNav(o);
  markDone(id);
  // æ›´æ–°markeré¢œè‰²
  if(markersById[id]) updateMarkerStyle(id);
  // åˆ—è¡¨ä¹ŸåŒæ­¥
  buildAll();
};

/** ===== é¦–æ¬¡åŠ è½½å°±æ¸²æŸ“ä¸€æ¬¡ ===== */
buildAll();

</script>
</body>
</html>
