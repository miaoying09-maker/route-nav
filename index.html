<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å•ç‚¹å¯¼èˆªï¼ˆå‡çº§ç‰ˆï¼‰</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;
  margin:0;padding:12px;background:#f6f7f9
}
h2{margin:6px 0 10px}

textarea{
  width:100%;height:160px;border-radius:12px;border:1px solid #ddd;
  padding:10px;font-size:14px;box-sizing:border-box
}

button{
  border:0;border-radius:12px;
  padding:10px 14px;font-size:15px;font-weight:600
}

.primary{background:#1677ff;color:#fff}
.ghost{background:#fff;border:1px solid #ddd}

.row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
.card{
  background:#fff;border-radius:14px;padding:12px;margin-top:10px;
  display:flex;justify-content:space-between;align-items:center
}
.badge{
  background:#eee;border-radius:999px;padding:4px 10px;
  font-weight:700;font-size:12px;margin-right:6px
}
.addr{font-size:14px;line-height:1.3}
.actions{display:flex;gap:8px;align-items:center}
.check{width:22px;height:22px}
.small{font-size:12px;color:#666;margin-top:6px}

.tabs{display:flex;gap:10px;margin:10px 0}
.tabs button{padding:8px 12px}

#list{display:block}
#mapwrap{display:none;position:relative}
#map{
  height:65vh;min-height:520px;border-radius:14px;margin-top:10px
}

/* å…¨å± */
.fullbtn{
  position:absolute;right:14px;top:14px;z-index:9999;
  background:#111;color:#fff;border-radius:12px;
  padding:10px 12px;font-weight:900
}
.fullscreen{
  position:fixed!important;
  left:0;top:0;right:0;bottom:0;
  width:100vw!important;height:100vh!important;
  border-radius:0!important;z-index:99999!important
}
body.lock{overflow:hidden}

/* åœ°å›¾æ ‡ç­¾ */
.marker{
  background:#111;color:#fff;border-radius:999px;
  width:38px;height:38px;
  display:flex;align-items:center;justify-content:center;
  font-weight:800;border:3px solid #fff
}
.marker.done{background:#1bbf5c}
</style>
</head>

<body>

<h2>å•ç‚¹å¯¼èˆªï¼ˆå‡çº§ç‰ˆï¼‰</h2>

<textarea id="input" placeholder="æ¯è¡Œä¸€å•ï¼ˆå¯å¸¦è·¯çº¿å·ï¼‰
802 902 Wilhelm St, Pittsburgh, PA
803 900 Marena St, Pittsburgh, PA"></textarea>

<div class="row">
  <button class="primary" onclick="build()">ç”Ÿæˆåˆ—è¡¨</button>
  <button class="ghost" onclick="clearAll()">æ¸…ç©º</button>
</div>

<div class="tabs">
  <button class="ghost" onclick="showList()">åˆ—è¡¨æ¨¡å¼</button>
  <button class="ghost" onclick="showMap()">åœ°å›¾æ¨¡å¼</button>
</div>

<div id="stat" class="small"></div>

<div id="list"></div>

<div id="mapwrap">
  <button class="fullbtn" id="fullBtn">â›¶ å…¨å±</button>
  <button class="primary" onclick="buildMap()">ç”Ÿæˆåœ°å›¾ç‚¹</button>
  <div id="map"></div>
  <div class="small">ç‚¹è·¯çº¿å· â†’ å¯¼èˆª â†’ è‡ªåŠ¨æ‰“å‹¾ âœ…</div>
</div>

<script>
let data=[],map,markers=[],isFull=false;

function parse(){
  data=[];
  const lines=input.value.split(/\n/).map(l=>l.trim()).filter(Boolean);
  let idx=1;
  lines.forEach(l=>{
    let no=`NO.${idx}`;
    let addr=l;
    const m=l.match(/^(\d+)\s+(.*)$/);
    if(m){no=`NO.${m[1]}`;addr=m[2]}
    data.push({no,addr,done:false,lat:null,lng:null});
    idx++;
  });
}

function updateStat(){
  const total=data.length;
  const done=data.filter(d=>d.done).length;
  stat.innerHTML=`ğŸ“¦ ä»Šæ—¥å…± <b>${total}</b> å• ï½œ å·²é€ ${done} ï½œ å‰©ä½™ ${total-done}`;
}

function build(){
  parse();
  list.innerHTML='';
  data.forEach((d,i)=>{
    const div=document.createElement('div');
    div.className='card'+(d.done?' delivered':'');
    div.innerHTML=`
      <div>
        <span class="badge">${d.no}</span>
        <div class="addr">${d.addr}</div>
      </div>
      <div class="actions">
        <input type="checkbox" class="check" ${d.done?'checked':''}
          onchange="toggle(${i},this.checked)">
        <button class="primary" onclick="nav(${i})">â–¶ å¯¼èˆª</button>
      </div>`;
    list.appendChild(div);
  });
  updateStat();
}

function toggle(i,v){
  data[i].done=v;
  build();
}

function nav(i){
  data[i].done=true;
  updateStat();
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(data[i].addr)}`);
}

function showList(){
  list.style.display='block';
  mapwrap.style.display='none';
}

function showMap(){
  list.style.display='none';
  mapwrap.style.display='block';
  if(map) map.invalidateSize();
}

function clearAll(){
  input.value='';
  data=[];list.innerHTML='';
  updateStat();
}

function buildMap(){
  if(!map){
    map=L.map('map').setView([40.44,-79.99],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  }
  markers.forEach(m=>map.removeLayer(m));
  markers=[];

  data.forEach(d=>{
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(d.addr)}`)
      .then(r=>r.json()).then(j=>{
        if(!j[0])return;
        d.lat=j[0].lat;d.lng=j[0].lon;
        const icon=L.divIcon({
          className:'',
          html:`<div class="marker ${d.done?'done':''}">${d.no.replace('NO.','')}</div>`,
          iconSize:[38,38],iconAnchor:[19,19]
        });
        const m=L.marker([d.lat,d.lng],{icon}).addTo(map);
        m.on('click',()=>{
          d.done=true;
          updateStat();
          window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(d.addr)}`);
          buildMap();
        });
        markers.push(m);
      });
  });
}

/* å…¨å±æ§åˆ¶ */
fullBtn.onclick=()=>{
  isFull=!isFull;
  map.classList.toggle('fullscreen',isFull);
  document.body.classList.toggle('lock',isFull);
  fullBtn.textContent=isFull?'âœ• é€€å‡º':'â›¶ å…¨å±';
  setTimeout(()=>{if(map)map.invalidateSize()},200);
};

updateStat();
</script>

</body>
</html>
