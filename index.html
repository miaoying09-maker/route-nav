<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>单点导航（B版·带总数）</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;margin:0;padding:12px;background:#f5f5f5}
h3{margin:6px 0 10px}
textarea{width:100%;height:140px;border-radius:10px;border:1px solid #ddd;padding:10px;font-size:14px}
button{border:0;border-radius:10px;padding:10px 14px;font-size:15px}
.primary{background:#1a73e8;color:#fff}
.ghost{background:#fff;border:1px solid #ddd}
.small{font-size:12px;color:#666;margin:6px 0}
#stats{font-size:14px;font-weight:700;margin:8px 0}
#map{height:60vh;border-radius:12px;margin-top:10px}
.marker{
  width:34px;height:34px;border-radius:50%;
  background:#000;color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:14px
}
.marker.done{background:#aaa}
</style>
</head>

<body>

<h3>单点导航（升级版）</h3>

<textarea id="input" placeholder="每行一单（路线号 地址）
702 4450 Steubenville Pike, Pittsburgh, PA
703 1107 East Windhaven Rd, Pittsburgh, PA"></textarea>

<div style="margin-top:8px">
  <button class="primary" onclick="build()">生成地图</button>
  <button class="ghost" onclick="clearAll()">清空</button>
</div>

<div id="stats">今日总数：0　已送：0　剩余：0</div>
<div class="small">地图点=路线号｜点数字→小卡片→导航（自动✅）</div>

<div id="map"></div>

<script>
let map, items=[], done=new Set();

function save(){
  localStorage.setItem("route_done",JSON.stringify([...done]));
}
function load(){
  try{
    done=new Set(JSON.parse(localStorage.getItem("route_done")||"[]"));
  }catch(e){}
}
function updateStats(){
  const total=items.length;
  const d=items.filter(i=>done.has(i.id)).length;
  document.getElementById("stats").textContent=
    `今日总数：${total}　已送：${d}　剩余：${total-d}`;
}

function parseLine(line,i){
  const m=line.match(/^(\d+)\s+(.+)/);
  if(!m) return null;
  return {id:m[1],addr:m[2],idx:i};
}

function build(){
  if(map){map.remove()}
  map=L.map("map").setView([40.44,-79.99],12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  items=document.getElementById("input").value
    .split(/\n+/).map((l,i)=>parseLine(l.trim(),i)).filter(Boolean);

  updateStats();

  items.forEach(it=>{
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(it.addr)}`)
      .then(r=>r.json()).then(d=>{
        if(!d[0])return;
        const lat=+d[0].lat,lng=+d[0].lon;
        const icon=L.divIcon({
          className:"",
          html:`<div class="marker ${done.has(it.id)?"done":""}">${it.id}</div>`
        });
        const m=L.marker([lat,lng],{icon}).addTo(map);
        m.on("click",()=>{
          const ok=confirm(`NO.${it.id}\n${it.addr}\n\n开始导航？`);
          if(ok){
            done.add(it.id);save();updateStats();
            window.location.href=
              `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(it.addr)}`;
          }
        });
      });
  });
}

function clearAll(){
  if(confirm("清空今天内容？")){
    document.getElementById("input").value="";
    items=[];done.clear();save();updateStats();
    if(map)map.remove();
  }
}

load();
updateStats();
</script>

</body>
</html>
