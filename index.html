<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å•ç‚¹å¯¼èˆªï¼ˆå‡çº§ç‰ˆï¼‰</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body{
    font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;
    margin:0;padding:12px;background:#f6f7f9
  }
  h2{margin:6px 0 10px;font-size:28px}

  textarea{
    width:100%;height:160px;border-radius:14px;border:1px solid #ddd;
    padding:12px;font-size:14px;box-sizing:border-box;background:#fff
  }

  button{
    border:0;border-radius:14px;
    padding:12px 16px;font-size:16px;font-weight:700
  }
  .primary{background:#1677ff;color:#fff}
  .ghost{background:#fff;border:1px solid #ddd;color:#1677ff}

  .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .tabs{display:flex;gap:10px;margin:10px 0}

  #stat{
    margin-top:8px;font-size:16px;color:#333;
    display:flex;align-items:center;gap:10px;flex-wrap:wrap
  }
  #stat b{font-size:18px}
  .pill{
    background:#fff;border:1px solid #e6e6e6;border-radius:999px;
    padding:8px 12px;display:inline-flex;gap:10px;align-items:center
  }

  /* åˆ—è¡¨å¡ç‰‡ */
  .card{
    background:#fff;border-radius:16px;padding:12px;margin-top:12px;
    display:flex;gap:12px;align-items:center;justify-content:space-between
  }
  .left{
    display:flex;gap:12px;align-items:flex-start;min-width:0
  }
  .no{
    flex:0 0 auto;
    background:#1677ff;color:#fff;border-radius:14px;
    padding:10px 12px;
    font-weight:900;font-size:16px;line-height:1;
    box-shadow:0 6px 14px rgba(22,119,255,.25)
  }
  .addr{
    font-size:15px;line-height:1.3;word-break:break-word;
    font-weight:700;color:#111
  }
  .sub{
    margin-top:4px;font-size:12px;color:#666;font-weight:600
  }
  .actions{display:flex;gap:10px;align-items:center;flex:0 0 auto}
  .check{width:22px;height:22px;transform:scale(1.15)}
  .navBtn{
    background:#1677ff;color:#fff;border-radius:14px;
    padding:12px 14px;font-weight:900
  }
  .delivered{opacity:.5}
  .small{font-size:12px;color:#666;margin-top:8px}

  /* åœ°å›¾ */
  #list{display:block}
  #mapwrap{display:none;position:relative;margin-top:10px}
  #map{
    height:60vh;min-height:520px;border-radius:16px;overflow:hidden
  }

  /* ä¼ªå…¨å±ï¼ˆiPhone Safari ç¨³å®šï¼‰ */
  #mapwrap.fullscreenWrap{
    position:fixed;left:0;top:0;right:0;bottom:0;
    background:#fff;z-index:999999;padding:10px
  }
  #mapwrap.fullscreenWrap #map{
    height:calc(100vh - 70px);
    min-height:auto;border-radius:16px
  }
  body.lock{overflow:hidden}

  .fullbtn{
    position:absolute;right:16px;top:16px;z-index:9999;
    background:#111;color:#fff;border-radius:999px;
    padding:12px 14px;font-weight:900;display:flex;align-items:center;gap:8px
  }

  /* åœ°å›¾æ ‡è®°ï¼šè·¯çº¿å·æ›´æ¸…æ™° */
  .marker{
    background:#111;color:#fff;border-radius:999px;
    width:44px;height:44px;
    display:flex;align-items:center;justify-content:center;
    font-weight:900;border:4px solid #fff;
    box-shadow:0 10px 20px rgba(0,0,0,.2)
  }
  .marker.done{background:#1bbf5c}

  /* åœ°å›¾å¼¹çª—æŒ‰é’®æ›´å±…ä¸­ */
  .popupBtn{
    width:100%;
    background:#1677ff;color:#fff;border-radius:14px;
    padding:12px 14px;font-weight:900;border:0
  }
</style>
</head>

<body>

<h2>å•ç‚¹å¯¼èˆªï¼ˆå‡çº§ç‰ˆï¼‰</h2>

<textarea id="input" placeholder="æ¯è¡Œä¸€å•ï¼ˆæ¨èï¼šè·¯çº¿å· ç©ºæ ¼ åœ°å€ï¼‰
802 902 Wilhelm St, Pittsburgh, PA
803 900 Marena St, Pittsburgh, PA"></textarea>

<div class="row">
  <button class="primary" onclick="build()">ç”Ÿæˆåˆ—è¡¨</button>
  <button class="ghost" onclick="clearAll()">æ¸…ç©º</button>
</div>

<div class="tabs">
  <button class="ghost" onclick="showList()">åˆ—è¡¨æ¨¡å¼</button>
  <button class="ghost" onclick="showMap()">åœ°å›¾æ¨¡å¼</button>
</div>

<div id="stat"></div>

<div id="list"></div>

<div id="mapwrap">
  <button class="fullbtn" id="fullBtn">â›¶ å…¨å±</button>
  <div class="row">
    <button class="primary" onclick="buildMap()">ç”Ÿæˆåœ°å›¾ç‚¹</button>
  </div>
  <div id="map"></div>
  <div class="small">åœ°å›¾æ›´æ¸…çˆ½ï¼ˆæ— è·¯åï¼‰ã€‚ç‚¹è·¯çº¿å· â†’ å¯¼èˆª â†’ è‡ªåŠ¨æ‰“å‹¾ âœ…</div>
</div>

<script>
let data=[], leafletMap=null, markers=[], isFull=false;

function parse(){
  data=[];
  const lines = input.value.split(/\n/).map(l=>l.trim()).filter(Boolean);
  let idx=1;
  lines.forEach(l=>{
    // æ”¯æŒï¼š802 902 Wilhelm... æˆ– 802, 902 Wilhelm...
    let no=`NO.${idx}`;
    let addr=l;

    const m = l.match(/^(\d+)[,\s]+(.+)$/);
    if(m){
      no = `NO.${m[1]}`;
      addr = m[2].trim();
    }

    data.push({no, addr, done:false, lat:null, lng:null});
    idx++;
  });
}

function updateStat(){
  const total = data.length;
  const done = data.filter(d=>d.done).length;
  const left = total - done;

  stat.innerHTML = `
    <div class="pill">ğŸ“¦ ä»Šæ—¥å…± <b>${total}</b> å•</div>
    <div class="pill">âœ… å·²é€ <b>${done}</b></div>
    <div class="pill">ğŸ•’ å‰©ä½™ <b>${left}</b></div>
  `;
}

function build(){
  parse();
  list.innerHTML='';

  data.forEach((d,i)=>{
    const div=document.createElement('div');
    div.className='card'+(d.done?' delivered':'');
    div.innerHTML=`
      <div class="left">
        <div class="no">${d.no.replace('NO.','NO.')}</div>
        <div style="min-width:0">
          <div class="addr">${d.addr}</div>
          <div class="sub">ç‚¹å‡»å¯¼èˆªåè‡ªåŠ¨âœ…ï¼›ä¹Ÿå¯æ‰‹åŠ¨å‹¾é€‰</div>
        </div>
      </div>

      <div class="actions">
        <input type="checkbox" class="check" ${d.done?'checked':''}
          onchange="toggle(${i},this.checked)">
        <button class="navBtn" onclick="nav(${i})">â–¶ å¯¼èˆª</button>
      </div>
    `;
    list.appendChild(div);
  });

  updateStat();
}

function toggle(i,v){
  data[i].done = v;
  build();
}

function nav(i){
  data[i].done = true;
  updateStat();
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(data[i].addr)}`);
  // å›æ¥ååˆ—è¡¨ä¼šä¿æŒï¼ˆå› ä¸ºé¡µé¢æ²¡åˆ·æ–°ï¼‰
  build();
}

function showList(){
  list.style.display='block';
  mapwrap.style.display='none';
}

function showMap(){
  list.style.display='none';
  mapwrap.style.display='block';
  setTimeout(()=>{ if(leafletMap) leafletMap.invalidateSize(); }, 200);
}

function clearAll(){
  input.value='';
  data=[];
  list.innerHTML='';
  updateStat();
  if(leafletMap){
    markers.forEach(m=>leafletMap.removeLayer(m));
    markers=[];
  }
}

/* åœ°å›¾ï¼šæ¸…çˆ½åº•å›¾ï¼ˆæ— è·¯åï¼‰ */
function ensureMap(){
  if(leafletMap) return;

  leafletMap = L.map('map', { zoomControl:true }).setView([40.44,-79.99], 11);

  // æ›´æ¸…çˆ½ï¼šæ·¡è‰² + æ— è·¯å
  L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',
    { maxZoom: 19 }
  ).addTo(leafletMap);
}

function buildMap(){
  parse();
  updateStat();
  ensureMap();

  // æ¸…æ‰æ—§ç‚¹
  markers.forEach(m=>leafletMap.removeLayer(m));
  markers=[];

  // ç®€å•èšç„¦ï¼šå…ˆå›åˆ°åŒ¹å…¹å ¡é™„è¿‘
  leafletMap.setView([40.44,-79.99], 11);

  data.forEach(d=>{
    // é€šè¿‡ Nominatim å®šä½
    fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(d.addr)}`)
      .then(r=>r.json())
      .then(j=>{
        if(!j || !j[0]) return;

        d.lat = parseFloat(j[0].lat);
        d.lng = parseFloat(j[0].lon);

        const icon=L.divIcon({
          className:'',
          html:`<div class="marker ${d.done?'done':''}">${d.no.replace('NO.','')}</div>`,
          iconSize:[44,44],
          iconAnchor:[22,22]
        });

        const m = L.marker([d.lat,d.lng],{icon}).addTo(leafletMap);

        m.on('click',()=>{
          // ç‚¹å‡»ç‚¹ï¼šå¼¹å‡ºå¡ç‰‡ï¼ˆæ›´ç›´è§‚ï¼‰
          const html = `
            <div style="min-width:220px">
              <div style="font-weight:900;font-size:14px;margin-bottom:6px">${d.no}</div>
              <div style="font-weight:800;font-size:13px;color:#111;line-height:1.3;margin-bottom:10px">${d.addr}</div>
              <button class="popupBtn" onclick="window.__goNav('${encodeURIComponent(d.addr)}','${d.no}')">â–¶ å¯¼èˆªï¼ˆè‡ªåŠ¨âœ…ï¼‰</button>
            </div>
          `;
          m.bindPopup(html).openPopup();
        });

        markers.push(m);
      });
  });
}

/* ç»™ popup æŒ‰é’®ç”¨ï¼ˆå…¨å±€ï¼‰ */
window.__goNav = (addrEncoded, no)=>{
  const found = data.find(x => x.no === no);
  if(found) found.done = true;
  updateStat();
  // é‡æ–°ç”»ç‚¹ï¼šå·²é€å˜ç»¿
  buildMap();
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${addrEncoded}`);
};

const fullBtn = document.getElementById('fullBtn');
fullBtn.onclick = ()=>{
  isFull = !isFull;
  document.getElementById('mapwrap').classList.toggle('fullscreenWrap', isFull);
  document.body.classList.toggle('lock', isFull);
  fullBtn.innerHTML = isFull ? 'âœ• é€€å‡ºå…¨å±' : 'â›¶ å…¨å±';
  setTimeout(()=>{ if(leafletMap) leafletMap.invalidateSize(); }, 250);
};

updateStat();
</script>

</body>
</html>
