<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>单点导航（升级版）</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto; margin:0; background:#f5f5f5;}
    .wrap{padding:12px; max-width:760px; margin:0 auto;}
    h2{margin:10px 0 10px; font-size:28px;}
    textarea{width:100%; height:150px; box-sizing:border-box; border-radius:12px; border:1px solid #ddd; padding:12px; font-size:15px; background:#fff;}
    button{border:0; border-radius:12px; padding:12px 16px; font-size:16px;}
    .primary{background:#1a73e8; color:#fff;}
    .ghost{background:#fff; border:1px solid #ddd; color:#1a73e8;}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0;}
    .tabs{display:flex; gap:10px; margin-top:6px;}
    .tab{background:#fff; border:1px solid #ddd; color:#333;}
    .tab.active{background:#1a73e8; color:#fff; border-color:#1a73e8;}

    .summary{margin:8px 0 0; color:#333; font-size:16px; font-weight:700;}
    .sub{margin:6px 0 10px; color:#666; font-size:13px;}

    .list{margin-top:8px;}
    .card{
      background:#fff; border-radius:16px; padding:14px 14px;
      display:flex; justify-content:space-between; align-items:center;
      margin:10px 0; box-shadow:0 1px 0 rgba(0,0,0,.04);
    }
    .left{min-width:0;}
    .no{display:inline-block; padding:3px 10px; border-radius:999px; background:#f0f0f0; font-weight:800; margin-right:8px;}
    .addr{font-size:18px; font-weight:800; color:#c62828; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:520px;}
    .city{color:#666; margin-top:4px; font-size:14px;}
    .actions{display:flex; gap:12px; align-items:center;}
    .chk{width:22px; height:22px;}
    .navbtn{
      background:#1a73e8; color:#fff; border-radius:14px; padding:10px 14px;
      font-size:16px; font-weight:800;
    }
    .delivered{opacity:.40;}

    /* 地图容器（非全屏时） */
    #mapHost{
      background:#fff; border-radius:16px; overflow:hidden; margin-top:10px;
      box-shadow:0 1px 0 rgba(0,0,0,.04);
    }
    #map{height:420px; width:100%;}
    .mapTopRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;}

    /* 全屏弹层：按钮不在地图层里，iPhone 更稳 */
    .fsMask{
      position:fixed; inset:0; background:#00000066;
      display:none; z-index:999999;
    }
    .fsMask.show{display:block;}
    .fsPanel{
      position:fixed; inset:0; background:#fff; z-index:1000000;
      display:none; flex-direction:column;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }
    .fsPanel.show{display:flex;}
    .fsBar{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px; border-bottom:1px solid #eee;
    }
    .fsTitle{font-weight:900; font-size:16px;}
    .fsBtn{
      background:#111; color:#fff; border-radius:12px;
      padding:10px 12px; font-weight:900;
    }
    #mapFS{flex:1; min-height:0;}
    #mapFSInner{height:100%; width:100%;}

    /* 地图标记：显示路线号 */
    .pin{
      width:46px; height:46px; border-radius:999px;
      background:#111; color:#fff; display:flex; align-items:center; justify-content:center;
      font-weight:900; font-size:16px;
      box-shadow:0 8px 18px rgba(0,0,0,.25);
      border:3px solid #fff;
    }
    .pin.red{background:#c62828;}
    .pin.green{background:#2e7d32;}

    .hidden{display:none !important;}
  </style>
</head>

<body>
  <div class="wrap">
    <h2>单点导航（升级版）</h2>

    <textarea id="input" placeholder="每行一单（建议：路线号 空格 地址）
例如：
700 4450 Steubenville Pike, Pittsburgh, PA
701 1107 East Windhaven Rd, Pittsburgh, PA"></textarea>

    <div class="row">
      <button class="primary" onclick="buildList()">生成列表</button>
      <button class="ghost" onclick="clearToday()">清空</button>
    </div>

    <div class="tabs">
      <button id="tabList" class="tab active" onclick="showMode('list')">列表模式</button>
      <button id="tabMap" class="tab" onclick="showMode('map')">地图模式</button>
    </div>

    <div class="summary" id="summary">今日共 0 单 ｜ 已送 0 ｜ 剩余 0</div>
    <div class="sub">✅ 点击“导航”会自动勾选（你回到页面时会看到已送）</div>

    <!-- 列表 -->
    <div id="list" class="list"></div>

    <!-- 地图 -->
    <div id="mapMode" class="hidden">
      <div class="mapTopRow">
        <button class="primary" onclick="genMapPins()">生成地图点</button>
        <button class="ghost" onclick="openFullScreen()">全屏地图</button>
      </div>
      <div id="mapHost">
        <div id="map"></div>
      </div>
      <div class="sub">地图点显示路线号，点一下会弹出卡片，点卡片里的“导航”可直达 Google Maps。</div>
    </div>
  </div>

  <!-- 全屏弹层（独立按钮，不在地图层里） -->
  <div id="fsMask" class="fsMask" onclick="closeFullScreen()"></div>
  <div id="fsPanel" class="fsPanel">
    <div class="fsBar">
      <div class="fsTitle">地图全屏</div>
      <button class="fsBtn" onclick="closeFullScreen()">退出全屏 ✕</button>
    </div>
    <div id="mapFS">
      <div id="mapFSInner"></div>
    </div>
  </div>

<script>
  // ====== 数据与存储 ======
  const LS_KEY = "route_nav_vB_data";
  let items = [];            // {no, addr, city, delivered, lat, lon}
  let mode = "list";

  // ====== 地图对象 ======
  let mapSmall = null;
  let mapFS = null;
  let markersSmall = [];
  let markersFS = [];

  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        const obj = JSON.parse(raw);
        items = obj.items || [];
        document.getElementById("input").value = obj.input || "";
        mode = obj.mode || "list";
      }
    }catch(e){}
    showMode(mode, true);
    render();
  }

  function save(){
    localStorage.setItem(LS_KEY, JSON.stringify({
      items,
      input: document.getElementById("input").value,
      mode
    }));
  }

  function clearToday(){
    if(!confirm("确定清空今天内容？")) return;
    items = [];
    document.getElementById("input").value = "";
    save();
    render();
    clearMaps();
  }

  // ====== 解析输入：把路线号和地址分开（你要的“像序列号那样区分开”）======
  function parseLines(text){
    const lines = text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const out = [];
    for(const line of lines){
      // 支持：700 空格 地址； or NO.700 地址； or 700, 地址
      const m = line.match(/^(?:NO\.?\s*)?(\d{2,6})[\s,，]+(.+)$/i);
      if(m){
        out.push({no: m[1], addr: m[2].trim()});
      }else{
        // 没有号码：自动给一个
        out.push({no: "", addr: line});
      }
    }
    // 没号的补号（按顺序）
    let auto = 1;
    for(const it of out){
      if(!it.no){
        it.no = "A" + String(auto++).padStart(3,"0");
      }
    }
    return out;
  }

  function buildList(){
    const text = document.getElementById("input").value.trim();
    const parsed = parseLines(text);

    // 保留之前 delivered 状态（同号同地址）
    const oldMap = new Map(items.map(x => [x.no + "||" + x.addr, x]));
    items = parsed.map(p=>{
      const key = p.no + "||" + p.addr;
      const old = oldMap.get(key);
      return {
        no: p.no,
        addr: p.addr,
        city: guessCity(p.addr),
        delivered: old ? !!old.delivered : false,
        lat: old ? old.lat : null,
        lon: old ? old.lon : null
      };
    });

    save();
    render();
    // 列表生成后，小地图也刷新（不自动定位，等你点“生成地图点”）
    clearMaps();
  }

  function guessCity(addr){
    // 简单提取 “, City, ST” 的 City，显示更干净
    const parts = addr.split(",").map(s=>s.trim());
    if(parts.length >= 2) return parts[1];
    return "";
  }

  function render(){
    // 统计
    const total = items.length;
    const delivered = items.filter(x=>x.delivered).length;
    const left = total - delivered;
    document.getElementById("summary").textContent = `今日共 ${total} 单 ｜ 已送 ${delivered} ｜ 剩余 ${left}`;

    // 列表
    const list = document.getElementById("list");
    list.innerHTML = "";
    items.forEach((it, idx)=>{
      const card = document.createElement("div");
      card.className = "card" + (it.delivered ? " delivered" : "");
      card.innerHTML = `
        <div class="left">
          <div>
            <span class="no">NO.${escapeHtml(it.no)}</span>
            <span class="addr">${escapeHtml(shortAddr(it.addr))}</span>
          </div>
          <div class="city">${escapeHtml(it.city || "")}</div>
        </div>
        <div class="actions">
          <input class="chk" type="checkbox" ${it.delivered ? "checked":""}
            onchange="toggleDelivered(${idx}, this.checked)" />
          <button class="navbtn" onclick="goNav(${idx})">▶ 导航</button>
        </div>
      `;
      list.appendChild(card);
    });
  }

  function shortAddr(a){
    return a;
  }

  function toggleDelivered(i, v){
    items[i].delivered = !!v;
    save();
    render();
    // 地图上也同步颜色
    recolorPins();
  }

  // ====== 导航：打开 Google Maps；并“延迟自动勾选” ======
  function goNav(i){
    const it = items[i];
    const q = encodeURIComponent(it.addr);
    const url = `https://www.google.com/maps/dir/?api=1&destination=${q}&travelmode=driving`;

    // 先打开导航（用户手势内）
    window.location.href = url;

    // iPhone：跳转后 JS 可能暂停；所以用“短延迟”尽量在跳转前写入
    items[i].delivered = true;
    save();
    render();
    recolorPins();
  }

  // ====== 模式切换 ======
  function showMode(m, silent){
    mode = m;
    document.getElementById("tabList").classList.toggle("active", m==="list");
    document.getElementById("tabMap").classList.toggle("active", m==="map");
    document.getElementById("list").classList.toggle("hidden", m!=="list");
    document.getElementById("mapMode").classList.toggle("hidden", m!=="map");
    if(!silent) save();

    if(m==="map"){
      ensureSmallMap();
    }
  }

  // ====== 地图：小地图 ======
  function ensureSmallMap(){
    if(mapSmall) return;
    mapSmall = L.map('map', { zoomControl: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(mapSmall);

    // 默认 Pittsburgh 附近
    mapSmall.setView([40.4406, -79.9959], 10);
  }

  function clearMaps(){
    markersSmall.forEach(m=>m.remove());
    markersFS.forEach(m=>m.remove());
    markersSmall = [];
    markersFS = [];
  }

  function recolorPins(){
    // 重新生成最简单：如果你已经生成过地图点，就刷新一遍
    if(markersSmall.length) genMapPins(true);
    if(markersFS.length) genMapPins(true, true);
  }

  // 用 Nominatim（OSM）做地理编码：免费但会慢，200 单请分批
  async function geocode(addr){
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}&limit=1`;
    const r = await fetch(url, {headers:{'Accept':'application/json'}});
    const j = await r.json();
    if(j && j[0]) return {lat: parseFloat(j[0].lat), lon: parseFloat(j[0].lon)};
    return null;
  }

  // ====== 生成地图点（小地图 + 全屏地图共用）=====
  async function genMapPins(onlyRecolor=false, forFS=false){
    ensureSmallMap();
    if(forFS) ensureFSMap();

    // 清旧点
    if(!onlyRecolor) clearMaps();
    else{
      // 仅重染：也清掉再画（最稳定）
      clearMaps();
    }

    // 先把有坐标的直接画，没坐标的再逐个查
    const need = [];
    for(const it of items){
      if(it.lat!=null && it.lon!=null) continue;
      need.push(it);
    }

    // 先画已有的
    drawPins(mapSmall, markersSmall);
    if(mapFS) drawPins(mapFS, markersFS);

    if(onlyRecolor){
      fitIfAny();
      return;
    }

    // 分批查：避免一次太多
    for(let k=0;k<need.length;k++){
      const it = need[k];
      try{
        const geo = await geocode(it.addr);
        if(geo){
          it.lat = geo.lat;
          it.lon = geo.lon;
          save();
          // 查到一个就补一个点
          drawSingle(it, mapSmall, markersSmall);
          if(mapFS) drawSingle(it, mapFS, markersFS);
        }
      }catch(e){}
      // 轻微延迟，友好一点
      await sleep(350);
    }
    fitIfAny();
  }

  function drawPins(map, bucket){
    items.forEach(it=> drawSingle(it, map, bucket));
  }

  function drawSingle(it, map, bucket){
    if(it.lat==null || it.lon==null) return;

    const color = it.delivered ? "green" : "red";
    const html = `<div class="pin ${color}">${escapeHtml(it.no)}</div>`;
    const icon = L.divIcon({className:"", html, iconSize:[46,46], iconAnchor:[23,23]});

    const mk = L.marker([it.lat, it.lon], {icon}).addTo(map);
    mk.on("click", ()=>{
      // 点图钉：弹一个很简单的卡片（不复杂）
      const card = `
        <div style="font-weight:900;margin-bottom:6px;">NO.${escapeHtml(it.no)}</div>
        <div style="color:#333;margin-bottom:10px;line-height:1.2;">${escapeHtml(it.addr)}</div>
        <button style="background:#1a73e8;color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:900;"
          onclick="window._navFromMap('${escapeJs(it.no)}')">▶ 导航（自动✅）</button>
      `;
      mk.bindPopup(card, {closeButton:true}).openPopup();
    });

    bucket.push(mk);
  }

  // 给地图 popup 用：用号码找到对应 item，然后导航并勾选
  window._navFromMap = function(no){
    const idx = items.findIndex(x=>x.no===no);
    if(idx>=0) goNav(idx);
  }

  function fitIfAny(){
    const pts = items.filter(x=>x.lat!=null && x.lon!=null).map(x=>[x.lat,x.lon]);
    if(!pts.length) return;
    const b = L.latLngBounds(pts);
    if(mapSmall) mapSmall.fitBounds(b.pad(0.2));
    if(mapFS) mapFS.fitBounds(b.pad(0.2));
  }

  function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

  // ====== 全屏：稳定方案（弹层 + 把地图搬进去）=====
  function ensureFSMap(){
    if(mapFS) return;

    // 在全屏容器里初始化一张地图
    mapFS = L.map('mapFSInner', { zoomControl: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(mapFS);

    mapFS.setView([40.4406, -79.9959], 10);
  }

  function openFullScreen(){
    ensureFSMap();
    document.getElementById("fsMask").classList.add("show");
    document.getElementById("fsPanel").classList.add("show");

    // 关键：弹层显示后再刷新尺寸
    setTimeout(()=>{
      mapFS.invalidateSize();
      // 如果小地图已经有点，把点也生成到全屏图
      if(markersSmall.length) genMapPins(true, true);
      fitIfAny();
    }, 200);
  }

  function closeFullScreen(){
    document.getElementById("fsMask").classList.remove("show");
    document.getElementById("fsPanel").classList.remove("show");
  }

  // ====== 安全输出 ======
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }
  function escapeJs(s){
    return String(s).replace(/\\/g,"\\\\").replace(/'/g,"\\'");
  }

  load();
</script>
</body>
</html>
