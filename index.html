<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>å•ç‚¹å¯¼èˆªï¼ˆçº¯åˆ—è¡¨æœ€ç»ˆç‰ˆ + OCRï¼‰</title>

  <!-- OCR å¼•æ“ï¼šTesseract.js -->
  <script src="https://unpkg.com/tesseract.js@5.1.1/dist/tesseract.min.js"></script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --line:#e8e8ee;
      --blue:#1a73e8; --dark:#111; --muted:#666;
      --green:#1bbf5c;
    }
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial}
    .wrap{max-width:860px;margin:0 auto;padding:12px}
    h2{margin:8px 0 10px;font-size:26px}
    textarea{
      width:100%;height:160px;box-sizing:border-box;border-radius:14px;border:1px solid var(--line);
      padding:12px;font-size:14px;line-height:1.35;background:#fff
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;align-items:center}
    button{border:0;border-radius:14px;padding:12px 16px;font-size:16px;font-weight:900}
    .primary{background:var(--blue);color:#fff}
    .ghost{background:#fff;border:1px solid var(--line);color:#111}
    .danger{background:#fff;border:1px solid #ffb3b3;color:#c62828}
    .stat{
      background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px;
      font-size:16px;font-weight:1000;display:flex;gap:12px;flex-wrap:wrap;align-items:center
    }
    .sortbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .sortbtn{background:#fff;border:1px solid var(--line);color:#111}
    .sortbtn.on{background:var(--blue);border-color:var(--blue);color:#fff}
    .search{
      width:100%;box-sizing:border-box;margin-top:10px;
      border:1px solid var(--line);border-radius:14px;padding:10px 12px;font-size:14px;background:#fff
    }
    .list{margin-top:10px}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:18px;
      padding:14px;display:flex;justify-content:space-between;align-items:center;gap:12px;
      margin-top:10px;
    }
    .left{min-width:0;display:flex;gap:12px;align-items:flex-start}
    .no{
      background:var(--dark);color:#fff;border-radius:14px;padding:10px 12px;
      font-weight:1100;font-size:16px;line-height:1;
      flex:0 0 auto
    }
    .addr{font-size:15px;font-weight:1000;line-height:1.25;word-break:break-word}
    .sub{font-size:12px;color:var(--muted);margin-top:4px;font-weight:700}
    .actions{display:flex;gap:10px;align-items:center;flex:0 0 auto}
    .chk{width:22px;height:22px;transform:scale(1.15)}
    .navbtn{background:var(--blue);color:#fff;border-radius:14px;padding:12px 14px;font-weight:1100}
    .delivered{opacity:.45}

    .small{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35}
    .hint{background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px;margin-top:10px}
    .progress{font-weight:900;color:#111}
    .fileHidden{display:none}
  </style>
</head>

<body>
<div class="wrap">
  <h2>å•ç‚¹å¯¼èˆªï¼ˆçº¯åˆ—è¡¨æœ€ç»ˆç‰ˆ + OCRï¼‰</h2>

  <textarea id="input" placeholder="æ–¹å¼1ï¼šæ¯è¡Œä¸€å•ï¼ˆè·¯çº¿å· ç©ºæ ¼ åœ°å€ï¼‰
ä¾‹ï¼š
804 1040 ELKTON ST, Pittsburgh, PA
805 516 Lorenz Ave, Pittsburgh, PA

æ–¹å¼2ï¼šç‚¹ã€è¯†åˆ«æˆªå›¾ã€‘ä¸Šä¼ æˆªå›¾ï¼ˆæœ€å¤š9å¼ ï¼‰ï¼Œè‡ªåŠ¨æå–â€œè·¯çº¿å·+åœ°å€â€"></textarea>

  <div class="row">
    <button class="primary" id="btnBuild">ç”Ÿæˆåˆ—è¡¨</button>

    <button class="ghost" id="btnOCR">ğŸ“· è¯†åˆ«æˆªå›¾ï¼ˆæœ€å¤š9å¼ ï¼‰</button>
    <input id="file" class="fileHidden" type="file" accept="image/*" multiple />

    <button class="ghost" id="btnPaste">ğŸ“‹ ä»å‰ªè´´æ¿ç²˜è´´</button>

    <button class="ghost" id="btnCopyAll">å¤åˆ¶ï¼ˆå¸¦çº¿è·¯å·ï¼‰</button>
    <button class="ghost" id="btnCopyAddr">åªå¤åˆ¶åœ°å€</button>

    <button class="danger" id="btnClear">æ¸…ç©ºä»Šå¤©</button>
  </div>

  <div class="stat" id="stat">ğŸ“¦ ä»Šæ—¥å…± 0 å• ï½œ âœ… å·²é€ 0 ï½œ ğŸ•’ å‰©ä½™ 0</div>

  <div class="sortbar">
    <button class="sortbtn on" id="sortAsc">â–² çº¿è·¯å·å‡åº</button>
    <button class="sortbtn" id="sortDesc">â–¼ çº¿è·¯å·é™åº</button>
  </div>

  <input class="search" id="search" placeholder="æœç´¢ï¼šè¾“å…¥çº¿è·¯å· / è¡—é“ / åŸå¸‚ï¼ˆä¾‹å¦‚ 804 æˆ– Chestnutï¼‰" />

  <div class="hint">
    <div class="progress" id="progress">OCR æœªå¼€å§‹</div>
    <div class="small">
      é‡è¦ï¼šä½ çš„æˆªå›¾åƒ UniUni è¿™ç§â€œå¡ç‰‡å¾ˆå¤šå­—â€ï¼ŒOCR ä¸€å®šä¼šè¯»å‡ºä¸€å †å™ªéŸ³ã€‚<br/>
      è¿™ä¸ªç‰ˆæœ¬ä¼šå¼ºåˆ¶åªæå–ï¼š<b>1~4ä½è·¯çº¿å·</b> + <b>åœ°å€ï¼ˆå« PAï¼‰</b>ï¼Œå…¶ä½™å…¨éƒ¨ä¸¢æ‰ã€‚<br/>
      å¦‚æœä½ ç”¨â€œé•¿æˆªå›¾â€ï¼Œåˆ†è¾¨ç‡ä¼šä¸‹é™ï¼Œå»ºè®®ï¼š<b>æœ€å¤šæ¯å¼ æˆª 6~10 æ¡</b>ï¼ˆæ¸…æ™°å¾ˆå¤šï¼‰ã€‚
    </div>
  </div>

  <div class="list" id="list"></div>

  <div class="small">æç¤ºï¼šç‚¹â€œå¯¼èˆªâ€ä¼šè‡ªåŠ¨âœ…ã€‚æ¯å¤©çº¿è·¯å·ä¸ä¸€æ ·ä¹Ÿæ²¡å…³ç³»ï¼Œç²˜è´´å½“å¤©çš„å°±è¡Œã€‚</div>
</div>

<script>
/* ========= æ¯å¤©ç‹¬ç«‹å­˜å‚¨ ========= */
function todayKey(){
  const d=new Date();
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
const K_INPUT = "rn:input:"+todayKey();
const K_DONE  = "rn:done:"+todayKey();
const K_SORT  = "rn:sort";

let doneSet = new Set(JSON.parse(localStorage.getItem(K_DONE) || "[]"));
let sortMode = localStorage.getItem(K_SORT) || "asc"; // asc/desc
let orders = []; // {id,noStr,noNum,addr,done}

/* ========= DOM ========= */
const elInput = document.getElementById('input');
const elList  = document.getElementById('list');
const elStat  = document.getElementById('stat');
const elSearch= document.getElementById('search');
const elProgress=document.getElementById('progress');
const elFile = document.getElementById('file');

document.getElementById('btnBuild').addEventListener('click', buildList);
document.getElementById('btnClear').addEventListener('click', clearToday);
document.getElementById('btnCopyAll').addEventListener('click', ()=>copyText(makeCopyText(true)));
document.getElementById('btnCopyAddr').addEventListener('click', ()=>copyText(makeCopyText(false)));
document.getElementById('btnPaste').addEventListener('click', pasteClipboard);

document.getElementById('sortAsc').addEventListener('click', ()=>setSort("asc"));
document.getElementById('sortDesc').addEventListener('click', ()=>setSort("desc"));

document.getElementById('btnOCR').addEventListener('click', ()=>{
  elFile.value = "";
  elFile.click();
});
elFile.addEventListener('change', async ()=>{
  const files = Array.from(elFile.files || []);
  if(!files.length) return;
  if(files.length>9){
    alert("æœ€å¤šé€‰æ‹© 9 å¼ å›¾");
    return;
  }
  await ocrImages(files);
});

elSearch.addEventListener('input', renderList);

/* ========= æ¢å¤è¾“å…¥ ========= */
elInput.value = localStorage.getItem(K_INPUT) || "";
elInput.addEventListener('input', ()=> localStorage.setItem(K_INPUT, elInput.value));

/* ========= æ’åº ========= */
function setSort(mode){
  sortMode = mode;
  localStorage.setItem(K_SORT, sortMode);
  document.getElementById('sortAsc').classList.toggle('on', sortMode==="asc");
  document.getElementById('sortDesc').classList.toggle('on', sortMode==="desc");
  renderAll();
}
function sortOrders(arr){
  const a = arr.slice();
  a.sort((x,y)=>{
    if(sortMode==="asc") return x.noNum - y.noNum;
    return y.noNum - x.noNum;
  });
  return a;
}

/* ========= è§£æè¾“å…¥ï¼ˆæ‰‹åŠ¨ç²˜è´´ï¼‰ ========= */
function parseLines(text){
  const lines = text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const out = [];
  for(const line of lines){
    const m = line.match(/^(?:NO\.?\s*)?(\d{1,4})[,\sï¼Œ]+(.+)$/i);
    if(m){
      out.push({noStr:m[1], noNum:parseInt(m[1],10), addr:cleanupAddr(m[2])});
    }
  }
  return out;
}

/* ========= OCRï¼šå…³é”®åœ¨è¿™é‡Œï¼ˆå¼ºåŠ›æå–â€œè·¯çº¿å·+åœ°å€â€ï¼‰ ========= */
/*
  æˆ‘ä»¬åªä¿¡è¿™ä¸ªæ¨¡å¼ï¼š
  (1~4ä½è·¯çº¿å·) + (è¡—é“å·+è¡—é“å ... , City, PA [zip])
  å…¶ä½™å™ªéŸ³ä¸€å¾‹æ‰”æ‰
*/
function extractNoAddrPairs(raw){
  let s = String(raw || "");
  // ç»Ÿä¸€ç©ºç™½
  s = s.replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim();

  // å¸¸è§ OCR é”™æŠŠé€—å·/ç‚¹æä¹±ï¼šå…ˆç²—æ¸…æ´—
  s = s.replace(/[|]/g,' ').replace(/[â€œâ€]/g,'"');

  const results = [];

  // åœ°å€å…³é”®è¯ï¼šå¿…é¡»å‡ºç° PAï¼ˆè¿™æ ·èƒ½è¿‡æ»¤æ‰äººåã€æ—¥æœŸã€å•å·ç­‰å™ªéŸ³ï¼‰
  // street suffix å°½é‡å¤šä¸€ç‚¹
  const suffix = "(?:St|Street|Ave|Avenue|Rd|Road|Dr|Drive|Ln|Lane|Blvd|Boulevard|Ct|Court|Pl|Place|Way|Pkwy|Parkway|Ter|Terrace|Cir|Circle|Hwy|Highway|Ste|Suite|Apt|Unit)";
  const city = "(?:Pittsburgh|Crafton|McKees\\s*Rocks|Rosslyn\\s*Farms|Allegheny|Ingram|Carnegie|Coraopolis)";
  const addrPattern =
    "(\\d{1,6}\\s+[A-Za-z0-9#.'\\- ]+\\s+"+suffix+"(?:\\s+[A-Za-z0-9#.'\\- ]+)*)\\s*,?\\s*"+city+"\\s*,?\\s*(?:PA|PENN(?:SYLVANIA)?)\\s*(\\d{5})?";

  // è·¯çº¿å· + åœ°å€ï¼šè·¯çº¿å·å…è®¸ä¸åœ°å€ä¹‹é—´å¤¹æ‚å°‘é‡å™ªéŸ³ï¼ˆæ¯”å¦‚ OCR æŠŠ NO. è¯†åˆ«ä¸¢äº†ï¼‰
  const re = new RegExp("(?:NO\\.?\\s*)?(\\d{1,4})\\s+[^0-9]{0,20}?"+addrPattern, "ig");

  let m;
  while((m = re.exec(s)) !== null){
    const no = m[1];
    const street = m[2];
    const zip = m[3] ? (" "+m[3]) : "";
    // ç»Ÿä¸€æˆ â€œstreet, City, PA zipâ€
    // è¿™é‡Œ City ç”¨åŸåŒ¹é…ä¸²é‡ŒåŒ…å«çš„ cityï¼ˆåœ¨ streetPatternåé¢ï¼‰ï¼Œä½†æˆ‘ä»¬æ²¡å•ç‹¬æ•è·ï¼Œç®€å•ç”¨åŸ m[0] å†æä¸€æ¬¡
    const chunk = m[0];

    // ä» chunk é‡Œå†æŠ“ä¸€æ¬¡ city+PA
    const cm = chunk.match(new RegExp(city, "i"));
    const cityText = cm ? cm[0].replace(/\s+/g,' ') : "Pittsburgh";

    const addr = cleanupAddr(street + ", " + cityText + ", PA" + zip);
    results.push({noStr:no, noNum:parseInt(no,10), addr});
  }

  // å»é‡
  const seen = new Set();
  const uniq = [];
  for(const r of results){
    const k = r.noStr + "||" + r.addr.toLowerCase();
    if(seen.has(k)) continue;
    seen.add(k);
    uniq.push(r);
  }
  return uniq;
}

function cleanupAddr(a){
  let s = String(a||"").trim();
  // å»æ‰å¤šä½™çœç•¥å·å’Œå¥‡æ€ªç¬¦å·
  s = s.replace(/â€¦+/g,'').replace(/\s+/g,' ');
  // ä¿® normalï¼šé€—å·å‰ç©ºæ ¼
  s = s.replace(/\s+,/g,',');
  // ä¿® Pittsburgh P... è¿™ç§
  s = s.replace(/Pittsburgh\s*P\.*\b/ig,"Pittsburgh, PA");
  s = s.replace(/PENN\.*\b/ig,"PA");
  return s.trim();
}

/* ========= OCR å›¾ç‰‡é¢„å¤„ç†ï¼šæ”¾å¤§ + é»‘ç™½åŒ–ï¼ˆå‡å°‘ä¹±ç ï¼‰ ========= */
async function preprocessImageToCanvas(file){
  const img = await loadImage(file);
  const scale = 2; // æ”¾å¤§ 2 å€æ›´åˆ©äº OCR
  const w = Math.round(img.width * scale);
  const h = Math.round(img.height * scale);

  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const ctx = c.getContext('2d', {willReadFrequently:true});
  ctx.drawImage(img, 0, 0, w, h);

  const data = ctx.getImageData(0,0,w,h);
  const d = data.data;

  // ç°åº¦ + ç®€å•é˜ˆå€¼äºŒå€¼åŒ–ï¼ˆåä¿å®ˆï¼‰
  for(let i=0;i<d.length;i+=4){
    const r=d[i], g=d[i+1], b=d[i+2];
    const gray = (r*0.299 + g*0.587 + b*0.114);
    const v = gray > 160 ? 255 : 0; // é˜ˆå€¼å¯è°ƒ
    d[i]=d[i+1]=d[i+2]=v;
    d[i+3]=255;
  }
  ctx.putImageData(data,0,0);
  return c;
}
function loadImage(file){
  return new Promise((res,rej)=>{
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = ()=>{ URL.revokeObjectURL(url); res(img); };
    img.onerror = rej;
    img.src = url;
  });
}

/* ========= OCR ä¸»æµç¨‹ ========= */
async function ocrImages(files){
  elProgress.textContent = "OCR å¤„ç†ä¸­â€¦ï¼ˆç¬¬ä¸€æ¬¡ä¼šæ…¢ä¸€ç‚¹ï¼‰";
  try{
    const allPairs = [];
    for(let i=0;i<files.length;i++){
      elProgress.textContent = `OCR å¤„ç†ä¸­â€¦ ç¬¬ ${i+1}/${files.length} å¼ `;
      const canvas = await preprocessImageToCanvas(files[i]);

      const { data } = await Tesseract.recognize(
        canvas,
        "eng", // åœ°å€æ˜¯è‹±æ–‡ï¼Œç”¨ eng å‡å°‘ä¹±ç 
        {
          logger: m => {
            // åªæ˜¾ç¤ºå…³é”®è¿›åº¦
            if(m.status === "recognizing text"){
              const pct = Math.round((m.progress||0)*100);
              elProgress.textContent = `OCR å¤„ç†ä¸­â€¦ ç¬¬ ${i+1}/${files.length} å¼ ï¼ˆ${pct}%ï¼‰`;
            }
          }
        }
      );

      const text = (data && data.text) ? data.text : "";
      const pairs = extractNoAddrPairs(text);
      allPairs.push(...pairs);
    }

    // å†™å›è¾“å…¥æ¡†ï¼šæŒ‰â€œçº¿è·¯å· åœ°å€â€æ¯è¡Œ
    if(!allPairs.length){
      elProgress.textContent = "OCR å®Œæˆï¼Œä½†æ²¡æå–åˆ°æœ‰æ•ˆåœ°å€ï¼ˆéœ€è¦åŒ…å« PAï¼‰ã€‚å»ºè®®æ¢æ›´æ¸…æ™°çš„æˆªå›¾ã€‚";
      alert("æ²¡æå–åˆ°æœ‰æ•ˆçš„â€œè·¯çº¿å·+åœ°å€â€ã€‚å»ºè®®æˆªå›¾æ›´æ¸…æ™°ï¼Œæˆ–æ¯å¼ æˆªå›¾å°‘ä¸€äº›æ¡ç›®ã€‚");
      return;
    }

    // åˆå¹¶å»é‡
    const seen = new Set();
    const uniq = [];
    for(const p of allPairs){
      const k = p.noStr + "||" + p.addr.toLowerCase();
      if(seen.has(k)) continue;
      seen.add(k);
      uniq.push(p);
    }

    // ç›´æ¥è¾“å‡ºåˆ° textareaï¼ˆä½ ä¹Ÿå¯ä»¥å†æ‰‹åŠ¨åˆ å‡ è¡Œï¼‰
    elInput.value = uniq.map(x=>`${x.noStr} ${x.addr}`).join("\n");
    localStorage.setItem(K_INPUT, elInput.value);

    elProgress.textContent = `OCR å®Œæˆ âœ… æå–åˆ° ${uniq.length} æ¡ï¼ˆå·²è‡ªåŠ¨è¿‡æ»¤ä¹±ç ï¼‰`;
    buildList();
  }catch(e){
    console.error(e);
    elProgress.textContent = "OCR å‡ºé”™äº†ï¼ˆå¯èƒ½ç½‘ç»œ/CDN æˆ–å›¾ç‰‡å¤ªå¤§ï¼‰ã€‚";
    alert("OCR å‡ºé”™äº†ï¼šè¯·æ¢å‡ å¼ æ›´å°çš„æˆªå›¾ï¼Œæˆ–åˆ†æˆä¸¤æ¬¡ï¼ˆæ¯æ¬¡ 4~6 å¼ ï¼‰ã€‚");
  }
}

/* ========= æ„å»ºåˆ—è¡¨ ========= */
function buildList(){
  const parsed = parseLines(elInput.value || "");
  // ç”¨ â€œno+addrâ€ åšå”¯ä¸€é”®ï¼ˆæ¯å¤©ä¸ä¸€æ ·æ²¡å…³ç³»ï¼‰
  orders = parsed.map(p=>{
    const id = p.noStr + "||" + p.addr;
    return {
      id,
      noStr:p.noStr,
      noNum:p.noNum,
      addr:p.addr,
      done: doneSet.has(id)
    };
  });

  // å»é‡ï¼ˆé˜²æ­¢ä½ è´´é‡å¤ï¼‰
  const seen = new Set();
  orders = orders.filter(o=>{
    const k = o.noStr + "||" + o.addr.toLowerCase();
    if(seen.has(k)) return false;
    seen.add(k); return true;
  });

  renderAll();
  saveDone();
}

/* ========= ç»Ÿè®¡ ========= */
function renderStat(){
  const total = orders.length;
  const sent = orders.filter(o=>o.done).length;
  elStat.textContent = `ğŸ“¦ ä»Šæ—¥å…± ${total} å• ï½œ âœ… å·²é€ ${sent} ï½œ ğŸ•’ å‰©ä½™ ${total - sent}`;
}

/* ========= åˆ—è¡¨æ¸²æŸ“ ========= */
function renderList(){
  elList.innerHTML = "";
  const q = (elSearch.value || "").trim().toLowerCase();

  let view = sortOrders(orders);
  if(q){
    view = view.filter(o => (o.noStr+" "+o.addr).toLowerCase().includes(q));
  }

  view.forEach(o=>{
    const card = document.createElement('div');
    card.className = "card" + (o.done ? " delivered" : "");
    card.innerHTML = `
      <div class="left">
        <div class="no">NO.${escapeHtml(o.noStr)}</div>
        <div style="min-width:0">
          <div class="addr">${escapeHtml(o.addr)}</div>
          <div class="sub">ç‚¹å¯¼èˆªè‡ªåŠ¨âœ… ï½œ å¯å‡åº/é™åº</div>
        </div>
      </div>
      <div class="actions">
        <input class="chk" type="checkbox" ${o.done?"checked":""} />
        <button class="navbtn">â–¶ å¯¼èˆª</button>
      </div>
    `;

    card.querySelector('input').addEventListener('change', (e)=>{
      o.done = e.target.checked;
      if(o.done) doneSet.add(o.id);
      else doneSet.delete(o.id);
      saveDone();
      renderAll();
    });

    card.querySelector('.navbtn').addEventListener('click', ()=>{
      startNav(o);
    });

    elList.appendChild(card);
  });

  renderStat();
}

function renderAll(){
  renderStat();
  renderList();
}

/* ========= å·²é€å­˜å‚¨ ========= */
function saveDone(){
  localStorage.setItem(K_DONE, JSON.stringify([...doneSet]));
}

/* ========= å¯¼èˆªï¼šGoogle Maps ========= */
function startNav(o){
  // è‡ªåŠ¨âœ…
  if(!o.done){
    o.done = true;
    doneSet.add(o.id);
    saveDone();
    renderAll();
  }
  const url = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(o.addr) + "&travelmode=driving";
  window.location.href = url;
}

/* ========= å¤åˆ¶ ========= */
function makeCopyText(withNo){
  const view = sortOrders(orders);
  if(withNo) return view.map(o=>`${o.noStr} ${o.addr}`).join("\n");
  return view.map(o=>o.addr).join("\n");
}
async function copyText(txt){
  try{
    await navigator.clipboard.writeText(txt);
    alert("å·²å¤åˆ¶ âœ…");
  }catch(e){
    const ta = document.createElement('textarea');
    ta.value = txt;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    alert("å·²å¤åˆ¶ âœ…");
  }
}

/* ========= ä»å‰ªè´´æ¿ç²˜è´´ ========= */
async function pasteClipboard(){
  try{
    const t = await navigator.clipboard.readText();
    if(!t){ alert("å‰ªè´´æ¿æ²¡æœ‰å†…å®¹"); return; }
    elInput.value = t.trim();
    localStorage.setItem(K_INPUT, elInput.value);
    buildList();
  }catch(e){
    alert("æ— æ³•è¯»å–å‰ªè´´æ¿ï¼ˆiPhone æœ‰æ—¶éœ€è¦ä½ å…ˆç‚¹ä¸€ä¸‹è¾“å…¥æ¡†å†è¯•ï¼‰");
  }
}

/* ========= æ¸…ç©ºä»Šå¤© ========= */
function clearToday(){
  if(!confirm("ç¡®è®¤æ¸…ç©ºä»Šå¤©ï¼Ÿï¼ˆå·²é€çŠ¶æ€ä¹Ÿä¼šæ¸…ç©ºï¼‰")) return;
  doneSet = new Set();
  localStorage.removeItem(K_INPUT);
  localStorage.removeItem(K_DONE);
  elInput.value = "";
  orders = [];
  elProgress.textContent = "OCR æœªå¼€å§‹";
  renderAll();
}

/* ========= å®‰å…¨è¾“å‡º ========= */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

/* ========= åˆå§‹åŒ– ========= */
(function init(){
  document.getElementById('sortAsc').classList.toggle('on', sortMode==="asc");
  document.getElementById('sortDesc').classList.toggle('on', sortMode==="desc");

  // è‡ªåŠ¨ç”Ÿæˆä¸€æ¬¡ï¼ˆå¦‚æœä½ ä¹‹å‰æœ‰ä¿å­˜ï¼‰
  buildList();
})();
</script>
</body>
</html>
