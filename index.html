<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>å•ç‚¹å¯¼èˆªï¼ˆçº¯åˆ—è¡¨æœ€ç»ˆç‰ˆ + OCRï¼‰</title>

  <!-- Tesseract.js (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --line:#e8e8ee;
      --blue:#1a73e8; --dark:#111; --muted:#666;
      --green:#1bbf5c; --red:#c62828; --chip:#0b0b0b;
    }
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial}
    .wrap{max-width:860px;margin:0 auto;padding:12px}
    h2{margin:8px 0 10px;font-size:26px;letter-spacing:.5px}

    textarea{
      width:100%;height:150px;box-sizing:border-box;border-radius:14px;border:1px solid var(--line);
      padding:12px;font-size:14px;line-height:1.35;background:#fff
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;align-items:center}
    button{border:0;border-radius:14px;padding:12px 16px;font-size:16px;font-weight:900;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .primary{background:var(--blue);color:#fff}
    .ghost{background:#fff;border:1px solid var(--line);color:#111}
    .danger{background:#fff;border:1px solid #ffb3b3;color:var(--red)}
    .chip{background:#111;color:#fff;border-radius:14px;padding:10px 12px;font-weight:1000}

    .stat{
      background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px;
      font-size:16px;font-weight:1000;display:flex;gap:12px;flex-wrap:wrap;align-items:center
    }

    .sortbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .sortbtn{background:#fff;border:1px solid var(--line);color:#111}
    .sortbtn.on{background:var(--blue);border-color:var(--blue);color:#fff}

    .search{
      width:100%;box-sizing:border-box;margin-top:10px;
      border:1px solid var(--line);border-radius:14px;padding:10px 12px;font-size:14px;background:#fff
    }

    .small{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.4}

    .list{margin-top:10px}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:18px;
      padding:14px;display:flex;justify-content:space-between;align-items:center;gap:12px;
      margin-top:10px;
    }
    .left{min-width:0;display:flex;gap:12px;align-items:flex-start}
    .no{
      background:#0b0b0b;color:#fff;border-radius:14px;padding:10px 12px;
      font-weight:1000;font-size:16px;line-height:1;flex:0 0 auto;
      min-width:78px;text-align:center;
    }
    .addr{font-size:15px;font-weight:900;line-height:1.25;word-break:break-word}
    .sub{font-size:12px;color:var(--muted);margin-top:4px;font-weight:700}

    .actions{display:flex;gap:10px;align-items:center;flex:0 0 auto}
    .chk{width:22px;height:22px;transform:scale(1.15)}
    .navbtn{background:var(--blue);color:#fff;border-radius:14px;padding:12px 14px;font-weight:1000}
    .editbtn{background:#fff;border:1px solid var(--line);color:#111;border-radius:14px;padding:12px 12px;font-weight:1000}
    .delivered{opacity:.45}

    .progressBox{
      margin-top:10px;background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px;
      font-size:13px;color:#333;line-height:1.4
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .ok{color:var(--green);font-weight:1000}
    .warn{color:#b35a00;font-weight:900}
    .err{color:var(--red);font-weight:1000}

    /* iOS ç‚¹å‡»æ›´ç¨³ */
    button, input { -webkit-tap-highlight-color: transparent; }
  </style>
</head>

<body>
<div class="wrap">
  <h2>å•ç‚¹å¯¼èˆªï¼ˆçº¯åˆ—è¡¨æœ€ç»ˆç‰ˆ + OCRï¼‰</h2>

  <textarea id="input" placeholder="ä½ å¯ä»¥ï¼š1ï¼‰ç²˜è´´æ–‡æœ¬ï¼›2ï¼‰ç‚¹ã€è¯†åˆ«æˆªå›¾ã€‘æœ€å¤š9å¼ 
æ ¼å¼ï¼šæ¯è¡Œä¸€å•ï¼ˆçº¿è·¯å· ç©ºæ ¼ åœ°å€ï¼‰
ä¾‹ï¼š
804 1040 Elkton St, Pittsburgh, PA
805 516 Lorenz Ave, Pittsburgh, PA"></textarea>

  <div class="row">
    <button class="primary" id="btnBuild">ç”Ÿæˆåˆ—è¡¨</button>

    <label class="ghost" style="display:inline-flex;align-items:center;gap:10px;font-weight:1000;padding:12px 16px;border-radius:14px;cursor:pointer;">
      ğŸ“· è¯†åˆ«æˆªå›¾ï¼ˆæœ€å¤š9å¼ ï¼‰
      <input id="imgInput" type="file" accept="image/*" multiple style="display:none" />
    </label>

    <button class="ghost" id="btnPaste">ğŸ“‹ ä»å‰ªè´´æ¿ç²˜è´´</button>
    <button class="ghost" id="btnCopyAll">å¤åˆ¶ï¼ˆå¸¦çº¿è·¯å·ï¼‰</button>
    <button class="ghost" id="btnCopyAddr">åªå¤åˆ¶åœ°å€</button>
    <button class="danger" id="btnClear">æ¸…ç©ºä»Šå¤©</button>
  </div>

  <div class="stat" id="stat">ğŸ“¦ ä»Šæ—¥å…± 0 å• ï½œ âœ… å·²é€ 0 ï½œ ğŸ•’ å‰©ä½™ 0</div>

  <div class="sortbar" id="sortbar">
    <button class="sortbtn on" id="sortAsc">ğŸ”¼ çº¿è·¯å·å‡åº</button>
    <button class="sortbtn" id="sortDesc">ğŸ”½ çº¿è·¯å·é™åº</button>
  </div>

  <input class="search" id="search" placeholder="æœç´¢ï¼šè¾“å…¥çº¿è·¯å· / è¡—é“ / åŸå¸‚ï¼ˆä¾‹å¦‚ 804 æˆ– Chestnutï¼‰" />

  <div id="progress" class="progressBox" style="display:none"></div>

  <div class="list" id="list"></div>

  <div class="small">
    âœ… è§„åˆ™ï¼šç‚¹â€œå¯¼èˆªâ€è‡ªåŠ¨å‹¾é€‰ã€‚<br/>
    âœ… æ¯å¤©çº¿è·¯å·ä¸åŒæ²¡å…³ç³»ï¼šç³»ç»ŸæŒ‰â€œä»Šå¤©æ—¥æœŸâ€å•ç‹¬ä¿å­˜ã€‚<br/>
    âœ… OCR å¶å°”ä¼šé”™ï¼šä½ å¯ä»¥ç‚¹ âœï¸ ç›´æ¥æ”¹çº¿è·¯å·/åœ°å€ã€‚
  </div>
</div>

<script>
/* ===================== å­˜å‚¨ï¼šæŒ‰å¤© ===================== */
function todayKey(){
  const d=new Date();
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
const K_INPUT = "rn:input:"+todayKey();
const K_DONE  = "rn:done:"+todayKey();
const K_SORT  = "rn:sort";

/* ===================== çŠ¶æ€ ===================== */
let doneSet = new Set(JSON.parse(localStorage.getItem(K_DONE) || "[]"));
let sortMode = localStorage.getItem(K_SORT) || "asc"; // asc / desc
let orders = []; // {id,noStr,noNum,addr,done}

/* ===================== DOM ===================== */
const elInput = document.getElementById('input');
const elList  = document.getElementById('list');
const elStat  = document.getElementById('stat');
const elSearch= document.getElementById('search');
const elProg  = document.getElementById('progress');

const btnBuild = document.getElementById('btnBuild');
const btnClear = document.getElementById('btnClear');
const btnCopyAll = document.getElementById('btnCopyAll');
const btnCopyAddr = document.getElementById('btnCopyAddr');
const btnPaste = document.getElementById('btnPaste');
const imgInput = document.getElementById('imgInput');

document.getElementById('sortAsc').onclick  = ()=>setSort("asc");
document.getElementById('sortDesc').onclick = ()=>setSort("desc");

btnBuild.onclick = buildList;
btnClear.onclick = clearToday;
btnCopyAll.onclick = ()=>copyText(makeCopyText(true));
btnCopyAddr.onclick = ()=>copyText(makeCopyText(false));
btnPaste.onclick = pasteFromClipboard;

elSearch.addEventListener('input', renderList);

elInput.value = localStorage.getItem(K_INPUT) || "";
elInput.addEventListener('input', ()=> localStorage.setItem(K_INPUT, elInput.value));

/* ===================== å·¥å…· ===================== */
function showProgress(html){
  elProg.style.display = "block";
  elProg.innerHTML = html;
}
function hideProgress(){ elProg.style.display="none"; elProg.innerHTML=""; }

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

function saveDone(){ localStorage.setItem(K_DONE, JSON.stringify([...doneSet])); }

function setSort(mode){
  sortMode = mode;
  localStorage.setItem(K_SORT, sortMode);
  document.getElementById('sortAsc').classList.toggle('on', sortMode==="asc");
  document.getElementById('sortDesc').classList.toggle('on', sortMode==="desc");
  renderAll();
}
function sortOrders(arr){
  const a = arr.slice();
  a.sort((x,y)=>{
    if(sortMode==="asc") return x.noNum - y.noNum;
    return y.noNum - x.noNum;
  });
  return a;
}

/* ===================== è§£æï¼ˆæ‰‹åŠ¨ç²˜è´´æ–‡æœ¬ç”¨ï¼‰ ===================== */
function parseLines(text){
  const lines = text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const out = [];
  let auto = 1;
  for(const line of lines){
    // æ”¯æŒï¼šNO.676 / 676, / 676 ç©ºæ ¼
    const m = line.match(/^(?:NO\.?\s*)?(\d{1,4})[,\sï¼Œ]+(.+)$/i);
    if(m){
      out.push({noStr: m[1], noNum: parseInt(m[1],10), addr: m[2].trim()});
    }else{
      // æ²¡æœ‰çº¿è·¯å·ï¼šç»™ä¸€ä¸ª A001ï¼ˆæ’æœ€åï¼‰
      const noStr = "A"+String(auto++).padStart(3,'0');
      out.push({noStr, noNum: 999999 + auto, addr: line});
    }
  }
  return out;
}

/* ===================== æ„å»ºåˆ—è¡¨ ===================== */
function buildList(){
  const parsed = parseLines(elInput.value || "");
  const old = new Map(orders.map(o=>[o.id,o]));

  orders = parsed.map(p=>{
    const id = p.noStr + "||" + p.addr;   // å”¯ä¸€é”®
    const was = old.get(id);
    return {
      id,
      noStr: p.noStr,
      noNum: p.noNum,
      addr: p.addr,
      done: doneSet.has(id) || (was?was.done:false),
    };
  });

  renderAll();
  saveDone();
}

function renderStat(){
  const total = orders.length;
  const sent = orders.filter(o=>o.done).length;
  elStat.textContent = `ğŸ“¦ ä»Šæ—¥å…± ${total} å• ï½œ âœ… å·²é€ ${sent} ï½œ ğŸ•’ å‰©ä½™ ${total - sent}`;
}

function renderList(){
  elList.innerHTML = "";
  const q = (elSearch.value || "").trim().toLowerCase();
  let view = sortOrders(orders);
  if(q){
    view = view.filter(o => (o.noStr+" "+o.addr).toLowerCase().includes(q));
  }

  view.forEach(o=>{
    const card = document.createElement('div');
    card.className = "card" + (o.done ? " delivered" : "");
    card.innerHTML = `
      <div class="left">
        <div class="no">NO.${escapeHtml(o.noStr)}</div>
        <div style="min-width:0">
          <div class="addr">${escapeHtml(o.addr)}</div>
          <div class="sub">ç‚¹å¯¼èˆªè‡ªåŠ¨âœ… ï½œ å¯å‡åº/é™åº</div>
        </div>
      </div>
      <div class="actions">
        <button class="editbtn" title="æ‰‹åŠ¨ä¿®æ”¹">âœï¸</button>
        <input class="chk" type="checkbox" ${o.done?"checked":""} />
        <button class="navbtn">â–¶ å¯¼èˆª</button>
      </div>
    `;

    // æ‰‹åŠ¨æ”¹
    card.querySelector('.editbtn').addEventListener('click', ()=>{
      const newNo = prompt("ä¿®æ”¹çº¿è·¯å·ï¼ˆ1-4ä½æ•°å­—ï¼‰", o.noStr);
      if(newNo===null) return;
      const noClean = String(newNo).trim();
      if(!/^\d{1,4}$/.test(noClean)){
        alert("çº¿è·¯å·å¿…é¡»æ˜¯ 1-4 ä½æ•°å­—");
        return;
      }
      const newAddr = prompt("ä¿®æ”¹åœ°å€ï¼ˆå»ºè®®ä¿ç•™ city/stateï¼‰", o.addr);
      if(newAddr===null) return;
      const addrClean = String(newAddr).trim();
      if(!addrClean){
        alert("åœ°å€ä¸èƒ½ä¸ºç©º");
        return;
      }

      // æ›´æ–° doneSet é‡Œæ—§ID
      const oldId = o.id;
      const wasDone = o.done;
      doneSet.delete(oldId);

      o.noStr = noClean;
      o.noNum = parseInt(noClean,10);
      o.addr = addrClean;
      o.id = o.noStr + "||" + o.addr;

      if(wasDone){
        o.done = true;
        doneSet.add(o.id);
      }
      saveDone();
      // åŒæ­¥å› textareaï¼ˆè®©ä½ å¤åˆ¶æ›´å‡†ï¼‰
      syncTextareaFromOrders();
      renderAll();
    });

    // å‹¾é€‰
    card.querySelector('input').addEventListener('change', (e)=>{
      o.done = e.target.checked;
      if(o.done) doneSet.add(o.id);
      else doneSet.delete(o.id);
      saveDone();
      renderAll();
    });

    // å¯¼èˆª
    card.querySelector('.navbtn').addEventListener('click', ()=> startNav(o));

    elList.appendChild(card);
  });

  renderStat();
}

function renderAll(){ renderStat(); renderList(); }

function syncTextareaFromOrders(){
  // æŒ‰å½“å‰æ’åºå†™å› textareaï¼ˆæ›´ç›´è§‚ï¼‰
  const view = sortOrders(orders);
  elInput.value = view.map(o=>`${o.noStr} ${o.addr}`).join("\n");
  localStorage.setItem(K_INPUT, elInput.value);
}

/* ===================== å¯¼èˆªï¼šGoogle Maps ===================== */
function startNav(o){
  // è‡ªåŠ¨âœ…
  if(!o.done){
    o.done = true;
    doneSet.add(o.id);
    saveDone();
    renderAll();
  }
  const url = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(o.addr) + "&travelmode=driving";
  window.location.href = url;
}

/* ===================== å¤åˆ¶ ===================== */
function makeCopyText(withNo){
  const view = sortOrders(orders);
  if(withNo) return view.map(o=>`${o.noStr} ${o.addr}`).join("\n");
  return view.map(o=>o.addr).join("\n");
}
async function copyText(txt){
  try{
    await navigator.clipboard.writeText(txt);
    alert("å·²å¤åˆ¶ âœ…");
  }catch(e){
    const ta = document.createElement('textarea');
    ta.value = txt;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    alert("å·²å¤åˆ¶ âœ…");
  }
}

/* ===================== æ¸…ç©ºä»Šå¤© ===================== */
function clearToday(){
  if(!confirm("ç¡®å®šæ¸…ç©ºä»Šå¤©çš„æ•°æ®å—ï¼Ÿ")) return;
  orders = [];
  doneSet = new Set();
  localStorage.removeItem(K_DONE);
  localStorage.removeItem(K_INPUT);
  elInput.value = "";
  renderAll();
}

/* ===================== å‰ªè´´æ¿ç²˜è´´ ===================== */
async function pasteFromClipboard(){
  try{
    const text = await navigator.clipboard.readText();
    if(!text) return alert("å‰ªè´´æ¿æ²¡æœ‰æ–‡æœ¬");
    elInput.value = text;
    localStorage.setItem(K_INPUT, elInput.value);
    buildList();
  }catch(e){
    alert("æ— æ³•è¯»å–å‰ªè´´æ¿ï¼ˆiPhone Safari æœ‰æ—¶ä¼šé™åˆ¶ï¼‰ã€‚ä½ å¯ä»¥æ‰‹åŠ¨é•¿æŒ‰ç²˜è´´åˆ°è¾“å…¥æ¡†ã€‚");
  }
}

/* =========================================================
   OCRï¼šæœ€å¤š9å¼ å›¾
   å…³é”®ä¿®æ­£ï¼šä½ çš„è§„åˆ™â€œçº¿è·¯å· > åœ°å€é—¨ç‰Œå·â€
   å¤„ç†æ€è·¯ï¼š
   1) OCR åªè¦è‹±æ–‡+æ•°å­—å³å¯ï¼ˆæ¯”ä¸­è‹±æ··åˆæ›´ç¨³ï¼‰
   2) å…ˆæŠŠæ–‡æœ¬æŒ‰â€œçœ‹èµ·æ¥åƒåœ°å€çš„ä¸€è¡Œâ€æå–
   3) åœ¨æ¯æ¡å€™é€‰é‡Œæ‰¾ä¸¤ä¸ªæ•°å­—ï¼šè¾ƒå¤§çš„å½“çº¿è·¯å·ï¼Œè¾ƒå°çš„å½“é—¨ç‰Œå·ï¼ˆå¦‚æœèƒ½ç¡®è®¤ï¼‰
   4) å¯¹è¢«æ‹†å¼€çš„çº¿è·¯å·åšåˆå¹¶ï¼šå¦‚ "80 5" -> "805"
========================================================= */

imgInput.addEventListener('change', async ()=>{
  const files = Array.from(imgInput.files || []);
  if(!files.length) return;
  if(files.length > 9){
    alert("æœ€å¤šåªèƒ½é€‰ 9 å¼ å›¾");
    imgInput.value = "";
    return;
  }
  await runOCR(files);
  imgInput.value = "";
});

function normalizeOcrText(t){
  // å¸¸è§ä¹±å­—ç¬¦æ¸…ç† + ç»Ÿä¸€ç©ºæ ¼
  return String(t || "")
    .replace(/\u00A0/g, " ")
    .replace(/[|â€œâ€â€˜â€™]/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function looksLikeStreetLine(line){
  const s = line.toUpperCase();
  // å…¸å‹åœ°å€å…³é”®è¯
  const hasStreet =
    /\b(ST|STREET|AVE|AVENUE|RD|ROAD|DR|DRIVE|BLVD|BOULEVARD|LN|LANE|CT|COURT|PL|PLACE|WAY|PIKE|CIR|CIRCLE|TER|TERRACE)\b/.test(s);
  const hasCity = /(PITTSBURGH|ALLEGHENY|CRAFTON|MCKEES|ROCKS|PA)\b/.test(s);
  const hasNumber = /\d{1,5}/.test(s);
  return hasNumber && (hasStreet || hasCity);
}

function mergeSplitRouteNo(str){
  // æŠŠ "8 0 5" / "80 5" åˆå¹¶æˆ "805"
  // è§„åˆ™ï¼šè‹¥å¼€å¤´å‡ºç° 1-4 ä½æ•°å­—è¢«ç©ºæ ¼åˆ†å‰²ï¼Œä¸”åé¢è·Ÿåœ°å€æ•°å­—/å•è¯ï¼Œä¼˜å…ˆåˆå¹¶å‰é¢çš„ç¢ç‰‡
  // ä¾‹ï¼š"80 5 516 LORENZ AVE PITTSBURGH" -> route "805", addr "516 LORENZ..."
  let s = str.replace(/\s+/g, " ").trim();

  // å°è¯•ï¼šå¼€å¤´æœ€å¤š4æ®µæ•°å­—ç¢ç‰‡ï¼Œåˆèµ·æ¥ 1-4 ä½
  const m = s.match(/^(\d)\s+(\d)(?:\s+(\d))?(?:\s+(\d))?\s+/);
  if(m){
    const digits = [m[1],m[2],m[3],m[4]].filter(Boolean).join("");
    if(digits.length>=2 && digits.length<=4){
      s = digits + " " + s.slice(m[0].length);
      return s;
    }
  }

  // å°è¯•ï¼šå‰ä¸¤æ®µåˆå¹¶ï¼ˆ80 5ï¼‰
  const m2 = s.match(/^(\d{1,3})\s+(\d)\s+/);
  if(m2){
    const digits = (m2[1]+m2[2]);
    if(digits.length>=2 && digits.length<=4){
      s = digits + " " + s.slice(m2[0].length);
      return s;
    }
  }
  return s;
}

function extractOneFromLine(line){
  // ç›®æ ‡ï¼šè¿”å› {noStr, addr} æˆ– null
  let s = normalizeOcrText(line);
  if(!s) return null;

  s = mergeSplitRouteNo(s);

  // æŠ½å–å…¨éƒ¨æ•°å­—ï¼ˆæœ€å¤šæŠ“ 1-5 ä½ï¼‰
  const nums = (s.match(/\b\d{1,5}\b/g) || []).map(n=>parseInt(n,10)).filter(n=>!Number.isNaN(n));
  if(nums.length < 1) return null;

  // å°è¯•æ‰¾â€œçº¿è·¯å·â€å’Œâ€œé—¨ç‰Œå·â€
  // ä½ çš„ç»éªŒï¼šçº¿è·¯å· > é—¨ç‰Œå·ï¼ˆå¾ˆå¤šæ—¶å€™çº¿è·¯å·æ˜¯ 700~900ï¼Œé—¨ç‰Œå·æ˜¯ 1~6000ï¼‰
  // å®æ“ï¼šå¦‚æœèƒ½æ‰¾åˆ°ä¸¤ä¸ªæ•°å­—ï¼Œå–è¾ƒå¤§è€…å½“çº¿è·¯å·ï¼Œè¾ƒå°è€…å½“é—¨ç‰Œå·ï¼›
  // ä½†è¦é¿å…æŠŠ 2026/01/18 è¿™ç§æ—¥æœŸå½“æ•°å­—ï¼Œæ‰€ä»¥è¿‡æ»¤ 1900~2100 çš„å¹´ä»½
  const numsFiltered = nums.filter(n => !(n>=1900 && n<=2100)); // å»å¹´ä»½
  const nums2 = numsFiltered.length ? numsFiltered : nums;

  // çº¿è·¯å·å€™é€‰ï¼šä¼˜å…ˆ 1-4 ä½æ•°å­—ï¼Œä¸”é€šå¸¸ä¸è¶…è¿‡ 9999
  // ä»è¡Œé‡ŒæŒ‰å‡ºç°é¡ºåºå–å‰3ä¸ªåšåˆ¤æ–­
  const seen = [];
  for(const m of (s.match(/\b\d{1,5}\b/g) || [])){
    const n = parseInt(m,10);
    if(Number.isNaN(n)) continue;
    if(n>=1900 && n<=2100) continue;
    seen.push(n);
    if(seen.length>=4) break;
  }

  let route = null;

  // ä¼˜å…ˆï¼šè¡Œé¦–å°±æ˜¯çº¿è·¯å·ï¼ˆä½ çš„æˆªå›¾é€šå¸¸å·¦ä¾§å¤§å·ï¼‰
  const head = s.match(/^(\d{1,4})\b/);
  if(head){
    route = parseInt(head[1],10);
  }

  // è‹¥è¡Œé¦–ä¸æ˜¯é è°±ï¼Œå†ç”¨â€œæœ€å¤§å€¼â€ç­–ç•¥ï¼ˆä½†è¦é¿å…æŠŠé—¨ç‰Œå· 5000 å½“çº¿è·¯å·ï¼‰
  // ç»éªŒï¼šçº¿è·¯å·é€šå¸¸ <= 9999 ä¸”å¸¸è§ 1~4 ä½ï¼›é—¨ç‰Œå·å¯èƒ½åˆ° 99999ï¼Œä½†æ›´å¤šåœ¨ 1~9999 ä¹Ÿæœ‰
  // æ‰€ä»¥ï¼šå¦‚æœå­˜åœ¨ä¸¤æ•°ä¸”å¯æ»¡è¶³ route > houseNoï¼Œåˆ™å–èƒ½æ»¡è¶³çš„é‚£ä¸ª
  let house = null;
  if(nums2.length >= 2){
    const max = Math.max(...nums2);
    const min = Math.min(...nums2);
    // åªæœ‰å½“ max çœ‹èµ·æ¥åƒçº¿è·¯å·ï¼ˆ<=9999ï¼‰ä¸” max > min æ—¶æ‰ç”¨
    if(max <= 9999 && max > min){
      route = route && route<=9999 ? route : max;
      house = min;
    }
  }

  // å¦‚æœ route ä»ä¸ºç©ºï¼šæ‰¾ä¸€ä¸ªâ€œçœ‹èµ·æ¥åƒçº¿è·¯å·â€çš„æ•°å­—ï¼ˆ1-4ä½ä¸”ä¸æ˜¯ç‰¹åˆ«aå¹´ä»½ï¼‰
  if(route==null){
    const cand = seen.find(n => n>=1 && n<=9999);
    if(cand!=null) route = cand;
  }

  if(route==null) return null;

  // åœ°å€ï¼šä»è¡Œé‡Œå»æ‰å‰é¢çš„çº¿è·¯å·ï¼Œåªä¿ç•™ä»é—¨ç‰Œå·å¼€å§‹çš„ä¸€æ®µ
  let addr = s;

  // åˆ é™¤æ˜æ˜¾å™ªéŸ³ï¼ˆshipment code / å¤‡æ³¨ï¼‰
  addr = addr.replace(/\bUUS[0-9A-Z]+\b/gi,"").trim();

  // å¦‚æœè¡Œé¦–æ˜¯çº¿è·¯å·ï¼ŒæŠŠå®ƒå‰”é™¤
  addr = addr.replace(new RegExp("^"+route+"\\b\\s*"), "").trim();

  // å¦‚æœèƒ½æ‰¾åˆ°é—¨ç‰Œå· houseï¼Œå°±ä» house å¼€å§‹æˆªå–
  if(house!=null){
    const idx = addr.search(new RegExp("\\b"+house+"\\b"));
    if(idx>0) addr = addr.slice(idx).trim();
  }

  // å†æ¸…ä¸€æ¬¡
  addr = addr
    .replace(/\b(SUSPECTED|APT\/SUSPEC|LEAVE AT|HINT:|ADDRESS TYPE:).*/i, "") // å»å¤‡æ³¨å°¾å·´ï¼ˆå¯æ ¹æ®éœ€è¦åŠ è¯ï¼‰
    .replace(/\s+,/g,",")
    .replace(/\s+/g," ")
    .trim();

  // æœ€åæ ¡éªŒï¼šåƒåœ°å€æ‰æ”¶
  if(!looksLikeStreetLine(addr)) return null;

  return { noStr: String(route), addr };
}

function dedupePairs(pairs){
  const map = new Map();
  for(const p of pairs){
    const key = p.noStr + "||" + p.addr;
    if(!map.has(key)) map.set(key, p);
  }
  return [...map.values()];
}

async function runOCR(files){
  // iPhone ä¸Šé¿å…ä½ ç‹‚ç‚¹ï¼šå…ˆç¦ç”¨æŒ‰é’®
  setUiBusy(true);

  try{
    showProgress(`<div class="mono"><b>OCR å¼€å§‹â€¦</b>ï¼ˆå…± ${files.length} å¼ ï¼Œæœ€å¤š9å¼ ï¼‰</div>
      <div class="mono warn">æç¤ºï¼šé¦–æ¬¡åŠ è½½OCRç»„ä»¶å¯èƒ½ä¼šæ…¢ä¸€ç‚¹ç‚¹ï¼Œåé¢ä¼šå¿«å¾ˆå¤šã€‚</div>`);

    // åˆå§‹åŒ– workerï¼ˆè‹±æ–‡å³å¯ï¼šæ•°å­—+è‹±æ–‡åœ°å€æ›´ç¨³ï¼‰
    const worker = await Tesseract.createWorker("eng", 1, {
      logger: m => {
        if(m && m.status){
          showProgress(`<div class="mono"><b>OCR è¿›è¡Œä¸­â€¦</b></div>
          <div class="mono">çŠ¶æ€ï¼š${escapeHtml(m.status)} ${m.progress!=null ? Math.round(m.progress*100)+"%" : ""}</div>
          <div class="mono">å›¾ç‰‡ï¼šå¤„ç†ä¸­â€¦</div>`);
        }
      }
    });

    const allPairs = [];
    for(let i=0;i<files.length;i++){
      const f = files[i];
      showProgress(`<div class="mono"><b>OCR è¯†åˆ«ä¸­â€¦</b> ${i+1}/${files.length}</div>
        <div class="mono">æ–‡ä»¶ï¼š${escapeHtml(f.name)}</div>`);

      const imgDataUrl = await fileToDataURL(f);

      // åšä¸€ç‚¹ç‚¹é¢„å¤„ç†ï¼šæé«˜å¯¹æ¯”åº¦ï¼ˆç‰¹åˆ«æ˜¯ä½ é‚£ç§ç™½åº•é»‘å­—ï¼‰
      const pre = await preprocessToDataURL(imgDataUrl);

      const { data } = await worker.recognize(pre);

      const raw = (data && data.text) ? data.text : "";
      const lines = raw.split(/\n+/).map(x=>x.trim()).filter(Boolean);

      // åªæŠ“â€œåƒåœ°å€çš„ä¸€è¡Œâ€ï¼Œå¹¶ç”¨ä½ çš„â€œçº¿è·¯å· > é—¨ç‰Œå·â€è§„åˆ™ä¿®å¤
      const pairs = [];
      for(const line of lines){
        const p = extractOneFromLine(line);
        if(p) pairs.push(p);
      }

      // å¦‚æœè¿™ä¸€å¼ è¯†åˆ«åˆ°å¾ˆå°‘ï¼Œè¡¥æ•‘ï¼šæŠŠæ•´ä¸ªæ–‡æœ¬æŒ‰å¥å­æ‹†
      if(pairs.length < 2){
        const rough = normalizeOcrText(raw);
        const chunks = rough.split(/(?<=\bPA\b|\bPITTSBURGH\b|\bALLEGHENY\b)\s+/i);
        for(const c of chunks){
          const p = extractOneFromLine(c);
          if(p) pairs.push(p);
        }
      }

      allPairs.push(...pairs);
    }

    await worker.terminate();

    const finalPairs = dedupePairs(allPairs);

    // å†™å› textareaï¼ˆæŒ‰çº¿è·¯å·å‡åºï¼‰
    const sorted = finalPairs
      .map(p=>({noStr:p.noStr, noNum:parseInt(p.noStr,10)||999999, addr:p.addr}))
      .sort((a,b)=>a.noNum-b.noNum);

    elInput.value = sorted.map(x=>`${x.noStr} ${x.addr}`).join("\n");
    localStorage.setItem(K_INPUT, elInput.value);

    // ç”Ÿæˆåˆ—è¡¨
    buildList();

    showProgress(`<div class="mono ok">OCR å®Œæˆ âœ…</div>
      <div class="mono">æå–åˆ° <b>${finalPairs.length}</b> æ¡ï¼ˆå·²è‡ªåŠ¨å»é‡ï¼‰</div>
      <div class="mono warn">è‹¥æœ‰ä¸ªåˆ«é”™è¯¯ï¼šç‚¹æ¯æ¡å³ä¾§ âœï¸ æ‰‹åŠ¨æ”¹ä¸€ä¸‹æœ€ç¨³ã€‚</div>`);

    // è‡ªåŠ¨æ”¶èµ·æç¤º
    setTimeout(()=>hideProgress(), 2500);

  }catch(e){
    showProgress(`<div class="mono err">OCR å¤±è´¥ï¼š${escapeHtml(e && e.message ? e.message : String(e))}</div>
      <div class="mono">ä½ å¯ä»¥å…ˆç”¨â€œç²˜è´´æ–‡æœ¬â€æ–¹å¼ï¼Œæˆ–æ¢æ›´æ¸…æ™°æˆªå›¾å†è¯•ã€‚</div>`);
  }finally{
    setUiBusy(false);
  }
}

function setUiBusy(busy){
  const dis = !!busy;
  btnBuild.disabled = dis;
  btnClear.disabled = dis;
  btnCopyAll.disabled = dis;
  btnCopyAddr.disabled = dis;
  btnPaste.disabled = dis;
  imgInput.disabled = dis;
}

function fileToDataURL(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

async function preprocessToDataURL(dataUrl){
  // è½»é‡é¢„å¤„ç†ï¼šç°åº¦ + å¢å¼ºå¯¹æ¯”ï¼Œå‡å°‘ä¹±ç 
  const img = await loadImage(dataUrl);
  const maxW = 1400; // æ§åˆ¶å¤§å°ï¼Œé¿å…å¤ªæ…¢
  const scale = Math.min(1, maxW / img.width);
  const w = Math.round(img.width * scale);
  const h = Math.round(img.height * scale);

  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d', { willReadFrequently:true });
  ctx.drawImage(img, 0, 0, w, h);

  const im = ctx.getImageData(0,0,w,h);
  const d = im.data;

  // ç°åº¦ + å¯¹æ¯”æ‹‰ä¼¸
  // å¯¹æ¯”ï¼šy = (y-128)*c + 128
  const c = 1.35;
  for(let i=0;i<d.length;i+=4){
    const r=d[i], g=d[i+1], b=d[i+2];
    let y = (0.299*r + 0.587*g + 0.114*b);
    y = (y-128)*c + 128;
    y = Math.max(0, Math.min(255, y));
    // è½»å¾®é˜ˆå€¼ï¼šè®©å­—æ›´é»‘
    const t = y < 180 ? y*0.85 : y*1.05;
    const v = Math.max(0, Math.min(255, t));
    d[i]=d[i+1]=d[i+2]=v;
  }
  ctx.putImageData(im,0,0);
  return canvas.toDataURL("image/png", 0.92);
}

function loadImage(src){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.onload = ()=>res(img);
    img.onerror = rej;
    img.src = src;
  });
}

/* ===================== åˆå§‹åŒ– ===================== */
(function init(){
  document.getElementById('sortAsc').classList.toggle('on', sortMode==="asc");
  document.getElementById('sortDesc').classList.toggle('on', sortMode==="desc");
  buildList();
})();
</script>
</body>
</html>
