<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å•ç‚¹å¯¼èˆªï¼ˆå‡çº§ç‰ˆï¼‰</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;margin:0;padding:12px;background:#f5f5f5}
  h3{margin:6px 0 10px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  textarea{width:100%;height:170px;border-radius:10px;border:1px solid #ddd;padding:10px;font-size:14px;box-sizing:border-box}
  input{width:100%;border-radius:10px;border:1px solid #ddd;padding:10px;font-size:14px;box-sizing:border-box}
  button{border:0;border-radius:10px;padding:10px 14px;font-size:16px}
  .primary{background:#1a73e8;color:#fff}
  .ghost{background:#fff;border:1px solid #ddd}
  .small{font-size:12px;color:#666;margin:8px 0}
  .stats{display:flex;gap:12px;flex-wrap:wrap}
  .pill{background:#fff;border:1px solid #e5e5e5;border-radius:999px;padding:6px 10px;font-size:13px}
  .card{
    background:#fff;border-radius:12px;padding:12px;margin-top:10px;
    display:flex;justify-content:space-between;align-items:center;gap:10px
  }
  .left{flex:1;min-width:0}
  .addr{font-size:14px;color:#333;word-break:break-word}
  .route{font-weight:800;color:#d60000;margin-right:6px}
  .actions{display:flex;gap:8px;align-items:center}
  .delivered{opacity:.45}
  .check{transform:scale(1.2)}
</style>
</head>
<body>

<h3>å•ç‚¹å¯¼èˆªï¼ˆå‡çº§ç‰ˆï¼‰</h3>

<div class="small">
  âœ… è‡ªåŠ¨ä¿å­˜ï¼ˆåˆ·æ–°ä¸ä¸¢ï¼‰ï½œâœ… å·²é€æ‰“å‹¾ï½œğŸ” æœç´¢å¿«é€Ÿæ‰¾å•ï½œâœ… è‡ªåŠ¨æ‹†â€œè·¯çº¿å·+åœ°å€â€
</div>

<textarea id="input" placeholder="æ¯è¡Œä¸€å•ï¼ˆä½ æ€ä¹ˆç²˜éƒ½è¡Œï¼‰
ç¤ºä¾‹ï¼š
566, 583 Gardenia Dr, Monessen, PA
676 1128 Chestnut Ridge Dr, Pittsburgh, PA
677-1228 Chestnut Ridge Dr, Pittsburgh, PA"></textarea>

<div class="row" style="margin-top:10px">
  <button class="primary" onclick="build()">ç”Ÿæˆåˆ—è¡¨</button>
  <button class="ghost" onclick="clearAll()">æ¸…ç©ºä»Šå¤©å†…å®¹</button>
</div>

<div style="margin-top:10px">
  <input id="q" placeholder="æœç´¢ï¼šè¾“å…¥è·¯çº¿å· / è¡—é“ / åŸå¸‚ï¼ˆä¾‹å¦‚ 566 æˆ– Tunnelï¼‰" oninput="render()">
</div>

<div class="small stats" style="margin-top:10px">
  <span class="pill">æ€»æ•°ï¼š<b id="t">0</b></span>
  <span class="pill">å·²é€ï¼š<b id="d">0</b></span>
  <span class="pill">å‰©ä½™ï¼š<b id="r">0</b></span>
</div>

<div id="list"></div>

<script>
const LS_TEXT = "routeNav_text_v2";
const LS_DONE = "routeNav_done_v2";

let items = [];          // [{id, route, addr, raw}]
let doneSet = new Set(); // ids delivered

function makeId(raw){
  return raw;
}

/**
 * âœ… è‡ªåŠ¨æ‹†â€œè·¯çº¿å· + åœ°å€â€çš„æ ¸å¿ƒå‡½æ•°
 * æ”¯æŒï¼š
 * 1) "566, 583 Gardenia Dr, Monessen, PA"        (é€—å·æ ¼å¼)
 * 2) "676 1128 Chestnut Ridge Dr, Pittsburgh, PA" (ç©ºæ ¼æ ¼å¼ï¼šå‰å°æ•°å­—=è·¯çº¿å·ï¼Œåå¤§æ•°å­—=é—¨ç‰Œ)
 * 3) "677-1228 Chestnut Ridge Dr, Pittsburgh, PA" (677-1228)
 * 4) "677: 1228 Chestnut Ridge Dr, Pittsburgh, PA" (677: 1228)
 * 5) "1128 Chestnut Ridge Dr, Pittsburgh, PA"     (åªæœ‰åœ°å€)
 */
function normalizeLine(line){
  let raw = (line || "").trim();
  raw = raw.replace(/\s+/g, " "); // åˆå¹¶å¤šä½™ç©ºæ ¼

  let route = "";
  let addr = raw;

  // A) æœ‰é€—å·ï¼šä¼˜å…ˆæŒ‰ç¬¬ä¸€ä¸ªé€—å·æ‹†ï¼ˆæœ€ç¨³å®šï¼‰
  if(raw.includes(",")){
    const i = raw.indexOf(",");
    route = raw.slice(0,i).trim();
    addr  = raw.slice(i+1).trim();
    return {route, addr};
  }

  // B) "676 1128 Chestnut..."ï¼š2-4ä½è·¯çº¿å· + ç©ºæ ¼ + 3-6ä½é—¨ç‰Œå·...
  const m = raw.match(/^(\d{2,4})\s+(\d{3,6}\b.*)$/);
  if(m){
    route = m[1].trim();
    addr  = m[2].trim();
    return {route, addr};
  }

  // C) "676-1128 ..." æˆ– "676: 1128 ..." æˆ– "676#1128 ..."
  const m2 = raw.match(/^(\d{2,4})\s*[-:#]\s*(\d{3,6}\b.*)$/);
  if(m2){
    route = m2[1].trim();
    addr  = m2[2].trim();
    return {route, addr};
  }

  // D) åªæœ‰åœ°å€
  return {route, addr};
}

function saveText(){
  localStorage.setItem(LS_TEXT, document.getElementById("input").value || "");
}
function saveDone(){
  localStorage.setItem(LS_DONE, JSON.stringify(Array.from(doneSet)));
}
function loadState(){
  const t = localStorage.getItem(LS_TEXT);
  if(t !== null) document.getElementById("input").value = t;

  try{
    const arr = JSON.parse(localStorage.getItem(LS_DONE) || "[]");
    doneSet = new Set(arr);
  }catch(e){
    doneSet = new Set();
  }
}

function build(){
  const lines = (document.getElementById("input").value || "")
    .split(/\n+/).map(x=>x.trim()).filter(Boolean);

  // åŒä¸€è¡Œé‡å¤ä¹Ÿèƒ½å•ç‹¬æ ‡è®°å·²é€ï¼šåŠ  #2 #3
  const counter = new Map();
  items = lines.map(raw=>{
    const {route, addr} = normalizeLine(raw);
    const base = makeId(raw);
    const n = (counter.get(base) || 0) + 1;
    counter.set(base, n);
    const id = n === 1 ? base : (base + " #" + n);
    return {id, route, addr, raw};
  });

  // æ¸…ç† doneSet é‡Œä¸å­˜åœ¨çš„ idï¼ˆé¿å…å†å²æ±¡æŸ“ï¼‰
  const valid = new Set(items.map(x=>x.id));
  doneSet = new Set(Array.from(doneSet).filter(id=>valid.has(id)));
  saveDone();

  render();
}

function render(){
  const list = document.getElementById("list");
  list.innerHTML = "";

  const q = (document.getElementById("q").value || "").trim().toLowerCase();

  const filtered = items.filter(it=>{
    if(!q) return true;
    const hay = (it.route + " " + it.addr).toLowerCase();
    return hay.includes(q);
  });

  // stats
  const total = items.length;
  const delivered = Array.from(doneSet).length;
  document.getElementById("t").textContent = total;
  document.getElementById("d").textContent = delivered;
  document.getElementById("r").textContent = Math.max(0, total - delivered);

  for(const it of filtered){
    const isDone = doneSet.has(it.id);

    // âœ… åªæŠŠâ€œåœ°å€éƒ¨åˆ†â€é€å» Google Mapsï¼Œé¿å…è·¯çº¿å·å¹²æ‰°
    const url = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(it.addr);

    const card = document.createElement("div");
    card.className = "card" + (isDone ? " delivered" : "");
    card.innerHTML = `
      <div class="left">
        <div class="addr">
          ${it.route ? `<span class="route">#${escapeHtml(it.route)}</span>` : ""}
          ${escapeHtml(it.addr)}
        </div>
      </div>
      <div class="actions">
        <label title="å·²é€" style="display:flex;align-items:center;gap:6px;font-size:13px;color:#444">
          <input class="check" type="checkbox" ${isDone ? "checked" : ""} onchange="toggleDone('${escapeAttr(it.id)}', this.checked)">
          å·²é€
        </label>
        <button class="primary" onclick="location.href='${url}'">â–¶ å¯¼èˆª</button>
      </div>
    `;
    list.appendChild(card);
  }
}

function toggleDone(id, checked){
  if(checked) doneSet.add(id);
  else doneSet.delete(id);
  saveDone();
  render();
}

function clearAll(){
  if(!confirm("ç¡®å®šæ¸…ç©ºï¼Ÿè¿™ä¼šæ¸…æ‰è¾“å…¥å†…å®¹å’Œå·²é€æ ‡è®°ã€‚")) return;
  document.getElementById("input").value = "";
  document.getElementById("q").value = "";
  items = [];
  doneSet = new Set();
  localStorage.removeItem(LS_TEXT);
  localStorage.removeItem(LS_DONE);
  render();
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function escapeAttr(s){
  return (s||"").replace(/\\/g,"\\\\").replace(/'/g,"\\'");
}

// è‡ªåŠ¨ä¿å­˜è¾“å…¥æ¡†
document.getElementById("input").addEventListener("input", saveText);

// é¡µé¢åŠ è½½ï¼šæ¢å¤ä¸Šæ¬¡å†…å®¹ + å·²é€æ ‡è®°ï¼Œå¹¶è‡ªåŠ¨ç”Ÿæˆåˆ—è¡¨
loadState();
if((document.getElementById("input").value || "").trim()){
  build();
}else{
  render();
}
</script>

</body>
</html>
